<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ä½“å‹è°ƒæ•´å®éªŒ Â· COS ä¸Šä¼ ï¼ˆæ•´åœºä¸€æ¬¡ä¸Šä¼  + BMI + é˜²é—ªå±ï¼‰</title>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

<style>
  :root{
    /* ä¸»é¢˜ä¸è´¨æ„Ÿ */
    --bg-grad-1:#1a1a1a; --bg-grad-2:#22201c; --bg-grad-3:#26231f;
    --txt:#e9e7e4; --muted:#bfc4c9;
    --acc:#f2c14e; --acc-2:#ffd86b;

    /* æ¯›ç»ç’ƒ/å¡ç‰‡ */
    --panel-bg: rgba(30,30,30,.38);
    --panel-blur: 16px;
    --panel-saturate: 145%;
    --panel-radius: 16px;
    --panel-pad: 40px;
  }

  *{box-sizing:border-box}
  html,body{
    margin:0;height:100%;color:var(--txt);
    font-family:'Roboto',ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Microsoft YaHei",sans-serif;
    overflow:hidden
  }
  body{
    display:flex;align-items:center;justify-content:center;padding:36px;
    background:
      radial-gradient(1200px 700px at 20% 0%, rgba(255,207,92,.06), transparent 65%),
      radial-gradient(1000px 700px at 80% 100%, rgba(255,207,92,.05), transparent 60%),
      linear-gradient(180deg, var(--bg-grad-1), var(--bg-grad-2) 40%, var(--bg-grad-3));
  }
  .hide-cursor{cursor:none}

  /* å±å¹•å®¹å™¨ */
  .screen{position:absolute;inset:0;display:none;align-items:center;justify-content:center;padding:28px;text-align:center}
  .screen.active{display:flex}

  /* å…¨å±æ¯›ç»ç’ƒé¢æ¿ï¼ˆæ‰€æœ‰é¡µé¢ç»Ÿä¸€ä½¿ç”¨ï¼‰ */
  .panel{
    position: fixed; inset: 0;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    background: var(--panel-bg);
    backdrop-filter: blur(var(--panel-blur)) saturate(var(--panel-saturate));
    -webkit-backdrop-filter: blur(var(--panel-blur)) saturate(var(--panel-saturate));
    padding: var(--panel-pad);
    box-shadow: none; border: none; border-radius: 0;
  }

  /* ç»Ÿä¸€å­—å· */
  h1{ margin:10px 0; text-shadow:0 1px 1px rgba(0,0,0,.25); font-size:36px; }
  p{  margin:10px 0; text-shadow:0 1px 1px rgba(0,0,0,.25); font-size:28px; }
  .muted{color:var(--muted); font-size:18px}

  /* æŒ‰é’® */
  .btn{
    position:relative; overflow:hidden;
    background:linear-gradient(180deg, var(--acc-2), var(--acc));
    color:#2b1f08; border:0; border-radius:14px;
    padding:14px 32px; font-size:22px; cursor:pointer; margin:10px 8px; font-weight:700;
    box-shadow:0 8px 18px rgba(242,193,78,.15), inset 0 1px rgba(255,255,255,.35);
    transition:.18s transform ease, .18s filter ease, .18s box-shadow ease;
  }
  .btn[disabled]{opacity:.55;cursor:not-allowed}
  .btn:hover{filter:brightness(1.05); transform:translateY(-1px)}
  .btn:active{transform:translateY(0)}
  #btnStartPractice{ padding:16px 48px; }

  /* è¾“å…¥æ¡† */
  input{
    margin:8px; padding:12px 14px; font-size:18px;
    border:1.5px solid rgba(255,255,255,.16); border-radius:12px;
    background:rgba(255,255,255,.06); color:#fff; outline:none;
    transition:.2s border-color,.2s box-shadow,.2s background;
  }
  input::placeholder{ color:#d7d7d7; opacity:.75 }
  input:focus{
    border-color:var(--acc);
    box-shadow:0 0 0 3px rgba(242,193,78,.18);
    background:rgba(255,255,255,.08);
  }

  /* è¿›åº¦æ¡ */
  .bar{width:min(900px,78vw);height:12px;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border-radius:999px;overflow:hidden;margin-top:16px;border:1px solid rgba(255,255,255,.10);box-shadow:inset 0 2px 6px rgba(0,0,0,.45)}
  .bar>span{display:block;height:100%;width:0;background:linear-gradient(90deg,#ffe082,#ffc107 30%,#ffca28 70%,#ffd54f)}

  /* åˆºæ¿€ä¸æç¤º */
  #stimulus{max-width:80%;height:60vh;display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);will-change:opacity,transform}
  #fixation{display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:64px;color:var(--acc)}
  .hint{position:absolute;font-size:24px;color:#1e1b16;font-weight:700;background:linear-gradient(180deg,#ffe082,#ffd54f);border:0;border-radius:12px;padding:8px 12px;box-shadow:0 6px 20px rgba(0,0,0,.22)}
  .hint-left{left:8%;top:50%;transform:translateY(-50%);display:none}
  .hint-right{right:8%;top:50%;transform:translateY(-50%);display:none}
  #currentTypeLabel,#idealTypeLabel{font-size:26px;color:#ffe59a;opacity:0;transition:opacity .2s;position:absolute;top:82%;left:50%;transform:translateX(-50%)}
  #practicePrompt{position:absolute;top:82%;left:50%;transform:translateX(-50%);color:#ffe59a;display:none}

  /* ====== Notice é¡µé¢ï¼ˆæ’ç‰ˆä¼˜åŒ–ï¼‰ ====== */
  #notice .nz-card{
    width:min(980px,92vw);
    background:rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.14);
    border-radius:18px;
    box-shadow:0 18px 42px rgba(0,0,0,.35), inset 0 1px rgba(255,255,255,.2);
    padding:22px 22px 16px;
    position:relative;
  }
  #notice header.nz-head{display:flex;align-items:center;gap:12px;margin-bottom:6px}
  #notice .nz-badge{font-size:20px;background:linear-gradient(180deg,var(--acc-2),var(--acc)); color:#2b1f08; padding:5px 10px; border-radius:999px; font-weight:700}
  #notice h1.nz-title{margin:0;font-size:26px}
  #notice p.nz-lead{margin:.25rem 0 1rem;color:#f3f3f3;opacity:.9;font-size:16px;line-height:1.7;max-width:68ch}

  #notice .nz-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  #notice .nz-pane{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:16px 18px}
  #notice .nz-pane h2{margin:0 0 8px 0;font-size:20px}
  #notice .nz-pane p{margin:8px 0 0 0;line-height:1.8;font-size:16px;letter-spacing:.1px}
  #notice .nz-pane ul{margin:8px 0 0 0;padding-left:18px;line-height:1.8;font-size:16px}
  #notice .nz-pane li{margin:.35em 0;padding-left:.2em}
  #notice .nz-pane li::marker{color:#ffd86b}
  #notice .nz-muted{color:var(--muted);font-size:13px}

  /* åº•éƒ¨æ“ä½œåŒº */
  #notice .nz-actions{
    display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;
    background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.08);
    border-radius:14px; padding:12px 14px; margin-top:14px
  }

  /* è‡ªå®šä¹‰å‹¾é€‰æ¡†ï¼šé€æ˜å°æ–¹å— â†’ ç‚¹å‡»å‡ºç°é‡‘è‰²å¯¹å· */
  #notice .nz-ck{display:flex;align-items:center;gap:10px}
  #notice .nz-ck input{
    appearance:none; -webkit-appearance:none; -moz-appearance:none;
    width:26px;height:26px;border-radius:6px;
    border:2px solid rgba(255,255,255,.28);
    background:transparent; cursor:pointer; position:relative;
    transition:.18s border-color,.18s box-shadow;
  }
  /* é‡‘è‰²æè¾¹ä¸ç„¦ç‚¹æ€ */
  #notice .nz-ck input:focus-visible{outline:none;box-shadow:0 0 0 3px rgba(242,193,78,.25);border-color:var(--acc)}
  #notice .nz-ck input:hover{border-color:rgba(255,255,255,.45)}

  /* ç”¨ä¸¤æ¡è¾¹ç»˜åˆ¶â€œå¯¹å·â€ï¼Œæ›´ç¨³ï¼ˆä¸ç”¨å­—ä½“ï¼‰ */
  #notice .nz-ck input::after{
    content:""; position:absolute; left:50%; top:50%;
    width:8px; height:14px; /* å¯¹å·å°ºå¯¸ */
    border-right:3px solid var(--acc);
    border-bottom:3px solid var(--acc);
    transform:translate(-50%,-60%) rotate(45deg) scale(0);
    transform-origin:center; opacity:0;
    transition:transform .16s ease, opacity .16s ease;
    pointer-events:none;
  }
  #notice .nz-ck input:checked{border-color:var(--acc)}
  #notice .nz-ck input:checked::after{opacity:1; transform:translate(-50%,-60%) rotate(45deg) scale(1)}

  /* å…¨å±€ç²’å­ç”»å¸ƒï¼ˆåœ¨å“ªäº›é¡µé¢æ˜¾ç¤ºç”± JS å†³å®šï¼‰ */
  #fxCanvas{position:fixed; inset:0; z-index:-1; pointer-events:none}

  @media (max-width:900px){ #notice .nz-grid{grid-template-columns:1fr} }

  /* Notice æ–‡æ¡ˆå·¦å¯¹é½ï¼›å°æ ‡é¢˜å±…ä¸­ */
  #notice .panel,
  #notice .nz-card,
  #notice .nz-head,
  #notice .nz-lead,
  #notice .nz-pane,
  #notice .nz-pane p,
  #notice .nz-pane ul,
  #notice .nz-pane li { text-align:left; }
  #notice .nz-pane h2 { text-align:center; }
  #notice .nz-pane p, #notice .nz-lead { word-break:break-word; white-space:normal; }
</style>
</head>
<body>

<!-- âœ… å…¨å±€ç²’å­ç”»å¸ƒï¼šé»˜è®¤åœ¨ notice / guidelines / thankYou æ˜¾ç¤º -->
<canvas id="fxCanvas" aria-hidden="true"></canvas>

<!-- Noticeï¼ˆæ³¨æ„äº‹é¡¹ï¼‰ -->
<section id="notice" class="screen active">
  <div class="panel" role="region" aria-label="å®éªŒæ³¨æ„äº‹é¡¹">
    <article class="nz-card">
      <header class="nz-head">
        <span class="nz-badge">NOTICE</span>
        <h1 class="nz-title">æ¬¢è¿å‚åŠ ä½“å‹è°ƒæ•´å®éªŒ</h1>
      </header>

      <p class="nz-lead"></p>

      <section class="nz-grid">
        <!-- å·¦ï¼šæ³¨æ„äº‹é¡¹ -->
        <div class="nz-pane">
          <h2>æ³¨æ„äº‹é¡¹</h2>
          <ul>
            <li>ä¸ºä¿è¯æ‚¨æµç•…çš„å®éªŒä½“éªŒï¼Œå»ºè®®æ‚¨åœ¨è‰¯å¥½çš„ç½‘ç»œç¯å¢ƒä¸‹è¿›è¡Œï¼Œå…³é—­æ¶ˆæ¯æé†’ä¸å¼¹çª—ï¼Œé¿å…åˆ†å¿ƒã€‚</li>
            <li>ä¸ºä¿è¯æ‚¨å®éªŒæŠ¥é…¬çš„é¡ºåˆ©å‘æ”¾ï¼Œè¯·å¦‚å®å¡«å†™ä¿¡æ¯ï¼ˆå­¦å·ä¸æ‰‹æœºå·å 4 ä½ä»…ç”¨äºæŠ¥é…¬å‘æ”¾å¯¹è´¦ï¼‰ã€‚</li>
            <li>ä¸ºä¿è¯æ•°æ®è´¨é‡ä¸æ‚¨çš„ä½“éªŒï¼Œè¯·åœ¨å®‰é™ã€å…‰çº¿é€‚å®œçš„ç¯å¢ƒä¸­å®Œæˆï¼Œå¹¶å°½é‡ä½¿ç”¨ç”µè„‘å…¨å±æ¨¡å¼ã€‚</li>
            <li>å®éªŒä¸­å¦‚å‡ºç°ä¸é€‚æˆ–éœ€æš‚åœæ—¶ï¼Œå¯éšæ—¶é€€å‡ºå¹¶è”ç³»ä¸»è¯•ï¼›æ‚¨æ‹¥æœ‰éšæ—¶é€€å‡ºçš„æƒåˆ©ï¼Œå¹¶ä¸¥æ ¼éµå®ˆä¸‹è¿°ä¿å¯†åŸåˆ™ã€‚</li>
            <li>è‹¥æ‚¨å¯¹å®éªŒè¿‡ç¨‹ä¸­æœ‰ä»»ä½•ç–‘é—®ï¼Œå‡å¯åœ¨å®éªŒç»“æŸåæ·»åŠ ä¸»è¯•å¾®ä¿¡å’¨è¯¢ã€‚</li>
          </ul>
        </div>

        <!-- å³ï¼šä¿å¯†åŸåˆ™ -->
        <div class="nz-pane">
          <h2>ä¿å¯†åŸåˆ™</h2>
          <ul>
            <li><b>åŒ¿åå¤„ç†ï¼š</b>å®éªŒè®°å½•ä»¥ç¼–ç å½¢å¼ä¿å­˜ï¼Œä¸åŒ…å«å¯ç›´æ¥è¯†åˆ«èº«ä»½çš„ä¿¡æ¯ï¼›å…¬å¼€æŠ¥å‘Šä»…å‘ˆç°æ±‡æ€»ç»Ÿè®¡ã€‚</li>
            <li><b>é™ç”¨é€”ï¼š</b>æ•°æ®ä»…ç”¨äºæœ¬è¯¾é¢˜çš„ç§‘å­¦ç ”ç©¶ä¸å­¦æœ¯å‘è¡¨ï¼Œä¸ä½œå•†ä¸šç”¨é€”ã€‚</li>
            <li><b>å®‰å…¨å­˜å‚¨ï¼š</b>æ•°æ®å­˜æ”¾äºå—æ§ç ”ç©¶è´¦å·äº‘ç«¯ï¼Œè®¿é—®å—æƒé™ä¿æŠ¤ï¼›ä¼ è¾“é‡‡ç”¨åŠ å¯†é€šé“ã€‚</li>
            <li><b>è‡ªæ„¿å‚ä¸ï¼š</b>å¯åœ¨ä»»ä½•é˜¶æ®µæ’¤å›ï¼›æ’¤å›åå¯è¯·æ±‚åˆ é™¤æœªåˆ†æçš„æ•°æ®ã€‚</li>
            <li><b>ä¸å¤–ä¼ ï¼š</b>ä¸ºé¿å…å¹²æ‰°ä»–äººå‚ä¸ï¼Œè¯·å‹¿åœ¨ç ”ç©¶å®Œæˆå‰å…¬å¼€è®¨è®ºé¢˜ç›®æˆ–ä¼ æ’­é¡µé¢å†…å®¹ã€‚</li>
          </ul>
        </div>
      </section>

      <div class="nz-actions">
        <div class="nz-ck">
          <input id="agree" type="checkbox" aria-label="æˆ‘å·²é˜…è¯»å¹¶åŒæ„æ³¨æ„äº‹é¡¹ä¸ä¿å¯†æ¡æ¬¾">
          <label for="agree">æˆ‘å·²é˜…è¯»å¹¶åŒæ„æ³¨æ„äº‹é¡¹ä¸ä¿å¯†æ¡æ¬¾</label>
        </div>

        <!-- æ³¨æ„ï¼šæ­¤è¿›åº¦æ¡åœ¨ç‚¹å‡»æŒ‰é’®åæ‰ä¼šä» 0 â†’ 100% -->
        <div class="bar" aria-hidden="true" style="width:240px;height:15px">
          <span id="noticePg" style="width:0%"></span>
        </div>

        <button id="btnNoticeNext" class="btn" disabled>æˆ‘å·²é˜…è¯»ï¼Œè¿›å…¥å®éªŒ</button>
      </div>
    </article>
  </div>
</section>

<!-- æŒ‡å¯¼è¯­ï¼ˆé¦–é¡µï¼‰ -->
<section id="guidelines" class="screen">
  <div class="panel">
    <h1>æ¬¢è¿æ‚¨å‚åŠ æœ¬å®éªŒï¼</h1>
    <p>å®éªŒä¸­ï¼Œæ‚¨å°†é€šè¿‡"F"é”®ä¸"J"é”®æ¥å¯¹å‘ˆç°çš„ä½“å‹èƒ–ç˜¦è¿›è¡Œè°ƒæ•´ï¼Œç›´åˆ°ç¬¦åˆç›¸åº”ä½“å‹ã€‚</p>
    <p>æ‚¨å¯ä»¥é€šè¿‡é•¿æŒ‰æˆ–ç‚¹å‡»"F"é”®ä¸"J"é”®æ¥è¿›è¡Œå¿«é€Ÿæˆ–ç²¾ç»†çš„è°ƒæ•´ï¼Œ</p>
    <p>è°ƒæ•´å®Œæˆåï¼ŒæŒ‰â€œå›è½¦é”®ï¼ˆEnterï¼‰â€ç¡®è®¤é€‰æ‹©ã€‚</p>
    <p style="margin-top:6px">è¯·é€‰æ‹©æ‚¨çš„æ€§åˆ«</p>
    <div>
      <input id="studentId" placeholder="è¯·è¾“å…¥å­¦å·" />
      <input id="subjectNumber" placeholder="è¯·è¾“æ‰‹æœºå·ç å4ä½" />
    </div>
    <div>
      <button id="maleButton" class="btn">ç”·æ€§</button>
      <button id="femaleButton" class="btn">å¥³æ€§</button>
    </div>
    <div class="bar" style="margin-top:10px"><span id="preloadPg"></span></div>
    <p id="preloadTip" class="muted">ç­‰å¾…é€‰æ‹©æ€§åˆ«å¼€å§‹é¢„åŠ è½½â€¦</p>
    <button id="btnStartPractice" class="btn" disabled>è¿›å…¥ç»ƒä¹ </button>
    <p class="muted">è¯·æ‚¨è€å¿ƒç­‰å¾…å®éªŒåŠ è½½ï¼Œè‹¥é•¿æ—¶é—´æœªåŠ è½½å®Œæˆï¼Œå¯ç‚¹å‡»æ€§åˆ«è¿›è¡Œåˆ·æ–°æˆ–é‡æ–°è¿›å…¥å®éªŒï¼</p>
    <p class="muted">æ³¨ï¼šè¯·å‡†ç¡®å¡«å†™å­¦å·ä¸æ‰‹æœºå·å4ä½ï¼Œè¿™å°†ä½œä¸ºå®éªŒç¼–ç ï¼Œä»¥ä¾¿å‘æ”¾æŠ¥é…¬ã€‚</p>
  </div>
</section>

<!-- ç»ƒä¹ /æ­£å¼æŒ‡å¯¼è¯­ -->
<section id="practiceGuidelines" class="screen">
  <div class="panel">
    <p>ç»ƒä¹ é˜¶æ®µï¼ˆå…± 3 æ¬¡ï¼‰ï¼</p>
    <p>æ‚¨å¯ä»¥é€šè¿‡â€˜é•¿æŒ‰â€™ â€œFâ€ ä¸ â€œJâ€ é”®ï¼Œæ¥è¿›è¡Œä½“å‹çš„ â€˜å¿«é€Ÿâ€™ è°ƒæ•´ï¼Œ</p>
    <p>æˆ–é€šè¿‡â€˜ç‚¹å‡»â€™ â€œFâ€ ä¸ â€œJâ€ é”®æ¥å¯¹ä½“å‹è¿›è¡Œâ€˜ç²¾ç»†â€™ è°ƒæ•´ã€‚</p>
    <p>è‹¥æ‚¨å·²ç»äº†è§£å…·ä½“æ“ä½œï¼ŒæŒ‰ <b>ç©ºæ ¼é”®</b> å¼€å§‹ç»ƒä¹ ï¼</p>
  </div>
</section>

<section id="currentGuidelines" class="screen">
  <div class="panel">
    <p>æ­£å¼å®éªŒå¼€å§‹ï¼</p>
    <p>â€œå½“å‰ä½“å‹â€è°ƒæ•´ä»»åŠ¡ï¼ˆå…±10 æ¬¡ï¼‰ï¼</p>
    <p>ç°åœ¨ï¼Œæ‚¨å°†é€šè¿‡"F"é”®ä¸"J"é”®æ¥è°ƒæ•´å‡ºæœ€æ¥è¿‘æ‚¨å½“å‰çš„ä½“å‹ã€‚</p>
    <p>æŒ‰â€œå›è½¦é”®ï¼ˆEnterï¼‰â€ç¡®è®¤ä¿å­˜è°ƒæ•´ç»“æœï¼ŒæŒ‰â€œç©ºæ ¼é”®â€æ­£å¼å¼€å§‹å®éªŒã€‚</p>
  </div>
</section>

<section id="idealGuidelines" class="screen">
  <div class="panel">
    <p>â€œç†æƒ³ä½“å‹â€è°ƒæ•´ä»»åŠ¡ï¼ˆå…±10 æ¬¡ï¼‰ï¼</p>
    <p>ç°åœ¨ï¼Œæ‚¨å°†é€šè¿‡"F"é”®ä¸"J"é”®æ¥è°ƒæ•´æ‚¨çš„ç†æƒ³ä½“å‹ã€‚</p>
    <p>æŒ‰â€œå›è½¦é”®ï¼ˆEnterï¼‰â€ç¡®è®¤ä¿å­˜è°ƒæ•´ç»“æœï¼ŒæŒ‰â€œç©ºæ ¼é”®â€å¼€å§‹å®éªŒã€‚</p>
  </div>
</section>

<!-- åˆºæ¿€å±‚ -->
<img id="stimulus" alt="stimulus" decoding="async" loading="eager" fetchpriority="high">
<div id="fixation">+</div>
<div class="hint hint-left">é•¿æŒ‰â€œFâ€å¿«é€Ÿå˜ç˜¦</div>
<div class="hint hint-right">é•¿æŒ‰â€œJâ€å¿«é€Ÿå˜èƒ–</div>
<div id="currentTypeLabel"><p>è°ƒè‡³ä¸æ‚¨<b>å½“å‰æœ€ç›¸è¿‘</b>çš„ä½“å‹ï¼ŒæŒ‰ <b>Enter</b> ç¡®è®¤ã€‚</p></div>
<div id="idealTypeLabel"><p>è°ƒè‡³æ‚¨çš„<b>ç†æƒ³ä½“å‹</b>ï¼ŒæŒ‰ <b>Enter</b> ç¡®è®¤ã€‚</p></div>
<div id="practicePrompt" class="muted">ç†Ÿæ‚‰åå¯æŒ‰ <b>Enter</b> ç»“æŸæœ¬æ¬¡ç»ƒä¹ </div>

<!-- ç»“æŸé¡µä¸é®ç½© -->
<section id="thankYou" class="screen">
  <div class="panel">
    <p>è¯·æ‚¨å¤‡æ³¨å¥½å­¦å·ä¸æ‰‹æœºå·ç å4ä½åï¼Œæ·»åŠ å®éªŒä¸»è¯•å¾®ä¿¡é¢†å–å®éªŒæŠ¥é…¬ï¼ï¼ï¼</p>
    <p>æŒ‰ä¸‹â€œESCâ€åï¼Œå…³é—­å½“å‰é¡µé¢å³å¯ã€‚</p>
    <h1>å®éªŒç»“æŸï¼Œæ„Ÿè°¢å‚ä¸ï¼</h1>
  </div>
</section>

<div id="overlayUploading" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);color:#fff;z-index:9999;align-items:center;justify-content:center;flex-direction:column;">
  <div style="font-size:20px;margin-bottom:10px">æ­£åœ¨ä¸Šä¼ æ•°æ®ï¼Œè¯·ç¨å€™â€¦</div>
  <div class="bar" style="width:300px"><span style="width:100%"></span></div>
</div>

<div id="overlayFailed" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);color:#fff;z-index:9999;align-items:center;justify-content:center;flex-direction:column;">
  <div style="font-size:20px;margin-bottom:12px">ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•</div>
  <button id="btnRetryUpload" class="btn">é‡è¯•ä¸Šä¼ </button>
</div>

<!-- COS SDK -->
<script src="https://cdn.jsdelivr.net/npm/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js"></script>

<script>
/* ===== å¸¸é‡ ===== */
const STS_URL    = 'https://bodyshape2025-8gk5msghc2121838-1373390636.ap-shanghai.app.tcloudbase.com/cos-sts-event';
const COS_BUCKET = 'bodyshape-data-1373390636';
const COS_REGION = 'ap-shanghai';

/* ===== é—®å·è·³è½¬è®¾ç½®ï¼ˆæ–°å¢ï¼‰ =====
 * å°† SURVEY_URL æ”¹ä¸ºä½ çš„é—®å·åœ°å€æˆ–æœ¬åœ°æ–‡ä»¶åï¼Œä¾‹å¦‚ï¼š
 * 'å®éªŒäºŒï¼ˆå‰ä¾§é—®å·ï¼‰.html'
 * å°†é€šè¿‡ URL å‚æ•°ä¼ é€’ï¼š
 * studentId, phone4, gender, series, sessionId, startedAt, endedAt
 */
const SURVEY_URL = 'å®éªŒäºŒï¼ˆå‰ä¾§é—®å·ï¼‰.html';

/* ===== å›¾ç‰‡èµ„æºè·¯å¾„ ===== */
const IS_PROD   = location.hostname.endsWith('github.io');
const SITE_BASE = IS_PROD ? 'https://BodyImageLab.github.io/body-shape-experiment_xiaowu/' : './';
const BASE_URL_F = SITE_BASE + 'img_F/';
const BASE_URL_M = SITE_BASE + 'img_M/';

const MAX_F = 76, MAX_M = 76;
const F_EXT = 'png', M_EXT = 'png';
let F_LIST = [], M_LIST = [];

// è¯•æ¬¡æ•°/æ—¶åº/é¢‘ç‡
const PRACTICE_TRIALS = 3;
const CURRENT_TRIALS  = 10;
const IDEAL_TRIALS    = 10;
const FIX_MS = 800;
const HOLD_INTERVAL = 70;

/* ===== DOM/çŠ¶æ€ ===== */
const screens = {
  notice: document.getElementById('notice'),
  guide: document.getElementById('guidelines'),
  pracG: document.getElementById('practiceGuidelines'),
  currG: document.getElementById('currentGuidelines'),
  idealG: document.getElementById('idealGuidelines'),
  thank: document.getElementById('thankYou')
};
const preloadPg = document.getElementById('preloadPg');
const preloadTip = document.getElementById('preloadTip');
const btnStartPractice = document.getElementById('btnStartPractice');
const maleBtn = document.getElementById('maleButton');
const femaleBtn = document.getElementById('femaleButton');
const btnNoticeNext = document.getElementById('btnNoticeNext');

const stimulus = document.getElementById('stimulus');
const fixation = document.getElementById('fixation');
const hintL = document.querySelector('.hint-left');
const hintR = document.querySelector('.hint-right');
const labelCurrent = document.getElementById('currentTypeLabel');
const labelIdeal = document.getElementById('idealTypeLabel');
const practicePrompt = document.getElementById('practicePrompt');

const studentIdEl = document.getElementById('studentId');
const subjectNumberEl = document.getElementById('subjectNumber');

let gender = null, series = 'F', imgList = [];
let idx = 0, holdTimer = null, holdKey = null, adjusting = false, preloaded = false;
let practiceTrial = 0, currentTrial = 0, idealTrial = 0;
let currentStarts = [], idealStarts = [];
let t0 = 0, startIdx = 0, enterLocked = false, experimentStartTime = 0;
let taskType = 'ç»ƒä¹ ';
let results = [];
let sessionId = null;
let pendingIndex = null;

/* ===== Noticeï¼šåŒæ„åæŒ‰é’®å¯ç”¨ï¼›æŒ‰æŒ‰é’®å…ˆè·‘è¿›åº¦æ¡å†è¿›å…¥ä¸‹ä¸€é¡µ ===== */
const agree = document.getElementById('agree');
const noticePg = document.getElementById('noticePg');

if (agree && btnNoticeNext){
  btnNoticeNext.disabled = !agree.checked;
  agree.addEventListener('change', ()=> btnNoticeNext.disabled = !agree.checked);

  btnNoticeNext.addEventListener('click', async ()=>{
    if(btnNoticeNext.disabled) return;

    // ç¦ç”¨æŒ‰é’®ï¼Œè·‘è¿›åº¦åŠ¨ç”»
    btnNoticeNext.disabled = true;
    await runNoticeProgress();

    // âœ… è¿›å…¥å®éªŒå‰å…ˆè¯·æ±‚å…¨å±ï¼ˆæœ‰ç”¨æˆ·ç‚¹å‡»æ‰‹åŠ¿ï¼Œæœ€å¯é ï¼‰
  enterFullscreen();

    // è¿›åº¦å®Œæ¯•åè¿›å…¥ä¸‹ä¸€é¡µï¼ˆFX ä¼šéš showScreen è‡ªåŠ¨åˆ‡æ¢ï¼‰
    showScreen('guide');
  });
}

/* è¿›åº¦æ¡åŠ¨ç”»ï¼šç‚¹å‡»æŒ‰é’®åä» 0 â†’ 100% */
function runNoticeProgress(){
  return new Promise(resolve=>{
    let w = 0;
    noticePg.style.width = '0%';
    const timer = setInterval(()=>{
      w += 12 + Math.random()*18; // é€Ÿåº¦å¯æŒ‰éœ€è°ƒæ•´
      if (w >= 100){
        w = 100;
        clearInterval(timer);
        resolve();
      }
      noticePg.style.width = w.toFixed(0) + '%';
    }, 120);
  });
}

/* ===== é€šç”¨ç²’å­ & æ¶Ÿæ¼ªï¼ˆå¯æŒ‰éœ€é€‰æ‹©åœ¨å“ªäº›é¡µé¢å¯ç”¨ï¼‰ ===== */

/** ğŸ‘‡ åœ¨è¿™é‡Œæ§åˆ¶ç²’å­èƒŒæ™¯åœ¨å“ªäº›â€œé¡µé¢é”®â€å¯ç”¨ã€‚
 *  é¡µé¢é”®æ˜¯ showScreen(key) é‡Œç”¨çš„ keyï¼š
 *  notice / guide / pracG / currG / idealG / thank
 *  æƒ³å…³é—­æŸé¡µï¼Œå°±æŠŠç›¸åº” key ä»é›†åˆé‡Œåˆ æ‰å³å¯ã€‚
 */
const FX_PAGES = new Set(['notice','guide','thank']);

let bgFX = null;
function mountFX(){
  if (bgFX) return;
  const cvs = document.getElementById('fxCanvas');
  const ctx = cvs.getContext('2d');
  const DPR = Math.min(2, window.devicePixelRatio || 1);
  const reduce = matchMedia('(prefers-reduced-motion: reduce)').matches;
  let W=0,H=0,t=0, mx=0,my=0, rafId=null, bubbles=[];

  function resize(){
    W = cvs.width  = innerWidth  * DPR;
    H = cvs.height = innerHeight * DPR;
    cvs.style.width  = innerWidth + 'px';
    cvs.style.height = innerHeight + 'px';
    init();
  }
  function init(){
    const n = reduce ? 40 : 90;
    bubbles.length = 0;
    for(let i=0;i<n;i++){
      const z = Math.random();
      const r = (6 + 20*z) * DPR;
      const x = Math.random()*W;
      const y = Math.random()*H;
      const vy = (-.2 - 1.2*z) * DPR;
      const hue = 40 + 15*z;
      bubbles.push({x,y,r,vy,z,hue,tw:Math.random()*Math.PI*2});
    }
  }
  function draw(){
    t += 0.005;
    ctx.clearRect(0,0,W,H);
    const grad = ctx.createLinearGradient(0,0,W,H);
    grad.addColorStop(0,'rgba(0,0,0,.08)');
    grad.addColorStop(1,'rgba(0,0,0,.20)');
    ctx.fillStyle = grad; ctx.fillRect(0,0,W,H);

    for(const b of bubbles){
      const ox = (mx*0.06)*(1-b.z)*DPR;
      const oy = (my*0.04)*(1-b.z)*DPR;
      b.y += b.vy*(.7 + .3*Math.sin(b.tw + t*2));
      if (b.y + b.r < 0) { b.y = H + b.r; b.x = Math.random()*W; }
      ctx.save(); ctx.globalCompositeOperation = 'lighter';
      const g = ctx.createRadialGradient(b.x+ox, b.y+oy, b.r*0.1, b.x+ox, b.y+oy, b.r);
      g.addColorStop(0, `hsla(${b.hue},85%,70%,.45)`);
      g.addColorStop(.6, `hsla(${b.hue+10},85%,65%,.12)`);
      g.addColorStop(1, 'rgba(0,0,0,0)');
      ctx.fillStyle = g; ctx.beginPath(); ctx.arc(b.x+ox, b.y+oy, b.r, 0, Math.PI*2); ctx.fill();
      ctx.globalCompositeOperation = 'screen';
      ctx.fillStyle = `hsla(${b.hue+20},100%,85%,.35)`;
      ctx.beginPath(); ctx.arc(b.x+ox - b.r*0.3, b.y+oy - b.r*0.3, b.r*0.25, 0, Math.PI*2); ctx.fill();
      ctx.restore();
    }
    rafId = requestAnimationFrame(draw);
  }
  const onResize = ()=>resize();
  const onMove   = (e)=>{ mx = (e.clientX / innerWidth  - .5) * 2; my = (e.clientY / innerHeight - .5) * 2; };

  // æ°´æ³¢æ¶Ÿæ¼ªï¼šåªåœ¨å¯ç”¨ FX çš„é¡µé¢å†…çš„æŒ‰é’®ä¸Š
  const onClick = (e)=>{
    // ç”¨ section id é€‰æ‹©ï¼ˆæ³¨æ„ï¼šè¿™é‡Œç”¨çš„æ˜¯ DOM idï¼Œä¸æ˜¯ keyï¼‰
    const btn = e.target.closest('#notice .btn, #guidelines .btn, #thankYou .btn');
    if(!btn) return;
    const rip = document.createElement('span');
    rip.style.position='absolute';
    rip.style.borderRadius='50%';
    rip.style.transform='translate(-50%,-50%) scale(0)';
    rip.style.background='rgba(255,255,255,.55)';
    rip.style.pointerEvents='none';
    rip.style.left = (e.clientX - btn.getBoundingClientRect().left) + 'px';
    rip.style.top  = (e.clientY - btn.getBoundingClientRect().top)  + 'px';
    const size = Math.max(btn.offsetWidth, btn.offsetHeight);
    rip.style.width = rip.style.height = size + 'px';
    rip.style.transition='transform .6s ease-out, opacity .6s ease-out';
    btn.appendChild(rip);
    requestAnimationFrame(()=>{ rip.style.transform='translate(-50%,-50%) scale(18)'; rip.style.opacity='0'; });
    rip.addEventListener('transitionend', ()=> rip.remove());
  };

  window.addEventListener('resize', onResize);
  window.addEventListener('mousemove', onMove, {passive:true});
  document.addEventListener('click', onClick);

  resize(); if(!reduce){ draw(); }

  bgFX = {
    destroy(){
      if (rafId) cancelAnimationFrame(rafId);
      window.removeEventListener('resize', onResize);
      window.removeEventListener('mousemove', onMove, {passive:true});
      document.removeEventListener('click', onClick);
      const c = document.getElementById('fxCanvas');
      if (c){ const ctx2=c.getContext('2d'); ctx2 && ctx2.clearRect(0,0,c.width,c.height); }
      bgFX = null;
    }
  };
}
function unmountFX(){ if (bgFX) bgFX.destroy(); }

/* æ ¹æ®å½“å‰å±çš„ key å†³å®šæ˜¯å¦å¯ç”¨ç²’å­ */
function maybeToggleFXFor(screenKey){
  if (FX_PAGES.has(screenKey)) mountFX(); else unmountFX();
}

/* ===== å·¥å…·å‡½æ•° ===== */
function enterFullscreen(){ const el=document.documentElement; if (el.requestFullscreen) el.requestFullscreen().catch(()=>{}); }

/* åˆ‡å±ï¼šç»Ÿä¸€åœ¨è¿™é‡Œæ§åˆ¶ FX çš„å¼€å…³ */
function showScreen(key){
  Object.values(screens).forEach(s=>s.classList.remove('active'));
  screens[key].classList.add('active');
  maybeToggleFXFor(key);
}

/* åˆå§‹åŒ–ï¼šæ ¹æ®é»˜è®¤ active çš„å±å†³å®šæ˜¯å¦å¼€å¯ FX */
{
  const activeKey = Object.entries(screens).find(([k,el])=>el.classList.contains('active'))?.[0] || 'notice';
  maybeToggleFXFor(activeKey);
}

/* ===== é¢„åŠ è½½ ===== */
function genNames(prefix, n, ext){ const a=[]; for (let i=1;i<=n;i++) a.push(`${prefix}${i}.${ext}`); return a; }
function clamp(v,lo,hi){ return Math.min(hi, Math.max(lo,v)); }
function getSeriesURLs(which){
  if (which === 'M'){ const names = M_LIST.length ? M_LIST : genNames('M', MAX_M, M_EXT); return names.map(n => BASE_URL_M + n); }
  else { const names = F_LIST.length ? F_LIST : genNames('F', MAX_F, F_EXT); return names.map(n => BASE_URL_F + n); }
}
async function preloadAll(urls){
  if (!urls.length) return;
  let done = 0, total = urls.length;
  const upd = ()=>{ preloadPg.style.width = ((done/total)*100).toFixed(1) + '%'; };
  for (const u of urls) {
    const im = new Image(); im.loading='eager'; im.decoding='async'; im.src=u;
    try { await im.decode(); } catch(e) {}
    done++; upd();
  }
}

/* ===== BMI æ˜ å°„ ===== */
function bmiFromIndex(series, index){
  if (series === 'F'){ return +(10.8 + index * 0.432).toFixed(2); }
  else { return +(11.8 + index * 0.472).toFixed(2); }
}

/* ===== å‘ˆç°/ç´¢å¼• ===== */
function updateStimulus(){
  idx = clamp(idx, 0, imgList.length-1);
  stimulus.src = imgList[idx];
  stimulus.style.display = 'block';
  if (taskType === 'ç»ƒä¹ '){
    hintL.style.display='block'; hintR.style.display='block';
    practicePrompt.style.display=(practiceTrial < PRACTICE_TRIALS)?'block':'none';
    labelCurrent.style.opacity=0; labelIdeal.style.opacity=0;
  } else {
    hintL.style.display='none'; hintR.style.display='none';
    practicePrompt.style.display='none';
    labelCurrent.style.opacity=(taskType==='å½“å‰ä½“å‹')?1:0;
    labelIdeal.style.opacity=(taskType==='ç†æƒ³ä½“å‹')?1:0;
  }
}
function showFix(){ stimulus.style.display='none'; labelCurrent.style.opacity=0; labelIdeal.style.opacity=0; hintL.style.display='none'; hintR.style.display='none'; practicePrompt.style.display='none'; fixation.style.display='block'; }
function hideFix(){ fixation.style.display='none'; }

/* ===== è®°å½• ===== */
function saveRow(){
  results.push({
    task_type: taskType,
    series,
    selected_image: imgList[idx] || '',
    index: idx,
    bmi: bmiFromIndex(series, idx),
    start_index: startIdx,
    response_time: new Date().toISOString(),
    response_duration_ms: Date.now() - t0,
    student_id: (studentIdEl.value||'').trim(),
    subject_number: (subjectNumberEl.value||'').trim(),
    gender
  });
}

/* ===== é•¿æŒ‰å¿«é€Ÿæ­¥è¿› ===== */
function startHold(which){ stopHold(); const delta=(which==='f')?-1:+1; step(delta); holdKey=which; holdTimer=setInterval(()=>step(delta),HOLD_INTERVAL); }
function stopHold(){ if (holdTimer){ clearInterval(holdTimer); holdTimer=null; } holdKey=null; }
function step(delta){ if (!adjusting) return; idx = clamp(idx + delta, 0, imgList.length-1); pendingIndex = idx; }

/* ===== æ¸²æŸ“å¾ªç¯ï¼ˆåˆ‡å›¾æ›´é¡ºæ»‘ï¼‰ ===== */
function renderLoop(){ if (pendingIndex !== null){ stimulus.src = imgList[pendingIndex]; pendingIndex = null; } requestAnimationFrame(renderLoop); }
renderLoop();

/* ===== è¦†ç›–å±‚æ§åˆ¶ ===== */
function showUploadingOverlay(){ document.getElementById('overlayUploading').style.display='flex'; }
function hideUploadingOverlay(){ document.getElementById('overlayUploading').style.display='none'; }
function showUploadFailedOverlay(msg){
  const el = document.getElementById('overlayFailed'); el.style.display='flex';
  document.getElementById('btnRetryUpload').onclick = async ()=>{
    el.style.display='none'; showUploadingOverlay();
    try{ await uploadAllResults(); hideUploadingOverlay(); goToSurvey(); }  // â˜… ä¿®æ”¹ï¼šé‡è¯•æˆåŠŸåä¹Ÿè¿›å…¥é—®å·
    catch(e){ hideUploadingOverlay(); showUploadFailedOverlay(String(e)); }
  };
}

/* ===== æ•´åœº payload / ä¸Šä¼  ===== */
function buildPayload(){
  return { sessionId, pid: (studentIdEl.value||'').trim(), subjectNumber: (subjectNumberEl.value||'').trim(), gender, rows: results };
}
async function uploadAllResults(){
  const payload = buildPayload();
  const sts = await fetch(STS_URL).then(r=>r.json());
  if (!sts.ok) throw new Error(sts.error || 'Get STS failed');
  const cos = new COS({ getAuthorization: (options, cb) => cb({
      TmpSecretId:  sts.credentials.TmpSecretId,
      TmpSecretKey: sts.credentials.TmpSecretKey,
      SecurityToken: sts.credentials.Token,
      StartTime: Math.floor(Date.now()/1000) - 1,
      ExpiredTime: Math.floor(Date.now()/1000) + 600
    }) });
  const dateDir = new Date().toISOString().slice(0,10);
  const key = `sessions/${dateDir}/${payload.sessionId}.json`;
  await new Promise((resolve,reject)=>{
    cos.putObject({ Bucket: COS_BUCKET, Region: COS_REGION, Key: key,
      Body: new Blob([JSON.stringify(payload)], { type:'application/json' })
    }, (err,data)=>err?reject(err):resolve(data));
  });
  try {
  sessionStorage.setItem('exp_payload', JSON.stringify(payload));
  sessionStorage.setItem('exp_uploaded_key', key);
} catch(_) {}

  console.log('Uploaded to COS:', key);
  return key;
}

/* ===== é—®å·è·³è½¬å‡½æ•°ï¼ˆæ–°å¢ï¼‰ ===== */
function goToSurvey(){
  const base = (SURVEY_URL || '').trim();
  if (!base){ showScreen('thank'); return; } // å…œåº•ï¼šæœªé…ç½®é—®å·é“¾æ¥åˆ™ä¿ç•™åŸæ„Ÿè°¢é¡µ

  const params = new URLSearchParams({
    studentId: (studentIdEl.value || '').trim(),
    phone4: (subjectNumberEl.value || '').trim(),
    gender: gender || '',
    series,
    sessionId: sessionId || '',
    startedAt: new Date(experimentStartTime || Date.now()).toISOString(),
    endedAt: new Date().toISOString()
  });
  const expKey = sessionStorage.getItem('exp_uploaded_key') || '';
params.set('expKey', expKey);


  const url = base + (base.includes('?') ? '&' : '?') + params.toString();
  const go = ()=> location.replace(encodeURI(url)); // å¤„ç†ä¸­æ–‡æ–‡ä»¶å

  if (document.fullscreenElement && document.exitFullscreen){
    document.exitFullscreen().catch(()=>{}).finally(go);
  }else{
    go();
  }
}

/* ===== æµç¨‹æ§åˆ¶ ===== */
function startPracticeBlock(){ taskType='ç»ƒä¹ '; practiceTrial=0; showScreen('pracG'); }
function startCurrentBlock(){
  taskType='å½“å‰ä½“å‹'; currentTrial=0;
  currentStarts = Array(5).fill(0).concat(Array(5).fill(imgList.length-1)).sort(()=>Math.random()-0.5);
  showScreen('currG');
}
function startIdealBlock(){
  taskType='ç†æƒ³ä½“å‹'; idealTrial=0;
  idealStarts = Array(5).fill(0).concat(Array(5).fill(imgList.length-1)).sort(()=>Math.random()-0.5);
  showScreen('idealG');
}
function startTrial(){
  adjusting = true;
  document.body.classList.add('hide-cursor');
  stimulus.style.display='block';
  if (taskType==='ç»ƒä¹ '){
    idx = Math.floor(Math.random()*imgList.length);
  } else if (taskType==='å½“å‰ä½“å‹'){
    idx = currentStarts[currentTrial];
  } else if (taskType==='ç†æƒ³ä½“å‹'){
    idx = idealStarts[idealTrial];
  }
  startIdx = idx;
  updateStimulus();
  t0 = Date.now();
}

/* ===== æ€§åˆ«é€‰æ‹© ===== */
async function chooseGender(g){
  gender = (g==='M') ? 'Male' : 'Female';
  series = (g==='M') ? 'M' : 'F';
  enterFullscreen();
  preloadTip.textContent = `å·²é€‰æ‹©ï¼š${gender==='Male'?'ç”·æ€§':'å¥³æ€§'}ï¼Œå¼€å§‹é¢„åŠ è½½â€¦`;
  imgList = getSeriesURLs(series);
  btnStartPractice.disabled = true;
  await preloadAll(imgList);
  preloaded = true;
  preloadTip.textContent = 'é¢„åŠ è½½å®Œæˆã€‚ç°åœ¨å¯ä»¥è¿›å…¥ç»ƒä¹ ã€‚';
  btnStartPractice.disabled = false;
}

/* ===== äº‹ä»¶ç»‘å®š ===== */
if (maleBtn)   maleBtn.addEventListener('click', ()=>chooseGender('M'));
if (femaleBtn) femaleBtn.addEventListener('click', ()=>chooseGender('F'));

btnStartPractice.addEventListener('click', ()=>{
  if (!preloaded){ alert('è¯·å…ˆç­‰å¾…é¢„åŠ è½½å®Œæˆ'); return; }
  if (!(studentIdEl.value && subjectNumberEl.value)){ alert('è¯·å…ˆå¡«å†™å­¦å·ä¸è¢«è¯•åºå·'); return; }
  const d=new Date(), p=n=>(n<10?'0':'')+n;
  const ts = d.getFullYear()+''+p(d.getMonth()+1)+p(d.getDate())+p(d.getHours())+p(d.getMinutes())+p(d.getSeconds());
  sessionId = `${ts}_${(studentIdEl.value||'').trim()}_${(subjectNumberEl.value||'').trim()}`;
  experimentStartTime = Date.now();
  startPracticeBlock();
});

/* ===== é”®ç›˜äº¤äº’ ===== */
window.addEventListener('keydown',(e)=>{
  const k = e.key.toLowerCase();
  if (!adjusting){
    if (screens.pracG.classList.contains('active') && k===' '){ Object.values(screens).forEach(s=>s.classList.remove('active')); startTrial(); return; }
    if (screens.currG.classList.contains('active') && k===' '){ Object.values(screens).forEach(s=>s.classList.remove('active')); labelCurrent.style.opacity=1; startTrial(); return; }
    if (screens.idealG.classList.contains('active') && k===' '){ Object.values(screens).forEach(s=>s.classList.remove('active')); labelIdeal.style.opacity=1; startTrial(); return; }
  }
  if (adjusting){
    if (k==='f' || k==='j'){ if (holdKey!==k) startHold(k); }
    else if (k==='r'){ idx = startIdx; pendingIndex = idx; }
    else if (k==='enter'){
      if (enterLocked) return; enterLocked = true;
      saveRow(); showFix(); adjusting = false; stopHold();
      setTimeout(async ()=>{
        hideFix(); enterLocked = false;
        if (taskType==='ç»ƒä¹ '){
          practiceTrial++;
          if (practiceTrial < PRACTICE_TRIALS) startTrial();
          else startCurrentBlock();
        } else if (taskType==='å½“å‰ä½“å‹'){
          currentTrial++;
          if (currentTrial < CURRENT_TRIALS) startTrial();
          else startIdealBlock();
        } else if (taskType==='ç†æƒ³ä½“å‹'){
          idealTrial++;
          if (idealTrial < IDEAL_TRIALS) startTrial();
          else {
            stimulus.style.display='none';
            document.body.classList.remove('hide-cursor');
            showUploadingOverlay();
            try{ await uploadAllResults(); hideUploadingOverlay(); goToSurvey(); } // â˜… ä¿®æ”¹ï¼šä¸Šä¼ æˆåŠŸåè¿›å…¥é—®å·
            catch(err){ hideUploadingOverlay(); console.error('Upload failed:', err); showUploadFailedOverlay((err && err.message) ? err.message : String(err)); }
          }
        }
      }, FIX_MS);
    }
  }
});
window.addEventListener('keyup',(e)=>{ const k = e.key.toLowerCase(); if (k==='f' || k==='j') stopHold(); if (k==='enter') enterLocked = false; });

/* åˆå§‹æç¤º */
preloadTip.textContent = 'ç­‰å¾…é€‰æ‹©æ€§åˆ«å¼€å§‹é¢„åŠ è½½â€¦';
</script>
</body>
</html>
