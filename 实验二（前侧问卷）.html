<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>é—®å·å¡«å†™ Â· æ²¿ç”¨å®éªŒæ ·å¼ï¼ˆæ·¡é»„ç£¨ç ‚ + ç²’å­ï¼‰</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
  :root{
    /* â€”â€” ä¸å®éªŒé¡µä¸€è‡´çš„ä¸»é¢˜å˜é‡ â€”â€” */
    --bg-grad-1:#1a1a1a; --bg-grad-2:#22201c; --bg-grad-3:#26231f;
    --txt:#e9e7e4; --muted:#bfc4c9;
    --acc:#f2c14e; --acc-2:#ffd86b;

    --panel-bg: rgba(30,30,30,.38);
    --panel-blur: 16px;
    --panel-saturate: 145%;
    --panel-radius: 16px;
    --panel-pad: 32px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;color:var(--txt);font-family:'Roboto',ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Microsoft YaHei",sans-serif;
    background:
      radial-gradient(1200px 700px at 20% 0%, rgba(255,207,92,.06), transparent 65%),
      radial-gradient(1000px 700px at 80% 100%, rgba(255,207,92,.05), transparent 60%),
      linear-gradient(180deg, var(--bg-grad-1), var(--bg-grad-2) 40%, var(--bg-grad-3));
  }

  /* å…¨å±€ç²’å­ç”»å¸ƒï¼ˆæ²¿ç”¨å®éªŒé¡µï¼‰ */
  #fxCanvas{position:fixed; inset:0; z-index:-1; pointer-events:none}

  /* ç»ç’ƒé¢æ¿å®¹å™¨ï¼šæ”¹ä¸ºå¯æ»šåŠ¨ï¼Œé€‚é…ç”µè„‘å±ï¼ˆå®½å±å±…ä¸­ï¼‰ */
  .panel{
    position: fixed; inset: 0; display:flex; align-items:flex-start; justify-content:center;
    background: var(--panel-bg);
    backdrop-filter: blur(var(--panel-blur)) saturate(var(--panel-saturate));
    -webkit-backdrop-filter: blur(var(--panel-blur)) saturate(var(--panel-saturate));
    padding: clamp(18px, 3vw, 36px);
    overflow-y:auto; /* å…³é”®ï¼šè¡¨å•è¾ƒé•¿æ—¶æ»šåŠ¨ */
  }

  /* é¡¶éƒ¨åŒºï¼šæ ‡é¢˜ + è¿›åº¦ */
  .shell{width:min(1100px, 92vw)}
  .card{
    background:rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.14);
    border-radius:18px; box-shadow:0 18px 42px rgba(0,0,0,.35), inset 0 1px rgba(255,255,255,.2);
  }
  .hd{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:16px 18px; border-bottom:1px solid rgba(255,255,255,.12)}
  .title{display:flex; align-items:center; gap:10px; font-size:22px; font-weight:800}
  .badge{font-size:14px;background:linear-gradient(180deg,var(--acc-2),var(--acc)); color:#2b1f08; padding:6px 10px; border-radius:999px; font-weight:800}
  .desc{margin:0; color:#f3f3f3; opacity:.9; font-size:14px}

  .bd{padding:18px}
  .bar{width:100%;height:12px;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,.10);box-shadow:inset 0 2px 6px rgba(0,0,0,.45)}
  .bar>span{display:block;height:100%;width:0;background:linear-gradient(90deg,#ffe082,#ffc107 30%,#ffca28 70%,#ffd54f)}

  /* æ­¥éª¤æ¡ï¼ˆæ³¨æ„ï¼šæ­¤å¤„çš„ .step ä¸“ç”¨äºæ­¥éª¤æ¡è§†è§‰ï¼Œä¸å†ç”¨äºè¡¨å•åˆ†æ­¥å®¹å™¨ï¼‰ */
  .stepper{display:flex; gap:10px; flex-wrap:wrap}
  .step{flex:1; min-width:220px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:10px; display:flex; align-items:center; gap:10px}
  .step i{width:26px; height:26px; border-radius:50%; background:#23252e; color:#ffe59a; display:grid; place-items:center; font-weight:900}
  .step.active{border-color:#ffd86b; box-shadow:0 0 0 3px rgba(242,193,78,.22)}
  .step.active i{background:linear-gradient(180deg,var(--acc-2),var(--acc)); color:#2b1f08}

  /* è¡¨å•æ§ä»¶ï¼ˆæ²¿ç”¨å®éªŒçš„è¾“å…¥æ¡†é£æ ¼ï¼‰ */
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:14px}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} }
  label{font-weight:700; display:block; margin:2px 0 6px}
  .tip{font-size:12px; color:var(--muted)}

  input[type="text"], input[type="number"], input[type="email"], select, textarea{
    margin:0; padding:12px 14px; font-size:16px; width:100%;
    border:1.5px solid rgba(255,255,255,.16); border-radius:12px;
    background:rgba(255,255,255,.06); color:#fff; outline:none;
    transition:.2s border-color,.2s box-shadow,.2s background;
  }
  textarea{min-height:120px; resize:vertical}
  input::placeholder, textarea::placeholder{ color:#d7d7d7; opacity:.75 }
  input:focus, select:focus, textarea:focus{
    border-color:var(--acc);
    box-shadow:0 0 0 3px rgba(242,193,78,.18);
    background:rgba(255,255,255,.08);
  }

  /* é¢˜ç»„å¡ç‰‡ */
  .qcard{margin-top:14px}
  .qcard .bd>section{padding:10px 0}
  .q{margin:10px 0}
  .opts{display:flex; gap:12px; flex-wrap:wrap}
  .radio{display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border:1px solid rgba(255,255,255,.12); border-radius:10px; background:rgba(255,255,255,.04)}

  /* â€”â€” æ–°ï¼šé€é¢˜ä¸‹æ–¹è¯„åˆ†æ ·å¼ â€”â€” */
  .likert{display:block;}
  .q-list{display:grid; gap:14px;}
  .q-item{
    background:rgba(255,255,255,.04);
    border:1px solid rgba(255,255,255,.12);
    border-radius:12px;
    padding:12px;
  }
  .q-text{font-weight:700; line-height:1.6; margin-bottom:10px}
  .scale-row{
    display:flex; gap:8px; flex-wrap:nowrap; justify-content:space-between;
  }
  .pill{position:relative; display:inline-block}
  .pill input{
    position:absolute; inset:0; width:100%; height:100%; opacity:0; cursor:pointer;
  }
  .pill span{
    display:grid; place-items:center;
    min-width:40px; padding:8px 0;
    border-radius:10px;
    border:1px solid rgba(255,255,255,.18);
    background:rgba(255,255,255,.05);
    font-weight:800;
    user-select:none;
  }
  .pill input:focus + span{ box-shadow:0 0 0 3px rgba(242,193,78,.22); border-color:var(--acc); }
  .pill input:checked + span{
    background:linear-gradient(180deg, var(--acc-2), var(--acc));
    border-color:transparent; color:#2b1f08;
    box-shadow:0 8px 18px rgba(242,193,78,.15), inset 0 1px rgba(255,255,255,.35);
  }
  .anchors{display:flex; justify-content:space-between; font-size:12px; color:var(--muted); margin-top:6px; padding:0 2px}

  /* æ“ä½œåŒºæŒ‰é’®æ²¿ç”¨ .btn */
  .actions{display:flex; gap:10px; justify-content:flex-end; padding:14px; border-top:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.04); border-radius:0 0 18px 18px}
  .btn{position:relative; overflow:hidden; background:linear-gradient(180deg, var(--acc-2), var(--acc)); color:#2b1f08; border:0; border-radius:14px; padding:12px 20px; font-size:16px; cursor:pointer; font-weight:800; box-shadow:0 8px 18px rgba(242,193,78,.15), inset 0 1px rgba(255,255,255,.35); transition:.18s transform ease, .18s filter ease, .18s box-shadow ease}
  .btn[disabled]{opacity:.55;cursor:not-allowed}
  .btn:hover{filter:brightness(1.05); transform:translateY(-1px)}
  .btn:active{transform:translateY(0)}
  .btn.ghost{background:rgba(255,255,255,.06); color:#f7f7f7; border:1px solid rgba(255,255,255,.14)}

  .err{color:#ff7676; font-size:13px; margin-top:6px; display:none}
  .ok{color:#9deabf; font-size:13px}
  .footer{color:var(--muted); text-align:center; font-size:12px; padding:14px}

  @media print{ .panel{position:relative; inset:auto; background:#fff; backdrop-filter:none} #fxCanvas, .actions, .stepper, .bar, .footer{display:none!important} .card{break-inside:avoid} body{background:#fff} }
  /* è®©æŸä¸ªæ …æ ¼é¡¹æ¨ªè·¨ä¸¤åˆ— */
  .grid .span-2{ grid-column: 1 / -1; }
  /* ç´§å‡‘å‹æ­¥éª¤æ¡ï¼šæ”¾åœ¨è¿›åº¦æ¡ä¸‹çš„å°èƒ¶å›Š */
  .stepper-compact{
    display:flex; gap:8px; flex-wrap:wrap;
    align-items:center; justify-content:flex-start;
    margin-top:10px;
  }
  .stepper-compact .step{
    flex:0 0 auto;
    min-width:auto;
    padding:6px 10px;
    border-radius:10px;
    background:rgba(255,255,255,.05);
    border:1px solid rgba(255,255,255,.10);
  }
  .stepper-compact .step i{ width:20px; height:20px; font-size:12px; }
  .stepper-compact .step div{ font-size:14px; }
  .stepper-compact .step.active{
    border-color:#ffd86b;
    box-shadow:0 0 0 2px rgba(242,193,78,.20);
  }
  @media (max-width:600px){
    .stepper-compact .step div{ display:none; }
  }
  /* åœ†ç‚¹è¯„åˆ†ï¼šå°åœ†åœˆ + ä¸‹æ–¹æ–‡å­— */
  .scale-row{ display:flex; justify-content:space-between; gap:10px; flex-wrap:nowrap; }
  .dot{
    position:relative; display:flex; flex-direction:column; align-items:center; gap:6px;
    width:68px;
  }
  .dot input{ position:absolute; inset:0; opacity:0; cursor:pointer; }
  .dot .circle{
    width:44px; height:44px; border-radius:999px; display:grid; place-items:center;
    border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.06); font-weight:800;
  }
  .dot input:focus + .circle{ box-shadow:0 0 0 3px rgba(242,193,78,.22); border-color:var(--acc); }
  .dot input:checked + .circle{
    background:linear-gradient(180deg,var(--acc-2),var(--acc)); color:#2b1f08;
    border-color:transparent; box-shadow:0 8px 18px rgba(242,193,78,.15), inset 0 1px rgba(255,255,255,.35);
  }
  .dot em{
    font-style:normal; font-size:12px; color:var(--muted); text-align:center; line-height:1.15;
  }

  @media (max-width:980px){
    .dot{ width:56px }
    .dot .circle{ width:40px; height:40px }
    .scale-row{ gap:6px }
  }
  /* === Likert ç´§å‡‘ç‰ˆï¼ˆå°åœ†åœˆ + å°å¡ç‰‡ï¼‰ === */
  .q-list{ gap:10px; }
  .q-item{ padding:8px 10px; border-radius:10px; }
  .q-text{ margin-bottom:6px; line-height:1.45; }

  /* å°åœ†åœˆå°ºå¯¸ï¼ˆåŸï¼š44/68ï¼‰ */
  .scale-row{ gap:8px; }
  .dot{ width:72px; }
  .dot .circle{ width:32px; height:32px; font-size:14px; }
  .dot em{ font-size:14px; }

  @media (max-width:980px){
    .dot{ width:48px; }
    .dot .circle{ width:32px; height:32px; font-size:13px; }
    .scale-row{ gap:6px; }
  }

  /* ä¿®æ­£â€œæ°‘æ—â€ä¸‹æ‹‰æ¡†åœ¨å¼¹å‡ºåˆ—è¡¨ä¸­å¯¹ç™½åº•ç™½å­—çš„é—®é¢˜ */
  select { color:#fff; }
  select option,
  select optgroup{
    color:#1a1a1a !important;
    background:#ffffff !important;
    text-shadow:none !important;
  }
  select optgroup{ font-weight:700; }
  select option:checked{
    background:#ffe082 !important;
    color:#1a1a1a !important;
  }
  select:required:invalid{ color:var(--muted); }

  /* === æ–°å¢ï¼šæœªä½œç­”é«˜äº®æ ·å¼ === */
  .missing{
    border-color:#ff7676 !important;
    box-shadow:0 0 0 3px rgba(255,118,118,.25) !important;
  }
  .q-item.missing{
    border-color:rgba(255,118,118,.9) !important;
  }
</style>
</head>
<body>
  <canvas id="fxCanvas" aria-hidden="true"></canvas>
  <div class="panel">
    <div class="shell">
     <!-- é¡¶éƒ¨ï¼šæ ‡é¢˜ä¸è¿›åº¦æ¡ -->
<div class="card">
  <div class="hd">
    <div class="title"><span class="badge">BODY IMAGE</span> è°ƒæŸ¥é—®å·</div>
    <div id="formId" class="tip">è¡¨å•IDï¼šâ€”</div>
  </div>
  <div class="bd">
    <p class="desc">åŒå­¦ä»¬å¥½ï¼Œæ¬¢è¿å‚åŠ æœ¬æ¬¡é—®å·è°ƒæŸ¥ï¼ç­”æ¡ˆæ— å¯¹é”™ï¼Œæˆ‘ä»¬åªæƒ³äº†è§£ä½ æœ€çœŸå®çš„æƒ…å†µã€‚</p>
    <div class="bar" aria-label="å¡«å†™è¿›åº¦"><span id="pg" style="width:0%"></span></div>

    <!-- æ–°ï¼šç´§è´´è¿›åº¦æ¡ä¸‹çš„å°æ­¥éª¤æ¡ -->
    <div id="stepper" class="stepper stepper-compact"></div>
  </div>
</div>


      <!-- è¡¨å•ä¸»ä½“ï¼ˆå¤šæ­¥éª¤ï¼‰ -->
      <form id="form" novalidate>
        <!-- Step 1 åŸºæœ¬ä¿¡æ¯ -->
        <section class="card qcard step-sec" data-step="1">
          <div class="hd"><div class="title" style="font-size:18px"><span class="badge" style="font-size:12px">STEP 1</span> åŸºæœ¬ä¿¡æ¯</div></div>
          <div class="bd">
            <div class="grid">
              <div>
                <label for="age">1. å¹´é¾„<span style="color:#ffd86b">*</span></label>
                <input id="age" name="age" type="number" min="10" max="100" placeholder="ä¾‹å¦‚ 20" required />
                <div class="err" data-err="age">å¿…å¡«</div>
              </div>
              <div>
                <label>7. æ€§åˆ«<span style="color:#ffd86b">*</span></label>
                <div class="opts">
                  <label class="radio"><input type="radio" name="gender" value="ç”·" required>ç”·</label>
                  <label class="radio"><input type="radio" name="gender" value="å¥³">å¥³</label>
                </div>
                <div class="err" data-err="gender">å¿…é€‰</div>
              </div>
              <div>
                <label for="major">2. ä¸“ä¸š<span style="color:#ffd86b">*</span></label>
                <input id="major" name="major" type="text" placeholder="ä¾‹å¦‚ å¿ƒç†å­¦" required />
                <div class="err" data-err="major">å¿…å¡«</div>
              </div>
              <div>
                <label>9. ç‹¬ç”Ÿå­å¥³<span style="color:#ffd86b">*</span></label>
                <div class="opts">
                  <label class="radio"><input type="radio" name="onlyChild" value="æ˜¯" required>æ˜¯</label>
                  <label class="radio"><input type="radio" name="onlyChild" value="å¦">å¦</label>
                </div>
                <div class="err" data-err="onlyChild">å¿…é€‰</div>
              </div>
              
              <div>
                <label for="studentId">3. å­¦å·<span style="color:#ffd86b">*</span></label>
                <input id="studentId" name="studentId" type="text" placeholder="è¯·è¾“å…¥å­¦å·" required />
                <div class="err" data-err="studentId">å¿…å¡«</div>
              </div>
              <div>
                <label>8. ç”Ÿæºåœ°<span style="color:#ffd86b">*</span></label>
                <div class="opts">
                  <label class="radio"><input type="radio" name="origin" value="åŸé•‡" required>åŸé•‡</label>
                  <label class="radio"><input type="radio" name="origin" value="å†œæ‘">å†œæ‘</label>
                </div>
                <div class="err" data-err="origin">å¿…é€‰</div>
              </div>
              <div>
                <label for="height">4. èº«é«˜ï¼ˆcmï¼‰<span style="color:#ffd86b">*</span></label>
                <input id="height" name="height_cm" type="number" min="100" max="250" placeholder="ä¾‹å¦‚ 170" required />
                <div class="err" data-err="height_cm">å¿…å¡«</div>
              </div>
              <div>
                <label>11. å¹´çº§<span style="color:#ffd86b">*</span></label>
                <div class="opts">
                  <label class="radio"><input type="radio" name="grade" value="å¤§ä¸€" required>å¤§ä¸€</label>
                  <label class="radio"><input type="radio" name="grade" value="å¤§äºŒ">å¤§äºŒ</label>
                  <label class="radio"><input type="radio" name="grade" value="å¤§ä¸‰">å¤§ä¸‰</label>
                  <label class="radio"><input type="radio" name="grade" value="å¤§å››">å¤§å››</label>
                  <label class="radio"><input type="radio" name="grade" value="ç ”ç©¶ç”Ÿ">ç ”ç©¶ç”Ÿ</label>
                </div>
                <div class="err" data-err="grade">å¿…é€‰</div>
              </div>
              <div>
                <label for="weight">5. ä½“é‡ï¼ˆkgï¼‰<span style="color:#ffd86b">*</span></label>
                <input id="weight" name="weight_kg" type="number" min="30" max="200" placeholder="ä¾‹å¦‚ 60" required />
                <div class="err" data-err="weight_kg">å¿…å¡«</div>
              </div>
              <div>
  <label for="ethnicity">10. æ°‘æ—<span style="color:#ffd86b">*</span></label>
  <select id="ethnicity" name="ethnicity" required>
    <option value="">è¯·é€‰æ‹©</option>
    <option>æ±‰æ—</option>
    <optgroup label="å°‘æ•°æ°‘æ—">
      <option>å£®æ—</option><option>å›æ—</option><option>æ»¡æ—</option><option>ç»´å¾å°”æ—</option>
      <option>è‹—æ—</option><option>å½æ—</option><option>åœŸå®¶æ—</option><option>è’™å¤æ—</option>
      <option>è—æ—</option><option>å¸ƒä¾æ—</option><option>ä¾—æ—</option><option>ç‘¶æ—</option>
      <option>æœé²œæ—</option><option>ç™½æ—</option><option>å“ˆå°¼æ—</option><option>å“ˆè¨å…‹æ—</option>
      <option>é»æ—</option><option>å‚£æ—</option><option>ç•²æ—</option><option>å‚ˆåƒ³æ—</option>
      <option>ä»¡ä½¬æ—</option><option>ä¸œä¹¡æ—</option><option>é«˜å±±æ—</option><option>æ‹‰ç¥œæ—</option>
      <option>æ°´æ—</option><option>ä½¤æ—</option><option>çº³è¥¿æ—</option><option>ç¾Œæ—</option>
      <option>åœŸæ—</option><option>ä»«ä½¬æ—</option><option>é”¡ä¼¯æ—</option><option>æŸ¯å°”å…‹å­œæ—</option>
      <option>è¾¾æ–¡å°”æ—</option><option>æ™¯é¢‡æ—</option><option>æ¯›å—æ—</option><option>æ’’æ‹‰æ—</option>
      <option>å¸ƒæœ—æ—</option><option>å¡”å‰å…‹æ—</option><option>é˜¿æ˜Œæ—</option><option>æ™®ç±³æ—</option>
      <option>é„‚æ¸©å…‹æ—</option><option>æ€’æ—</option><option>äº¬æ—</option><option>åŸºè¯ºæ—</option>
      <option>å¾·æ˜‚æ—</option><option>ä¿å®‰æ—</option><option>ä¿„ç½—æ–¯æ—</option><option>è£•å›ºæ—</option>
      <option>ä¹Œå­œåˆ«å…‹æ—</option><option>é—¨å·´æ—</option><option>é„‚ä¼¦æ˜¥æ—</option><option>ç‹¬é¾™æ—</option>
      <option>èµ«å“²æ—</option><option>å¡”å¡”å°”æ—</option>
    </optgroup>
  </select>
  <div class="err" data-err="ethnicity">å¿…é€‰</div>
</div>
              <div class="span-2">
                <label for="email">6. é‚®ç®±ï¼ˆå¯é€‰ï¼‰</label>
                <input id="email" name="email" type="email" placeholder="xxxxxxxxxx@xxx.com" />
              </div>
            </div>
            <p class="tip">è¯´æ˜ï¼šè¯·å¦‚å®å¡«å†™ä¸ªäººåŸºæœ¬ä¿¡æ¯ï¼›å­¦å·ä»…ç”¨äºç ”ç©¶è®°å½•ä¸æŠ¥é…¬å‘æ”¾ï¼Œä¸å¯¹å¤–å±•ç¤ºã€‚</p>
          </div>
          <div class="actions">
            <button type="button" class="btn" data-next>ä¸‹ä¸€æ­¥ â†’</button>
          </div>
        </section>

        <!-- Step 2ï¼šèº«ä½“å½¢è±¡æƒ…æ„Ÿä½“éªŒï¼ˆ7ç‚¹æ»¡æ„åº¦ï¼Œ6é¢˜ï¼‰ -->
        <section class="card qcard step-sec" data-step="2" hidden>
          <div class="hd"><div class="title" style="font-size:18px"><span class="badge" style="font-size:12px">STEP 2</span> ä¸‹é¢æ˜¯æ‚¨å¯¹å½“å‰èº«ä½“å½¢è±¡çš„æƒ…æ„Ÿä½“éªŒï¼Œè¯·æ‚¨é€‰å‡ºæœ€ç¬¦åˆè‡ªå·±çš„é€‰é¡¹ä½œç­”å³å¯ã€‚</div></div>
          <div class="bd">
            <div class="likert" id="blockA"></div>
          </div>
          <div class="actions">
            <button type="button" class="btn ghost" data-prev>â† ä¸Šä¸€æ­¥</button>
            <button type="button" class="btn" data-next>ä¸‹ä¸€æ­¥ â†’</button>
          </div>
        </section>

        <!-- Step 3ï¼šèº«ä½“æ¬£èµï¼ˆ5ç‚¹ï¼Œ10é¢˜ï¼‰ -->
        <section class="card qcard step-sec" data-step="3" hidden>
          <div class="hd"><div class="title" style="font-size:18px"><span class="badge" style="font-size:12px">STEP 3</span> è¯·è®¤çœŸé˜…è¯»ä¸‹é¢æ¯ä¸ªæ¡ç›®ï¼Œå¹¶é€‰æ‹©å…¶é™ˆè¿°ä¸æ‚¨çš„å®é™…æƒ…å†µæœ€ä¸ºç›¸ç¬¦çš„é€‰é¡¹ã€‚</div></div>
          <div class="bd">
            <div class="likert" id="blockB"></div>
          </div>
          <div class="actions">
            <button type="button" class="btn ghost" data-prev>â† ä¸Šä¸€æ­¥</button>
            <button type="button" class="btn" data-next>ä¸‹ä¸€æ­¥ â†’</button>
          </div>
        </section>

        <!-- Step 4ï¼šå†…æ„Ÿå—æ€§ï¼ˆ7ç‚¹ï¼Œ18é¢˜ï¼‰ -->
        <section class="card qcard step-sec" data-step="4" hidden>
          <div class="hd"><div class="title" style="font-size:18px"><span class="badge" style="font-size:12px">STEP 4</span> æ ¹æ®æ‚¨çš„çœŸå®æ„Ÿå—ç¨‹åº¦ï¼Œåœ¨ä»¥ä¸‹é—®é¢˜ä¸­é€‰å‡ºæ‚¨è®¤ä¸ºæœ€è´´åˆ‡çš„é€‰é¡¹ã€‚</div></div>
          <div class="bd">
            <div class="likert" id="blockC"></div>
          </div>
          <div class="actions">
            <button type="button" class="btn ghost" data-prev>â† ä¸Šä¸€æ­¥</button>
            <button type="button" class="btn" data-next>ä¸‹ä¸€æ­¥ â†’</button>
          </div>
        </section>

        <!-- Step 5ï¼šç‰¹è´¨æ„Ÿæ©ï¼ˆ7ç‚¹ï¼Œ7é¢˜ï¼Œå«æ³¨æ„åŠ›æ£€æŸ¥ï¼‰ -->
        <section class="card qcard step-sec" data-step="5" hidden>
          <div class="hd"><div class="title" style="font-size:18px"><span class="badge" style="font-size:12px">STEP 5</span> ä»¥ä¸‹æ˜¯ä½ å¯¹ç”Ÿæ´»ä¸­äººã€äº‹ã€ç‰©çš„æƒ…æ„Ÿæ·±æµ…çš„ä½“éªŒï¼Œè¯·æ‚¨é€‰å‡ºæœ€ç¬¦åˆè‡ªå·±çš„é€‰é¡¹ä½œç­”å³å¯ã€‚1=å®Œå…¨ä¸åŒæ„ï¼Œ7=å®Œå…¨åŒæ„ã€‚</div></div>
          <div class="bd">
            <div class="likert" id="blockD"></div>
            <p class="tip">æ³¨æ„åŠ›æ£€æŸ¥ï¼šç¬¬ 7 é¢˜â€œæœ¬é¢˜è¯·é€‰æ‹©ç¬¬å››ä¸ªé€‰é¡¹â€ã€‚</p>
          </div>
          <div class="actions">
            <button type="button" class="btn ghost" data-prev>â† ä¸Šä¸€æ­¥</button>
            <button type="submit" class="btn">æäº¤é—®å·</button>
          </div>
        </section>
      </form>

      <!-- æäº¤ç»“æœ -->
      <div id="result" class="card qcard" hidden>
        <div class="hd"><div class="title" style="font-size:18px"><span class="badge" style="font-size:12px">DONE</span> æäº¤æˆåŠŸ</div></div>
        <div class="bd" style="text-align:center">
          <p>ğŸ‰ æ„Ÿè°¢ä½ çš„å¡«å†™ï¼ä½ å¯ä»¥åœ¨æœ¬åœ°ä¿å­˜æ•°æ®ï¼š</p>
          <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:10px">
            <button id="download-json" class="btn ghost">ä¸‹è½½ JSON</button>
            <button id="download-csv" class="btn ghost">ä¸‹è½½ CSV</button>
            <button id="print-pdf" class="btn ghost">æ‰“å°/å¦å­˜ä¸º PDF</button>
          </div>
          <p class="tip" style="margin-top:10px">å¦‚éœ€ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œå¯åœ¨è„šæœ¬é¡¶éƒ¨é…ç½® <code>SUBMIT_ENDPOINT</code>ã€‚</p>
        </div>
      </div>

      <div class="footer">Â© 2025 é—®å· Â· æ²¿ç”¨å®éªŒæ ·å¼ï¼ˆæ·¡é»„ç£¨ç ‚ + ç²’å­ï¼‰ Â· è‡ªåŠ¨ä¿å­˜è‰ç¨¿ Â· CSV/JSON å¯¼å‡º</div>
    </div>
  </div>

<script>
// âœ… æ˜¯å¦è¢«åµŒåœ¨ iframe ä¸­ï¼ˆå®éªŒé¡µé‡Œï¼‰
const IS_EMBEDDED = (window.top !== window.self);

// ========== 1) é…ç½® ==========
const FORM_ID = (()=>{ const d=new Date(); return 'Q-' + d.toISOString().replace(/[-:TZ.]/g,'').slice(0,14) + '-' + Math.random().toString(36).slice(2,6).toUpperCase(); })();
const SUBMIT_ENDPOINT = 'é—®å·è”åŠ¨ç‰ˆï¼ˆå‰æµ‹ï¼‰.HTLM';// å¯å¡«å…¥ä½ çš„åç«¯ URL
const DRAFT_KEY = 'survey-draft-experimentstyle-v1';

/* âœ… æ–°å¢ï¼šç”¨äºæ¥æ”¶/ç¼“å­˜â€œå®éªŒæ•°æ®â€çš„å†…å­˜å˜é‡ä¸å·¥å…· */
let __expData = null;

/* âœ… æ–°å¢ï¼šä» storage è¯»å–å®éªŒæ•°æ®ï¼ˆå®¹é”™å¤šä¸ªå¸¸è§ Keyï¼‰ */
function loadExperimentData(){
  if (__expData) return __expData;
  const keys = [
    `experiment:${FORM_ID}`,
    `exp:${FORM_ID}`,
    'experiment_data',
    'exp_data'
  ];
  for(const k of keys){
    const raw = sessionStorage.getItem(k) || localStorage.getItem(k);
    if(raw){
      try{ __expData = JSON.parse(raw); }catch(_){ __expData = raw; }
      return __expData;
    }
  }
  return null;
}

/* âœ… æ–°å¢ï¼šç›‘å¬çˆ¶é¡µæ¶ˆæ¯ï¼ŒæŠŠå®éªŒæ•°æ®ç¼“å­˜èµ·æ¥ï¼Œé”®ï¼šexperiment:FORM_ID */
window.addEventListener('message', (e)=>{
  try{
    const msg = e.data || {};
    if(!msg || typeof msg!=='object') return;
    if(msg.type==='EXPERIMENT_DATA' || msg.type==='EXPERIMENT_DONE' || msg.type==='EXP_DATA'){
      __expData = msg.payload ?? msg.data ?? msg.result ?? null;
      try{ sessionStorage.setItem(`experiment:${FORM_ID}`, JSON.stringify(__expData)); }catch(_){}
    }
  }catch(_){}
});

// é‡è¡¨é¢˜åº“ â€”â€” æ¥è‡ªä½ å‘æ¥çš„é—®å·
const SCALE_A = {
  title:'ä¸‹é¢æ˜¯æ‚¨å¯¹å½“å‰èº«ä½“å½¢è±¡çš„æƒ…æ„Ÿä½“éªŒï¼Œè¯·é€‰å‡ºæœ€ç¬¦åˆè‡ªå·±çš„é€‰é¡¹ã€‚',
  labels:['éå¸¸ä¸æ»¡æ„','ä¸æ»¡æ„','æ¯”è¾ƒä¸æ»¡æ„','ä¸€èˆ¬','æ¯”è¾ƒæ»¡æ„','æ»¡æ„','éå¸¸æ»¡æ„'],
  items:[
    'ç°åœ¨è¿™ä¸€åˆ»ï¼Œæˆ‘å¯¹è‡ªå·±çš„å¤–è²Œæ„Ÿè§‰ã€‚',
    'ç°åœ¨è¿™ä¸€åˆ»ï¼Œæˆ‘å¯¹è‡ªå·±çš„ä½“å‹æ„Ÿè§‰ã€‚',
    'ç°åœ¨è¿™ä¸€åˆ»ï¼Œæˆ‘å¯¹è‡ªå·±çš„ä½“é‡æ„Ÿè§‰ã€‚',
    'ç°åœ¨è¿™ä¸€åˆ»ï¼Œæˆ‘å¯¹è‡ªå·±çš„èº«ä½“å¸å¼•åŠ›æ„Ÿè§‰ã€‚',
    'ç°åœ¨è¿™ä¸€åˆ»ï¼Œæˆ‘æ„Ÿè§‰æˆ‘æ¯”å¹³æ—¶çœ‹èµ·æ¥ã€‚',
    'ç°åœ¨è¿™ä¸€åˆ»ï¼Œæˆ‘æ„Ÿè§‰æ¯”ä¸€èˆ¬äººçœ‹èµ·æ¥ã€‚'
  ]
};

const SCALE_B = {
  title:'è¯·è®¤çœŸé˜…è¯»ä¸‹é¢æ¯ä¸ªæ¡ç›®ï¼Œå¹¶é€‰æ‹©å…¶é™ˆè¿°ä¸æ‚¨çš„å®é™…æƒ…å†µæœ€ä¸ºç›¸ç¬¦çš„é€‰é¡¹ï¼ˆèº«ä½“æ¬£èµï¼‰ã€‚',
  labels:['ç»ä¸','å¾ˆå°‘','æœ‰æ—¶','ç»å¸¸','æ€»æ˜¯'],
  items:[
    'æˆ‘å°Šé‡è‡ªå·±çš„èº«ä½“ã€‚',
    'æˆ‘è‡ªè§‰æˆ‘çš„èº«æè¿˜ç®—ä¸é”™ã€‚',
    'æˆ‘è§‰å¾—æˆ‘çš„èº«ææœ‰äº›è¿˜ç®—ä¸é”™çš„åœ°æ–¹ã€‚',
    'æˆ‘å¯¹æˆ‘çš„èº«ææŠ±æœ‰æ­£é¢çš„æ€åº¦ã€‚',
    'æˆ‘å…³æ³¨æˆ‘çš„èº«ä½“æ‰€éœ€ã€‚',
    'æˆ‘å–œæ¬¢æˆ‘çš„èº«ä½“ã€‚',
    'æˆ‘æ¬£èµæˆ‘è‡ªå·±æ‰€æ‹¥æœ‰ç‹¬ç‰¹å’Œä¸åŒçš„ä½“å‹ã€‚',
    'æˆ‘ç”¨æ­£é¢çš„æ€åº¦å¯¹å¾…æˆ‘çš„èº«ä½“ã€‚ä¾‹å¦‚ï¼šæŠ¬é«˜å¤´å’Œå¯¹äººå¾®ç¬‘ã€‚',
    'æˆ‘å®‰é€¸äºè‡ªå·±çš„ä½“å‹ã€‚',
    'è™½ç„¶æˆ‘ä¸åƒåª’ä½“ä¸Šçš„äººç‰©é‚£ä¹ˆå¸å¼•ï¼ˆä¾‹å¦‚æ¨¡ç‰¹ã€æ¼”å‘˜ï¼‰ï¼Œä½†æˆ‘ä»ç„¶è§‰å¾—è‡ªå·±ç¾ä¸½ã€‚'
  ]
};

const SCALE_C = {
  title:'æ ¹æ®æ‚¨çš„çœŸå®æ„Ÿå—ç¨‹åº¦ï¼Œåœ¨ä»¥ä¸‹é—®é¢˜ä¸­é€‰å‡ºæ‚¨è®¤ä¸ºæœ€è´´åˆ‡çš„é€‰é¡¹ï¼ˆå†…æ„Ÿå—æ€§çŸ¥è§‰ï¼‰ã€‚',
  labels:['å®Œå…¨ä¸ç¬¦åˆ','ç›¸å½“ä¸ç¬¦åˆ','æœ‰äº›ä¸ç¬¦åˆ','ä¸€èˆ¬ç¬¦åˆ','æœ‰äº›ç¬¦åˆ','ç›¸å½“ç¬¦åˆ','å®Œå…¨ç¬¦åˆ'],
  items:[
    'æˆ‘æ³¨æ„åˆ°èº«ä½“å¯¹å„ç§é£Ÿç‰©çš„ååº”æ–¹å¼æœ‰æ‰€ä¸åŒã€‚',
    'å½“æˆ‘æ’åˆ°è‡ªå·±æ—¶ï¼Œæˆ‘æ€»èƒ½çŸ¥é“å®ƒæ˜¯å¦ä¼šå˜æˆç˜€ä¼¤ã€‚',
    'æˆ‘æ€»æ˜¯çŸ¥é“è‡ªå·±é”»ç‚¼åˆ°ä»€ä¹ˆç¨‹åº¦ç¬¬äºŒå¤©ä¼šæ„Ÿåˆ°é…¸ç—›ã€‚',
    'å½“æˆ‘åƒæŸäº›é£Ÿç‰©æ—¶ï¼Œæˆ‘æ€»æ˜¯çŸ¥é“æˆ‘çš„èƒ½é‡æ°´å¹³å˜åŒ–ã€‚',
    'å½“æˆ‘å¿«è¦å¾—æµæ„Ÿæ—¶ï¼Œæˆ‘ä¼šæå‰çŸ¥é“ã€‚',
    'æˆ‘ä¸éœ€è¦æµ‹é‡ä½“æ¸©å°±çŸ¥é“è‡ªå·±åœ¨å‘çƒ§ã€‚',
    'æˆ‘å¯ä»¥åˆ†è¾¨é¥¥é¥¿å¼•èµ·çš„ç–²åŠ³å’Œç¼ºä¹ç¡çœ å¼•èµ·çš„ç–²åŠ³ã€‚',
    'æˆ‘å¯ä»¥å‡†ç¡®åœ°é¢„æµ‹ä¸€å¤©ä¸­ä»€ä¹ˆæ—¶é—´ä¼šå‘å›°ã€‚',
    'æˆ‘çŸ¥é“è‡ªå·±ä¸€æ•´å¤©çš„æ´»åŠ¨æ°´å¹³æœ‰ä¸€ä¸ªå‘¨æœŸã€‚',
    'æˆ‘æ— æ³•é€šè¿‡èº«ä½“è¿ä½œæ–¹å¼æ³¨æ„åˆ°å­£èŠ‚æ€§çš„èŠ‚å¾‹å’Œå‘¨æœŸã€‚',
    'æˆ‘æ—©ä¸Šä¸€é†’æ¥å°±çŸ¥é“è‡ªå·±è¿™ä¸€å¤©å°†æœ‰å¤šå°‘ç²¾åŠ›ã€‚',
    'å½“æˆ‘ä¸ŠåºŠç¡è§‰æ—¶ï¼Œå°±èƒ½çŸ¥é“é‚£å¤©æ™šä¸Šä¼šç¡å¾—å¤šå¥½ã€‚',
    'å½“æˆ‘ç–²åŠ³æ—¶ï¼Œæˆ‘æ³¨æ„åˆ°æ˜æ˜¾çš„èº«ä½“ååº”ã€‚',
    'æˆ‘æ³¨æ„åˆ°èº«ä½“å¯¹å¤©æ°”å˜åŒ–çš„ç‰¹æ®Šååº”ã€‚',
    'æˆ‘èƒ½é¢„æµ‹æˆ‘æ™šä¸Šéœ€è¦å¤šå°‘ç¡çœ ç¬¬äºŒå¤©æ‰èƒ½ç¥æ¸…æ°”çˆ½åœ°èµ·åºŠã€‚',
    'å½“æˆ‘çš„é”»ç‚¼ä¹ æƒ¯æ”¹å˜æ—¶ï¼Œæˆ‘èƒ½éå¸¸å‡†ç¡®åœ°é¢„æµ‹è¿™å°†å¦‚ä½•å½±å“æˆ‘çš„ç²¾åŠ›æ°´å¹³ã€‚',
    'æˆ‘æ™šä¸Šä¼¼ä¹æœ‰ä¸€ä¸ªæœ€ä½³çš„ç¡è§‰æ—¶é—´ã€‚',
    'æˆ‘æ³¨æ„åˆ°èº«ä½“å¯¹è¿‡åº¦é¥¥é¥¿çš„ç‰¹æ®Šååº”ã€‚'
  ]
};

const SCALE_D = {
  title:'ä»¥ä¸‹æ˜¯ä½ å¯¹ç”Ÿæ´»ä¸­äººã€äº‹ã€ç‰©çš„æƒ…æ„Ÿæ·±æµ…ä½“éªŒï¼ˆç‰¹è´¨æ„Ÿæ©ï¼‰ã€‚1=å®Œå…¨ä¸åŒæ„ï¼Œ7=å®Œå…¨åŒæ„ã€‚',
  labels:['å®Œå…¨ä¸åŒæ„','ç›¸å½“ä¸åŒæ„','æœ‰äº›ä¸åŒæ„','ä¸ç¡®å®š','æœ‰äº›åŒæ„','ç›¸å½“åŒæ„','å®Œå…¨åŒæ„'],
  items:[
    'æˆ‘ç”Ÿæ´»é‡Œå®åœ¨æœ‰å¤ªå¤šå€¼å¾—æˆ‘æ„Ÿæ¿€çš„ã€‚',
    'å¦‚æœè¦æŠŠæ‰€æœ‰æˆ‘æƒ³æ„Ÿè°¢çš„éƒ½è®°ä¸‹æ¥ï¼Œè¿™ä¸ªè®°å½•å°†ä¼šå¾ˆé•¿ã€‚',
    'ç¯é¡¾è¿™ä¸ªä¸–ç•Œï¼Œæˆ‘æ²¡æœ‰æ‰¾åˆ°ä»€ä¹ˆæ˜¯å€¼å¾—æˆ‘å¤šè°¢çš„ã€‚',
    'å¯¹äºå¾ˆå¤šä¸åŒçš„äººæˆ‘éƒ½å¿ƒå­˜æ„Ÿæ¿€ã€‚',
    'æˆ‘å‘è§‰éšç€å¹´é¾„çš„å¢é•¿ï¼Œæˆ‘è¶Šæ‡‚å¾—æ¬£èµæˆ‘ç”Ÿæ´»ä¸­çš„äººï¼Œäº‹æƒ…å’Œå¤„å¢ƒã€‚',
    'æˆ‘å¯ä»¥ç»è¿‡ä¸€æ®µå¾ˆé•¿æ—¶é—´ï¼Œéƒ½æ²¡æœ‰æ„Ÿè§‰è¦å‘ä»»ä½•äººæˆ–äº‹è‡´è°¢ã€‚',
    'æœ¬é¢˜è¯·é€‰æ‹©ç¬¬å››ä¸ªé€‰é¡¹ã€‚'
  ]
};

// ========== 2) ç²’å­èƒŒæ™¯ ==========
(function mountFX(){
  const cvs = document.getElementById('fxCanvas');
  const ctx = cvs.getContext('2d');
  const DPR = Math.min(2, window.devicePixelRatio || 1);
  let W=0,H=0, t=0, bubbles=[];
  function resize(){ W=cvs.width=innerWidth*DPR; H=cvs.height=innerHeight*DPR; cvs.style.width=innerWidth+'px'; cvs.style.height=innerHeight+'px'; init(); }
  function init(){ const n=90; bubbles.length=0; for(let i=0;i<n;i++){ const z=Math.random(); const r=(6+20*z)*DPR; const x=Math.random()*W; const y=Math.random()*H; const vy=(-.2-1.2*z)*DPR; const hue=40+15*z; bubbles.push({x,y,r,vy,z,hue,tw:Math.random()*Math.PI*2}); } }
  function frame(){ t+=0.005; ctx.clearRect(0,0,W,H);
    for(const b of bubbles){
      b.y+=b.vy*(.7+.3*Math.sin(b.tw+t*2));
      if(b.y+b.r<0){ b.y=H+b.r; b.x=Math.random()*W; }
      ctx.save(); ctx.globalCompositeOperation='lighter';
      const g=ctx.createRadialGradient(b.x, b.y, b.r*0.1, b.x, b.y, b.r);
      g.addColorStop(0, `hsla(${b.hue},85%,70%,.45)`);
      g.addColorStop(.6, `hsla(${b.hue+10},85%,65%,.12)`);
      g.addColorStop(1,'rgba(0,0,0,0)');
      ctx.fillStyle=g; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill();
      ctx.restore();
    }
    requestAnimationFrame(frame);
  }
  addEventListener('resize', resize); resize(); frame();
})();

// ========== 3) è¡¨å•æ¸²æŸ“ä¸é€»è¾‘ ==========
const $ = s=>document.querySelector(s); const $$ = s=>Array.from(document.querySelectorAll(s));
/* âœ… æ”¹ä¸º 5 æ­¥ */
const steps = [1,2,3,4,5]; let current=1; const pgEl=$('#pg'); const stepper=$('#stepper'); const form=$('#form'); const result=$('#result');
$('#formId').textContent = 'è¡¨å•IDï¼š'+FORM_ID;

function renderStepper(){
  stepper.innerHTML = steps.map((s,i)=>`<div class="step ${current===s?'active':''}"><i>${i+1}</i><div>ç¬¬ ${i+1} æ­¥</div></div>`).join('');
}
function setProgress(){ const pct=Math.round((steps.indexOf(current)+1)/steps.length*100); pgEl.style.width=pct+'%'; renderStepper(); }
function showStep(n){
  current=n;
  document.querySelectorAll('section.step-sec').forEach(sec=>sec.hidden = Number(sec.dataset.step)!==n);
  setProgress(); window.scrollTo({top:0,behavior:'smooth'});
}

/** é€é¢˜ä¸‹æ–¹è¯„åˆ†æ¸²æŸ“ */
function renderLikertList(containerId, prefix, labels, items){
  const wrap = document.getElementById(containerId);
  const list = document.createElement('div');
  list.className = 'q-list';

  items.forEach((text, idx)=>{
    const name = `${prefix}${idx+1}`;
    const item = document.createElement('div');
    item.className = 'q-item';

    const q = document.createElement('div');
    q.className = 'q-text';
    q.textContent = `${idx+1}. ${text}`;
    item.appendChild(q);

    const row = document.createElement('div');
    row.className = 'scale-row';

    labels.forEach((lab, i)=>{
      const lbl = document.createElement('label');
      lbl.className = 'dot';
      lbl.title = `${i+1}ï¼š${lab}`;
      lbl.innerHTML = `
        <input type="radio" name="${name}" value="${i+1}" ${i===0?'required':''} aria-label="${lab}">
        <span class="circle">${i+1}</span>
        <em>${lab}</em>
      `;
      row.appendChild(lbl);
    });

    item.appendChild(row);

    /* âœ… æ–°å¢ï¼šæ¯é¢˜å°±åœ°é”™è¯¯æç¤ºï¼ˆé»˜è®¤éšè—ï¼‰ */
    const miss = document.createElement('div');
    miss.className = 'err';
    miss.dataset.err = name;
    miss.textContent = 'è¯·ä½œç­”æ­¤é¢˜';
    item.appendChild(miss);

    list.appendChild(item);
  });

  wrap.innerHTML = '';
  const tip = document.createElement('p');
  tip.className = 'tip'; tip.style.margin = '0 0 8px 0';
  tip.textContent = 'è¯·åœ¨æ¯é¢˜ä¸‹æ–¹é€‰æ‹©æœ€ç¬¦åˆæ‚¨æƒ…å†µçš„æ•°å­—ï¼ˆæ¯ä¸ªæ•°å­—ä¸‹æ–¹é™„æœ‰æ–‡å­—è¯´æ˜ï¼‰ã€‚';
  wrap.appendChild(tip);
  wrap.appendChild(list);
}


// æ¸²æŸ“å››ä¸ªé¢˜ç»„ï¼ˆé€é¢˜ä¸‹æ–¹è¯„åˆ†ï¼‰
renderLikertList('blockA','A', SCALE_A.labels, SCALE_A.items);
renderLikertList('blockB','B', SCALE_B.labels, SCALE_B.items);
renderLikertList('blockC','C', SCALE_C.labels, SCALE_C.items);
renderLikertList('blockD','D', SCALE_D.labels, SCALE_D.items);

/* âœ… æ›¿æ¢ï¼šå¢å¼ºç‰ˆæ ¡éªŒï¼ˆçº¢æ¡†é«˜äº® + å°±åœ°æç¤º + è‡ªåŠ¨æ»šåˆ°ç¬¬ä¸€å¤„æ¼ç­”ï¼‰ */
function validateStep(n){
  const sec = document.querySelector(`section.step-sec[data-step="${n}"]`);
  let ok = true;
  let firstMiss = null;

  // æ¸…ç†æ—§çŠ¶æ€
  sec.querySelectorAll('.missing').forEach(el=>el.classList.remove('missing'));
  sec.querySelectorAll('.err').forEach(el=>el.style.display='none');

  // 1) æ–‡æœ¬/æ•°å­—/ä¸‹æ‹‰/å¤šè¡Œï¼ˆéå•é€‰ç»„ï¼‰
  const singles = sec.querySelectorAll('input[required]:not([type=radio]):not([type=checkbox]), select[required], textarea[required]');
  singles.forEach(ctrl=>{
    const v = (ctrl.value||'').trim() !== '';
    if(!v){
      ok = false;
      if(!firstMiss) firstMiss = ctrl;
      ctrl.classList.add('missing');
      const errEl = sec.querySelector(`[data-err="${ctrl.name||ctrl.id}"]`);
      if(errEl) errEl.style.display = 'block';
    }
  });

  // 2) å•é€‰é¢˜ï¼šåŒ…å«åŸºæœ¬ä¿¡æ¯é‡Œçš„å•é€‰ + æ‰€æœ‰ Likert é¢˜
  const radioNames = new Set(Array.from(sec.querySelectorAll('input[type=radio][name]')).map(x=>x.name));
  radioNames.forEach(name=>{
    const group = sec.querySelectorAll(`input[type=radio][name="${name}"]`);
    const answered = Array.from(group).some(x=>x.checked);
    if(!answered){
      ok = false;
      if(!firstMiss) firstMiss = group[0];

      // åŸºæœ¬ä¿¡æ¯å•é€‰ï¼šæ˜¾ç¤º data-err=xxx çš„æç¤º
      const err1 = sec.querySelector(`[data-err="${name}"]`);
      if(err1) err1.style.display = 'block';

      // Likertï¼šç»™æ•´é¢˜å¡ç‰‡åŠ çº¢æ¡†ï¼Œå¹¶æ˜¾ç¤ºé¢˜å†…æç¤º
      const qi = group[0].closest('.q-item');
      if(qi){
        qi.classList.add('missing');
        const err2 = sec.querySelector(`.err[data-err="${name}"]`);
        if(err2) err2.style.display = 'block';
      }
    }
  });

  if(!ok && firstMiss){
    firstMiss.scrollIntoView({behavior:'smooth', block:'center'});
  }
  return ok;
}

$$('[data-next]').forEach(b=>b.addEventListener('click',()=>{ if(!validateStep(current)) return; const i=steps.indexOf(current); if(i<steps.length-1) showStep(steps[i+1]); }));
$$('[data-prev]').forEach(b=>b.addEventListener('click',()=>{ const i=steps.indexOf(current); if(i>0) showStep(steps[i-1]); }));

// ä¿å­˜è‰ç¨¿ï¼ˆè½»é‡é˜²æŠ–ï¼‰
function serialize(){
  const data = { __meta:{formId:FORM_ID, submittedAt:new Date().toISOString(), ua:navigator.userAgent} };
  const fd = new FormData(form); const multi={};
  for(const [k,v] of fd.entries()){ if(multi[k]){ if(!Array.isArray(data[k])) data[k]=[]; data[k].push(v); } else { if(data[k]!==undefined){ if(!Array.isArray(data[k])) data[k]=[data[k]]; data[k].push(v);} else data[k]=v; } }
  return data;
}
function saveDraft(){ try{ localStorage.setItem(DRAFT_KEY, JSON.stringify(serialize())); }catch(e){} }
function loadDraft(){ try{
  const raw=localStorage.getItem(DRAFT_KEY); if(!raw) return;
  const data=JSON.parse(raw);
  for(const k in data){
    if(k==='__meta') continue;
    const val=data[k];
    if(Array.isArray(val)){
      val.forEach(v=>{ const el=form.querySelector(`[name="${k}"][value="${v}"]`); if(el) el.checked=true; });
    } else {
      const el=form.querySelector(`[name="${k}"]`);
      if(el){
        if(el.type==='radio'||el.type==='checkbox'){ const rb=form.querySelector(`[name="${k}"][value="${val}"]`); rb && (rb.checked=true); }
        else el.value=val;
      }
    }
  }
}catch(e){} }

form.addEventListener('input', ()=>{ clearTimeout(window.__draft); window.__draft = setTimeout(saveDraft, 600); });

/* âœ… æ–°å¢ï¼šä½œç­”å˜æ›´å³æ¸…é™¤è¯¥é¢˜çš„é”™è¯¯æ˜¾ç¤º/çº¢æ¡† */
document.addEventListener('change', (e)=>{
  const t = e.target;
  if(!t.name) return;
  const sec = t.closest('section.step-sec');
  const key = t.type === 'radio' ? t.name : (t.name || t.id);
  const err = sec && sec.querySelector(`[data-err="${key}"]`);
  if(err) err.style.display = 'none';

  if(t.type === 'radio'){
    const qi = t.closest('.q-item');
    if(qi) qi.classList.remove('missing');
  }else{
    t.classList.remove('missing');
  }
});

// æäº¤
form.addEventListener('submit', (e)=>{
  e.preventDefault(); if(!validateStep(current)) return;
  // æ³¨æ„åŠ›æ£€æŸ¥ï¼šç‰¹è´¨æ„Ÿæ©ç¬¬7é¢˜å¿…é¡»é€‰ 4
  const attn = form.querySelector('input[name="D7"]:checked');
  if(!attn || attn.value !== '4'){ alert('æ³¨æ„åŠ›æ£€æŸ¥æœªé€šè¿‡ï¼šè¯·å°†ç¬¬ 5 æ­¥ç¬¬ 7 é¢˜é€‰æ‹©ç¬¬ 4 ä¸ªé€‰é¡¹ã€‚'); return; }

  const data = serialize();

  /* ç¼“å­˜é—®å·æ•°æ®ï¼ˆå¯é€‰ï¼‰ */
  try{
    sessionStorage.setItem('survey:'+FORM_ID, JSON.stringify(data));
    sessionStorage.setItem('survey_last_form_id', FORM_ID);
  }catch(_e){}

  /* å‘ŠçŸ¥çˆ¶é¡µï¼šé—®å·å®Œæˆï¼ˆè‹¥åµŒå…¥åœ¨å®éªŒé¡µå¯ç”¨ï¼‰ */
  parent.postMessage({type:'SURVEY_DONE', payload: data}, '*');

  /* âœ… åˆå¹¶â€œå®éªŒæ•°æ®â€ä¸é—®å·ä¸€èµ·ä¸Šä¼ åˆ°åŒä¸€åœ°å€ */
  const exp = loadExperimentData(); // å¯èƒ½ä¸º null
  const combined = {
    __meta: { ...data.__meta, kind:'survey+experiment', pid: FORM_ID },
    survey: data,
    experiment: exp ?? null
  };

  // ç»Ÿä¸€å‘é€åˆ°åŒä¸€ä¸ª SUBMIT_ENDPOINTï¼ˆJSONï¼‰
  if(SUBMIT_ENDPOINT){
    fetch(SUBMIT_ENDPOINT,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(combined)
    }).catch(()=>{});
  }

  document.getElementById('download-json').onclick = ()=>{
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=FORM_ID + '.json'; a.click(); URL.revokeObjectURL(a.href);
  };
  document.getElementById('download-csv').onclick = ()=>{
    const csv = toCSV(data); const blob = new Blob([csv], {type:'text/csv;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=FORM_ID + '.csv'; a.click(); URL.revokeObjectURL(a.href);
  };
  document.getElementById('print-pdf').onclick = ()=> window.print();

  localStorage.removeItem(DRAFT_KEY);

  /* æäº¤åçš„æ˜¾ç¤ºé€»è¾‘ï¼ˆä¸å†æœ‰â€œå¼€å§‹å®éªŒâ€å¡ç‰‡ï¼‰ */
  form.hidden = true;
  result.hidden = false;
  current = steps[steps.length-1]; setProgress(); // è¿›åº¦åˆ° 100%
  window.scrollTo({top:0, behavior:'smooth'});
});

// CSV å·¥å…·ï¼šæŠŠæ‰å¹³çš„é—®å·æ•°æ®å¯¼å‡º
function toCSV(obj){
  const flat = {...obj}; delete flat.__meta;
  const keys = Object.keys(flat);
  const head = ['__meta.formId','__meta.submittedAt', ...keys];
  const row = [FORM_ID, new Date().toISOString(), ...keys.map(k=>{
    const v = flat[k]; const s = Array.isArray(v)? v.join('; ') : (v ?? ''); return '"'+String(s).replace(/"/g,'""')+'"';
  })];
  return head.join(',') + "\n" + row.join(',');
}

// åˆå§‹åŒ–
loadDraft(); renderStepper(); showStep(1);
</script>
</body>
</html>
