<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>体型调整实验 · COS 上传（整场一次上传 + BMI + 防闪屏）</title>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

<style>
  :root{
    /* 主题与质感 */
    --bg-grad-1:#1a1a1a; --bg-grad-2:#22201c; --bg-grad-3:#26231f;
    --txt:#e9e7e4; --muted:#bfc4c9;
    --acc:#f2c14e; --acc-2:#ffd86b;

    /* 毛玻璃/卡片 */
    --panel-bg: rgba(30,30,30,.38);
    --panel-blur: 16px;
    --panel-saturate: 145%;
    --panel-radius: 16px;
    --panel-pad: 40px;
  }

  *{box-sizing:border-box}
  html,body{
    margin:0;height:100%;color:var(--txt);
    font-family:'Roboto',ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Microsoft YaHei",sans-serif;
    overflow:hidden
  }
  body{
    display:flex;align-items:center;justify-content:center;padding:36px;
    background:
      radial-gradient(1200px 700px at 20% 0%, rgba(255,207,92,.06), transparent 65%),
      radial-gradient(1000px 700px at 80% 100%, rgba(255,207,92,.05), transparent 60%),
      linear-gradient(180deg, var(--bg-grad-1), var(--bg-grad-2) 40%, var(--bg-grad-3));
  }
  .hide-cursor{cursor:none}

  /* 屏幕容器 */
  .screen{position:absolute;inset:0;display:none;align-items:center;justify-content:center;padding:28px;text-align:center}
  .screen.active{display:flex}

  /* 全屏毛玻璃面板（所有页面统一使用） */
  .panel{
    position: fixed; inset: 0;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    background: var(--panel-bg);
    backdrop-filter: blur(var(--panel-blur)) saturate(var(--panel-saturate));
    -webkit-backdrop-filter: blur(var(--panel-blur)) saturate(var(--panel-saturate));
    padding: var(--panel-pad);
    box-shadow: none; border: none; border-radius: 0;
  }

  /* 统一字号 */
  h1{ margin:10px 0; text-shadow:0 1px 1px rgba(0,0,0,.25); font-size:36px; }
  p{  margin:10px 0; text-shadow:0 1px 1px rgba(0,0,0,.25); font-size:28px; }
  .muted{color:var(--muted); font-size:18px}

  /* 按钮 */
  .btn{
    position:relative; overflow:hidden;
    background:linear-gradient(180deg, var(--acc-2), var(--acc));
    color:#2b1f08; border:0; border-radius:14px;
    padding:14px 32px; font-size:22px; cursor:pointer; margin:10px 8px; font-weight:700;
    box-shadow:0 8px 18px rgba(242,193,78,.15), inset 0 1px rgba(255,255,255,.35);
    transition:.18s transform ease, .18s filter ease, .18s box-shadow ease;
  }
  .btn[disabled]{opacity:.55;cursor:not-allowed}
  .btn:hover{filter:brightness(1.05); transform:translateY(-1px)}
  .btn:active{transform:translateY(0)}
  #btnStartPractice{ padding:16px 48px; }

  /* 输入框 */
  input{
    margin:8px; padding:12px 14px; font-size:18px;
    border:1.5px solid rgba(255,255,255,.16); border-radius:12px;
    background:rgba(255,255,255,.06); color:#fff; outline:none;
    transition:.2s border-color,.2s box-shadow,.2s background;
  }
  input::placeholder{ color:#d7d7d7; opacity:.75 }
  input:focus{
    border-color:var(--acc);
    box-shadow:0 0 0 3px rgba(242,193,78,.18);
    background:rgba(255,255,255,.08);
  }

  /* 进度条 */
  .bar{width:min(900px,78vw);height:12px;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border-radius:999px;overflow:hidden;margin-top:16px;border:1px solid rgba(255,255,255,.10);box-shadow:inset 0 2px 6px rgba(0,0,0,.45)}
  .bar>span{display:block;height:100%;width:0;background:linear-gradient(90deg,#ffe082,#ffc107 30%,#ffca28 70%,#ffd54f)}

  /* 刺激与提示 */
  #stimulus{max-width:80%;height:60vh;display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);will-change:opacity,transform}
  #fixation{display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:64px;color:var(--acc)}
  .hint{position:absolute;font-size:24px;color:#1e1b16;font-weight:700;background:linear-gradient(180deg,#ffe082,#ffd54f);border:0;border-radius:12px;padding:8px 12px;box-shadow:0 6px 20px rgba(0,0,0,.22)}
  .hint-left{left:8%;top:50%;transform:translateY(-50%);display:none}
  .hint-right{right:8%;top:50%;transform:translateY(-50%);display:none}
  #currentTypeLabel,#idealTypeLabel{font-size:26px;color:#ffe59a;opacity:0;transition:opacity .2s;position:absolute;top:82%;left:50%;transform:translateX(-50%)}
  #practicePrompt{position:absolute;top:82%;left:50%;transform:translateX(-50%);color:#ffe59a;display:none}

  /* ====== Notice 页面（排版优化） ====== */
  #notice .nz-card{
    width:min(980px,92vw);
    background:rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.14);
    border-radius:18px;
    box-shadow:0 18px 42px rgba(0,0,0,.35), inset 0 1px rgba(255,255,255,.2);
    padding:22px 22px 16px;
    position:relative;
  }
  #notice header.nz-head{display:flex;align-items:center;gap:12px;margin-bottom:6px}
  #notice .nz-badge{font-size:20px;background:linear-gradient(180deg,var(--acc-2),var(--acc)); color:#2b1f08; padding:5px 10px; border-radius:999px; font-weight:700}
  #notice h1.nz-title{margin:0;font-size:26px}
  #notice p.nz-lead{margin:.25rem 0 1rem;color:#f3f3f3;opacity:.9;font-size:16px;line-height:1.7;max-width:68ch}

  #notice .nz-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  #notice .nz-pane{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:16px 18px}
  #notice .nz-pane h2{margin:0 0 8px 0;font-size:20px}
  #notice .nz-pane p{margin:8px 0 0 0;line-height:1.8;font-size:16px;letter-spacing:.1px}
  #notice .nz-pane ul{margin:8px 0 0 0;padding-left:18px;line-height:1.8;font-size:16px}
  #notice .nz-pane li{margin:.35em 0;padding-left:.2em}
  #notice .nz-pane li::marker{color:#ffd86b}
  #notice .nz-muted{color:var(--muted);font-size:13px}

  /* 底部操作区 */
  #notice .nz-actions{
    display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;
    background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.08);
    border-radius:14px; padding:12px 14px; margin-top:14px
  }

  /* 自定义勾选框：透明小方块 → 点击出现金色对号 */
  #notice .nz-ck{display:flex;align-items:center;gap:10px}
  #notice .nz-ck input{
    appearance:none; -webkit-appearance:none; -moz-appearance:none;
    width:26px;height:26px;border-radius:6px;
    border:2px solid rgba(255,255,255,.28);
    background:transparent; cursor:pointer; position:relative;
    transition:.18s border-color,.18s box-shadow;
  }
  /* 金色描边与焦点态 */
  #notice .nz-ck input:focus-visible{outline:none;box-shadow:0 0 0 3px rgba(242,193,78,.25);border-color:var(--acc)}
  #notice .nz-ck input:hover{border-color:rgba(255,255,255,.45)}

  /* 用两条边绘制“对号”，更稳（不用字体） */
  #notice .nz-ck input::after{
    content:""; position:absolute; left:50%; top:50%;
    width:8px; height:14px; /* 对号尺寸 */
    border-right:3px solid var(--acc);
    border-bottom:3px solid var(--acc);
    transform:translate(-50%,-60%) rotate(45deg) scale(0);
    transform-origin:center; opacity:0;
    transition:transform .16s ease, opacity .16s ease;
    pointer-events:none;
  }
  #notice .nz-ck input:checked{border-color:var(--acc)}
  #notice .nz-ck input:checked::after{opacity:1; transform:translate(-50%,-60%) rotate(45deg) scale(1)}

  /* 全局粒子画布（在哪些页面显示由 JS 决定） */
  #fxCanvas{position:fixed; inset:0; z-index:-1; pointer-events:none}

  @media (max-width:900px){ #notice .nz-grid{grid-template-columns:1fr} }

  /* Notice 文案左对齐；小标题居中 */
  #notice .panel,
  #notice .nz-card,
  #notice .nz-head,
  #notice .nz-lead,
  #notice .nz-pane,
  #notice .nz-pane p,
  #notice .nz-pane ul,
  #notice .nz-pane li { text-align:left; }
  #notice .nz-pane h2 { text-align:center; }
  #notice .nz-pane p, #notice .nz-lead { word-break:break-word; white-space:normal; }
</style>
</head>
<body>

<!-- ✅ 全局粒子画布：默认在 notice / guidelines / thankYou 显示 -->
<canvas id="fxCanvas" aria-hidden="true"></canvas>

<!-- Notice（注意事项） -->
<section id="notice" class="screen active">
  <div class="panel" role="region" aria-label="实验注意事项">
    <article class="nz-card">
      <header class="nz-head">
        <span class="nz-badge">NOTICE</span>
        <h1 class="nz-title">欢迎参加体型调整实验</h1>
      </header>

      <p class="nz-lead"></p>

      <section class="nz-grid">
        <!-- 左：注意事项 -->
        <div class="nz-pane">
          <h2>注意事项</h2>
          <ul>
            <li>为保证您流畅的实验体验，建议您在良好的网络环境下进行，关闭消息提醒与弹窗，避免分心。</li>
            <li>为保证您实验报酬的顺利发放，请如实填写信息（学号与手机号后 4 位仅用于报酬发放对账）。</li>
            <li>为保证数据质量与您的体验，请在安静、光线适宜的环境中完成，并尽量使用电脑全屏模式。</li>
            <li>实验中如出现不适或需暂停时，可随时退出并联系主试；您拥有随时退出的权利，并严格遵守下述保密原则。</li>
            <li>若您对实验过程中有任何疑问，均可在实验结束后添加主试微信咨询。</li>
          </ul>
        </div>

        <!-- 右：保密原则 -->
        <div class="nz-pane">
          <h2>保密原则</h2>
          <ul>
            <li><b>匿名处理：</b>实验记录以编码形式保存，不包含可直接识别身份的信息；公开报告仅呈现汇总统计。</li>
            <li><b>限用途：</b>数据仅用于本课题的科学研究与学术发表，不作商业用途。</li>
            <li><b>安全存储：</b>数据存放于受控研究账号云端，访问受权限保护；传输采用加密通道。</li>
            <li><b>自愿参与：</b>可在任何阶段撤回；撤回后可请求删除未分析的数据。</li>
            <li><b>不外传：</b>为避免干扰他人参与，请勿在研究完成前公开讨论题目或传播页面内容。</li>
          </ul>
        </div>
      </section>

      <div class="nz-actions">
        <div class="nz-ck">
          <input id="agree" type="checkbox" aria-label="我已阅读并同意注意事项与保密条款">
          <label for="agree">我已阅读并同意注意事项与保密条款</label>
        </div>

        <!-- 注意：此进度条在点击按钮后才会从 0 → 100% -->
        <div class="bar" aria-hidden="true" style="width:240px;height:15px">
          <span id="noticePg" style="width:0%"></span>
        </div>

        <button id="btnNoticeNext" class="btn" disabled>我已阅读，进入实验</button>
      </div>
    </article>
  </div>
</section>

<!-- 指导语（首页） -->
<section id="guidelines" class="screen">
  <div class="panel">
    <h1>欢迎您参加本实验！</h1>
    <p>实验中，您将通过"F"键与"J"键来对呈现的体型胖瘦进行调整，直到符合相应体型。</p>
    <p>您可以通过长按或点击"F"键与"J"键来进行快速或精细的调整，</p>
    <p>调整完成后，按“回车键（Enter）”确认选择。</p>
    <p style="margin-top:6px">请选择您的性别</p>
    <div>
      <input id="studentId" placeholder="请输入学号" />
      <input id="subjectNumber" placeholder="请输手机号码后4位" />
    </div>
    <div>
      <button id="maleButton" class="btn">男性</button>
      <button id="femaleButton" class="btn">女性</button>
    </div>
    <div class="bar" style="margin-top:10px"><span id="preloadPg"></span></div>
    <p id="preloadTip" class="muted">等待选择性别开始预加载…</p>
    <button id="btnStartPractice" class="btn" disabled>进入练习</button>
    <p class="muted">请您耐心等待实验加载，若长时间未加载完成，可点击性别进行刷新或重新进入实验！</p>
    <p class="muted">注：请准确填写学号与手机号后4位，这将作为实验编码，以便发放报酬。</p>
  </div>
</section>

<!-- 练习/正式指导语 -->
<section id="practiceGuidelines" class="screen">
  <div class="panel">
    <p>练习阶段（共 3 次）！</p>
    <p>您可以通过‘长按’ “F” 与 “J” 键，来进行体型的 ‘快速’ 调整，</p>
    <p>或通过‘点击’ “F” 与 “J” 键来对体型进行‘精细’ 调整。</p>
    <p>若您已经了解具体操作，按 <b>空格键</b> 开始练习！</p>
  </div>
</section>

<section id="currentGuidelines" class="screen">
  <div class="panel">
    <p>正式实验开始！</p>
    <p>“当前体型”调整任务（共10 次）！</p>
    <p>现在，您将通过"F"键与"J"键来调整出最接近您当前的体型。</p>
    <p>按“回车键（Enter）”确认保存调整结果，按“空格键”正式开始实验。</p>
  </div>
</section>

<section id="idealGuidelines" class="screen">
  <div class="panel">
    <p>“理想体型”调整任务（共10 次）！</p>
    <p>现在，您将通过"F"键与"J"键来调整您的理想体型。</p>
    <p>按“回车键（Enter）”确认保存调整结果，按“空格键”开始实验。</p>
  </div>
</section>

<!-- 刺激层 -->
<img id="stimulus" alt="stimulus" decoding="async" loading="eager" fetchpriority="high">
<div id="fixation">+</div>
<div class="hint hint-left">长按“F”快速变瘦</div>
<div class="hint hint-right">长按“J”快速变胖</div>
<div id="currentTypeLabel"><p>调至与您<b>当前最相近</b>的体型，按 <b>Enter</b> 确认。</p></div>
<div id="idealTypeLabel"><p>调至您的<b>理想体型</b>，按 <b>Enter</b> 确认。</p></div>
<div id="practicePrompt" class="muted">熟悉后可按 <b>Enter</b> 结束本次练习</div>

<!-- 结束页与遮罩 -->
<section id="thankYou" class="screen">
  <div class="panel">
    <p>请您备注好学号与手机号码后4位后，添加实验主试微信领取实验报酬！！！</p>
    <p>按下“ESC”后，关闭当前页面即可。</p>
    <h1>实验结束，感谢参与！</h1>
  </div>
</section>

<div id="overlayUploading" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);color:#fff;z-index:9999;align-items:center;justify-content:center;flex-direction:column;">
  <div style="font-size:20px;margin-bottom:10px">正在上传数据，请稍候…</div>
  <div class="bar" style="width:300px"><span style="width:100%"></span></div>
</div>

<div id="overlayFailed" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);color:#fff;z-index:9999;align-items:center;justify-content:center;flex-direction:column;">
  <div style="font-size:20px;margin-bottom:12px">上传失败，请检查网络后重试</div>
  <button id="btnRetryUpload" class="btn">重试上传</button>
</div>

<!-- COS SDK -->
<script src="https://cdn.jsdelivr.net/npm/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js"></script>

<script>
/* ===== 常量 ===== */
const STS_URL    = 'https://bodyshape2025-8gk5msghc2121838-1373390636.ap-shanghai.app.tcloudbase.com/cos-sts-event';
const COS_BUCKET = 'bodyshape-data-1373390636';
const COS_REGION = 'ap-shanghai';

/* ===== 问卷跳转设置（新增） =====
 * 将 SURVEY_URL 改为你的问卷地址或本地文件名，例如：
 * '实验二（前侧问卷）.html'
 * 将通过 URL 参数传递：
 * studentId, phone4, gender, series, sessionId, startedAt, endedAt
 */
const SURVEY_URL = '实验二（前侧问卷）.html';

/* ===== 图片资源路径 ===== */
const IS_PROD   = location.hostname.endsWith('github.io');
const SITE_BASE = IS_PROD ? 'https://BodyImageLab.github.io/body-shape-experiment_xiaowu/' : './';
const BASE_URL_F = SITE_BASE + 'img_F/';
const BASE_URL_M = SITE_BASE + 'img_M/';

const MAX_F = 76, MAX_M = 76;
const F_EXT = 'png', M_EXT = 'png';
let F_LIST = [], M_LIST = [];

// 试次数/时序/频率
const PRACTICE_TRIALS = 3;
const CURRENT_TRIALS  = 10;
const IDEAL_TRIALS    = 10;
const FIX_MS = 800;
const HOLD_INTERVAL = 70;

/* ===== DOM/状态 ===== */
const screens = {
  notice: document.getElementById('notice'),
  guide: document.getElementById('guidelines'),
  pracG: document.getElementById('practiceGuidelines'),
  currG: document.getElementById('currentGuidelines'),
  idealG: document.getElementById('idealGuidelines'),
  thank: document.getElementById('thankYou')
};
const preloadPg = document.getElementById('preloadPg');
const preloadTip = document.getElementById('preloadTip');
const btnStartPractice = document.getElementById('btnStartPractice');
const maleBtn = document.getElementById('maleButton');
const femaleBtn = document.getElementById('femaleButton');
const btnNoticeNext = document.getElementById('btnNoticeNext');

const stimulus = document.getElementById('stimulus');
const fixation = document.getElementById('fixation');
const hintL = document.querySelector('.hint-left');
const hintR = document.querySelector('.hint-right');
const labelCurrent = document.getElementById('currentTypeLabel');
const labelIdeal = document.getElementById('idealTypeLabel');
const practicePrompt = document.getElementById('practicePrompt');

const studentIdEl = document.getElementById('studentId');
const subjectNumberEl = document.getElementById('subjectNumber');

let gender = null, series = 'F', imgList = [];
let idx = 0, holdTimer = null, holdKey = null, adjusting = false, preloaded = false;
let practiceTrial = 0, currentTrial = 0, idealTrial = 0;
let currentStarts = [], idealStarts = [];
let t0 = 0, startIdx = 0, enterLocked = false, experimentStartTime = 0;
let taskType = '练习';
let results = [];
let sessionId = null;
let pendingIndex = null;

/* ===== Notice：同意后按钮可用；按按钮先跑进度条再进入下一页 ===== */
const agree = document.getElementById('agree');
const noticePg = document.getElementById('noticePg');

if (agree && btnNoticeNext){
  btnNoticeNext.disabled = !agree.checked;
  agree.addEventListener('change', ()=> btnNoticeNext.disabled = !agree.checked);

  btnNoticeNext.addEventListener('click', async ()=>{
    if(btnNoticeNext.disabled) return;

    // 禁用按钮，跑进度动画
    btnNoticeNext.disabled = true;
    await runNoticeProgress();

    // ✅ 进入实验前先请求全屏（有用户点击手势，最可靠）
  enterFullscreen();

    // 进度完毕后进入下一页（FX 会随 showScreen 自动切换）
    showScreen('guide');
  });
}

/* 进度条动画：点击按钮后从 0 → 100% */
function runNoticeProgress(){
  return new Promise(resolve=>{
    let w = 0;
    noticePg.style.width = '0%';
    const timer = setInterval(()=>{
      w += 12 + Math.random()*18; // 速度可按需调整
      if (w >= 100){
        w = 100;
        clearInterval(timer);
        resolve();
      }
      noticePg.style.width = w.toFixed(0) + '%';
    }, 120);
  });
}

/* ===== 通用粒子 & 涟漪（可按需选择在哪些页面启用） ===== */

/** 👇 在这里控制粒子背景在哪些“页面键”启用。
 *  页面键是 showScreen(key) 里用的 key：
 *  notice / guide / pracG / currG / idealG / thank
 *  想关闭某页，就把相应 key 从集合里删掉即可。
 */
const FX_PAGES = new Set(['notice','guide','thank']);

let bgFX = null;
function mountFX(){
  if (bgFX) return;
  const cvs = document.getElementById('fxCanvas');
  const ctx = cvs.getContext('2d');
  const DPR = Math.min(2, window.devicePixelRatio || 1);
  const reduce = matchMedia('(prefers-reduced-motion: reduce)').matches;
  let W=0,H=0,t=0, mx=0,my=0, rafId=null, bubbles=[];

  function resize(){
    W = cvs.width  = innerWidth  * DPR;
    H = cvs.height = innerHeight * DPR;
    cvs.style.width  = innerWidth + 'px';
    cvs.style.height = innerHeight + 'px';
    init();
  }
  function init(){
    const n = reduce ? 40 : 90;
    bubbles.length = 0;
    for(let i=0;i<n;i++){
      const z = Math.random();
      const r = (6 + 20*z) * DPR;
      const x = Math.random()*W;
      const y = Math.random()*H;
      const vy = (-.2 - 1.2*z) * DPR;
      const hue = 40 + 15*z;
      bubbles.push({x,y,r,vy,z,hue,tw:Math.random()*Math.PI*2});
    }
  }
  function draw(){
    t += 0.005;
    ctx.clearRect(0,0,W,H);
    const grad = ctx.createLinearGradient(0,0,W,H);
    grad.addColorStop(0,'rgba(0,0,0,.08)');
    grad.addColorStop(1,'rgba(0,0,0,.20)');
    ctx.fillStyle = grad; ctx.fillRect(0,0,W,H);

    for(const b of bubbles){
      const ox = (mx*0.06)*(1-b.z)*DPR;
      const oy = (my*0.04)*(1-b.z)*DPR;
      b.y += b.vy*(.7 + .3*Math.sin(b.tw + t*2));
      if (b.y + b.r < 0) { b.y = H + b.r; b.x = Math.random()*W; }
      ctx.save(); ctx.globalCompositeOperation = 'lighter';
      const g = ctx.createRadialGradient(b.x+ox, b.y+oy, b.r*0.1, b.x+ox, b.y+oy, b.r);
      g.addColorStop(0, `hsla(${b.hue},85%,70%,.45)`);
      g.addColorStop(.6, `hsla(${b.hue+10},85%,65%,.12)`);
      g.addColorStop(1, 'rgba(0,0,0,0)');
      ctx.fillStyle = g; ctx.beginPath(); ctx.arc(b.x+ox, b.y+oy, b.r, 0, Math.PI*2); ctx.fill();
      ctx.globalCompositeOperation = 'screen';
      ctx.fillStyle = `hsla(${b.hue+20},100%,85%,.35)`;
      ctx.beginPath(); ctx.arc(b.x+ox - b.r*0.3, b.y+oy - b.r*0.3, b.r*0.25, 0, Math.PI*2); ctx.fill();
      ctx.restore();
    }
    rafId = requestAnimationFrame(draw);
  }
  const onResize = ()=>resize();
  const onMove   = (e)=>{ mx = (e.clientX / innerWidth  - .5) * 2; my = (e.clientY / innerHeight - .5) * 2; };

  // 水波涟漪：只在启用 FX 的页面内的按钮上
  const onClick = (e)=>{
    // 用 section id 选择（注意：这里用的是 DOM id，不是 key）
    const btn = e.target.closest('#notice .btn, #guidelines .btn, #thankYou .btn');
    if(!btn) return;
    const rip = document.createElement('span');
    rip.style.position='absolute';
    rip.style.borderRadius='50%';
    rip.style.transform='translate(-50%,-50%) scale(0)';
    rip.style.background='rgba(255,255,255,.55)';
    rip.style.pointerEvents='none';
    rip.style.left = (e.clientX - btn.getBoundingClientRect().left) + 'px';
    rip.style.top  = (e.clientY - btn.getBoundingClientRect().top)  + 'px';
    const size = Math.max(btn.offsetWidth, btn.offsetHeight);
    rip.style.width = rip.style.height = size + 'px';
    rip.style.transition='transform .6s ease-out, opacity .6s ease-out';
    btn.appendChild(rip);
    requestAnimationFrame(()=>{ rip.style.transform='translate(-50%,-50%) scale(18)'; rip.style.opacity='0'; });
    rip.addEventListener('transitionend', ()=> rip.remove());
  };

  window.addEventListener('resize', onResize);
  window.addEventListener('mousemove', onMove, {passive:true});
  document.addEventListener('click', onClick);

  resize(); if(!reduce){ draw(); }

  bgFX = {
    destroy(){
      if (rafId) cancelAnimationFrame(rafId);
      window.removeEventListener('resize', onResize);
      window.removeEventListener('mousemove', onMove, {passive:true});
      document.removeEventListener('click', onClick);
      const c = document.getElementById('fxCanvas');
      if (c){ const ctx2=c.getContext('2d'); ctx2 && ctx2.clearRect(0,0,c.width,c.height); }
      bgFX = null;
    }
  };
}
function unmountFX(){ if (bgFX) bgFX.destroy(); }

/* 根据当前屏的 key 决定是否启用粒子 */
function maybeToggleFXFor(screenKey){
  if (FX_PAGES.has(screenKey)) mountFX(); else unmountFX();
}

/* ===== 工具函数 ===== */
function enterFullscreen(){ const el=document.documentElement; if (el.requestFullscreen) el.requestFullscreen().catch(()=>{}); }

/* 切屏：统一在这里控制 FX 的开关 */
function showScreen(key){
  Object.values(screens).forEach(s=>s.classList.remove('active'));
  screens[key].classList.add('active');
  maybeToggleFXFor(key);
}

/* 初始化：根据默认 active 的屏决定是否开启 FX */
{
  const activeKey = Object.entries(screens).find(([k,el])=>el.classList.contains('active'))?.[0] || 'notice';
  maybeToggleFXFor(activeKey);
}

/* ===== 预加载 ===== */
function genNames(prefix, n, ext){ const a=[]; for (let i=1;i<=n;i++) a.push(`${prefix}${i}.${ext}`); return a; }
function clamp(v,lo,hi){ return Math.min(hi, Math.max(lo,v)); }
function getSeriesURLs(which){
  if (which === 'M'){ const names = M_LIST.length ? M_LIST : genNames('M', MAX_M, M_EXT); return names.map(n => BASE_URL_M + n); }
  else { const names = F_LIST.length ? F_LIST : genNames('F', MAX_F, F_EXT); return names.map(n => BASE_URL_F + n); }
}
async function preloadAll(urls){
  if (!urls.length) return;
  let done = 0, total = urls.length;
  const upd = ()=>{ preloadPg.style.width = ((done/total)*100).toFixed(1) + '%'; };
  for (const u of urls) {
    const im = new Image(); im.loading='eager'; im.decoding='async'; im.src=u;
    try { await im.decode(); } catch(e) {}
    done++; upd();
  }
}

/* ===== BMI 映射 ===== */
function bmiFromIndex(series, index){
  if (series === 'F'){ return +(10.8 + index * 0.432).toFixed(2); }
  else { return +(11.8 + index * 0.472).toFixed(2); }
}

/* ===== 呈现/索引 ===== */
function updateStimulus(){
  idx = clamp(idx, 0, imgList.length-1);
  stimulus.src = imgList[idx];
  stimulus.style.display = 'block';
  if (taskType === '练习'){
    hintL.style.display='block'; hintR.style.display='block';
    practicePrompt.style.display=(practiceTrial < PRACTICE_TRIALS)?'block':'none';
    labelCurrent.style.opacity=0; labelIdeal.style.opacity=0;
  } else {
    hintL.style.display='none'; hintR.style.display='none';
    practicePrompt.style.display='none';
    labelCurrent.style.opacity=(taskType==='当前体型')?1:0;
    labelIdeal.style.opacity=(taskType==='理想体型')?1:0;
  }
}
function showFix(){ stimulus.style.display='none'; labelCurrent.style.opacity=0; labelIdeal.style.opacity=0; hintL.style.display='none'; hintR.style.display='none'; practicePrompt.style.display='none'; fixation.style.display='block'; }
function hideFix(){ fixation.style.display='none'; }

/* ===== 记录 ===== */
function saveRow(){
  results.push({
    task_type: taskType,
    series,
    selected_image: imgList[idx] || '',
    index: idx,
    bmi: bmiFromIndex(series, idx),
    start_index: startIdx,
    response_time: new Date().toISOString(),
    response_duration_ms: Date.now() - t0,
    student_id: (studentIdEl.value||'').trim(),
    subject_number: (subjectNumberEl.value||'').trim(),
    gender
  });
}

/* ===== 长按快速步进 ===== */
function startHold(which){ stopHold(); const delta=(which==='f')?-1:+1; step(delta); holdKey=which; holdTimer=setInterval(()=>step(delta),HOLD_INTERVAL); }
function stopHold(){ if (holdTimer){ clearInterval(holdTimer); holdTimer=null; } holdKey=null; }
function step(delta){ if (!adjusting) return; idx = clamp(idx + delta, 0, imgList.length-1); pendingIndex = idx; }

/* ===== 渲染循环（切图更顺滑） ===== */
function renderLoop(){ if (pendingIndex !== null){ stimulus.src = imgList[pendingIndex]; pendingIndex = null; } requestAnimationFrame(renderLoop); }
renderLoop();

/* ===== 覆盖层控制 ===== */
function showUploadingOverlay(){ document.getElementById('overlayUploading').style.display='flex'; }
function hideUploadingOverlay(){ document.getElementById('overlayUploading').style.display='none'; }
function showUploadFailedOverlay(msg){
  const el = document.getElementById('overlayFailed'); el.style.display='flex';
  document.getElementById('btnRetryUpload').onclick = async ()=>{
    el.style.display='none'; showUploadingOverlay();
    try{ await uploadAllResults(); hideUploadingOverlay(); goToSurvey(); }  // ★ 修改：重试成功后也进入问卷
    catch(e){ hideUploadingOverlay(); showUploadFailedOverlay(String(e)); }
  };
}

/* ===== 整场 payload / 上传 ===== */
function buildPayload(){
  return { sessionId, pid: (studentIdEl.value||'').trim(), subjectNumber: (subjectNumberEl.value||'').trim(), gender, rows: results };
}
async function uploadAllResults(){
  const payload = buildPayload();
  const sts = await fetch(STS_URL).then(r=>r.json());
  if (!sts.ok) throw new Error(sts.error || 'Get STS failed');
  const cos = new COS({ getAuthorization: (options, cb) => cb({
      TmpSecretId:  sts.credentials.TmpSecretId,
      TmpSecretKey: sts.credentials.TmpSecretKey,
      SecurityToken: sts.credentials.Token,
      StartTime: Math.floor(Date.now()/1000) - 1,
      ExpiredTime: Math.floor(Date.now()/1000) + 600
    }) });
  const dateDir = new Date().toISOString().slice(0,10);
  const key = `sessions/${dateDir}/${payload.sessionId}.json`;
  await new Promise((resolve,reject)=>{
    cos.putObject({ Bucket: COS_BUCKET, Region: COS_REGION, Key: key,
      Body: new Blob([JSON.stringify(payload)], { type:'application/json' })
    }, (err,data)=>err?reject(err):resolve(data));
  });
  try {
  sessionStorage.setItem('exp_payload', JSON.stringify(payload));
  sessionStorage.setItem('exp_uploaded_key', key);
} catch(_) {}

  console.log('Uploaded to COS:', key);
  return key;
}

/* ===== 问卷跳转函数（新增） ===== */
function goToSurvey(){
  const base = (SURVEY_URL || '').trim();
  if (!base){ showScreen('thank'); return; } // 兜底：未配置问卷链接则保留原感谢页

  const params = new URLSearchParams({
    studentId: (studentIdEl.value || '').trim(),
    phone4: (subjectNumberEl.value || '').trim(),
    gender: gender || '',
    series,
    sessionId: sessionId || '',
    startedAt: new Date(experimentStartTime || Date.now()).toISOString(),
    endedAt: new Date().toISOString()
  });
  const expKey = sessionStorage.getItem('exp_uploaded_key') || '';
params.set('expKey', expKey);


  const url = base + (base.includes('?') ? '&' : '?') + params.toString();
  const go = ()=> location.replace(encodeURI(url)); // 处理中文文件名

  if (document.fullscreenElement && document.exitFullscreen){
    document.exitFullscreen().catch(()=>{}).finally(go);
  }else{
    go();
  }
}

/* ===== 流程控制 ===== */
function startPracticeBlock(){ taskType='练习'; practiceTrial=0; showScreen('pracG'); }
function startCurrentBlock(){
  taskType='当前体型'; currentTrial=0;
  currentStarts = Array(5).fill(0).concat(Array(5).fill(imgList.length-1)).sort(()=>Math.random()-0.5);
  showScreen('currG');
}
function startIdealBlock(){
  taskType='理想体型'; idealTrial=0;
  idealStarts = Array(5).fill(0).concat(Array(5).fill(imgList.length-1)).sort(()=>Math.random()-0.5);
  showScreen('idealG');
}
function startTrial(){
  adjusting = true;
  document.body.classList.add('hide-cursor');
  stimulus.style.display='block';
  if (taskType==='练习'){
    idx = Math.floor(Math.random()*imgList.length);
  } else if (taskType==='当前体型'){
    idx = currentStarts[currentTrial];
  } else if (taskType==='理想体型'){
    idx = idealStarts[idealTrial];
  }
  startIdx = idx;
  updateStimulus();
  t0 = Date.now();
}

/* ===== 性别选择 ===== */
async function chooseGender(g){
  gender = (g==='M') ? 'Male' : 'Female';
  series = (g==='M') ? 'M' : 'F';
  enterFullscreen();
  preloadTip.textContent = `已选择：${gender==='Male'?'男性':'女性'}，开始预加载…`;
  imgList = getSeriesURLs(series);
  btnStartPractice.disabled = true;
  await preloadAll(imgList);
  preloaded = true;
  preloadTip.textContent = '预加载完成。现在可以进入练习。';
  btnStartPractice.disabled = false;
}

/* ===== 事件绑定 ===== */
if (maleBtn)   maleBtn.addEventListener('click', ()=>chooseGender('M'));
if (femaleBtn) femaleBtn.addEventListener('click', ()=>chooseGender('F'));

btnStartPractice.addEventListener('click', ()=>{
  if (!preloaded){ alert('请先等待预加载完成'); return; }
  if (!(studentIdEl.value && subjectNumberEl.value)){ alert('请先填写学号与被试序号'); return; }
  const d=new Date(), p=n=>(n<10?'0':'')+n;
  const ts = d.getFullYear()+''+p(d.getMonth()+1)+p(d.getDate())+p(d.getHours())+p(d.getMinutes())+p(d.getSeconds());
  sessionId = `${ts}_${(studentIdEl.value||'').trim()}_${(subjectNumberEl.value||'').trim()}`;
  experimentStartTime = Date.now();
  startPracticeBlock();
});

/* ===== 键盘交互 ===== */
window.addEventListener('keydown',(e)=>{
  const k = e.key.toLowerCase();
  if (!adjusting){
    if (screens.pracG.classList.contains('active') && k===' '){ Object.values(screens).forEach(s=>s.classList.remove('active')); startTrial(); return; }
    if (screens.currG.classList.contains('active') && k===' '){ Object.values(screens).forEach(s=>s.classList.remove('active')); labelCurrent.style.opacity=1; startTrial(); return; }
    if (screens.idealG.classList.contains('active') && k===' '){ Object.values(screens).forEach(s=>s.classList.remove('active')); labelIdeal.style.opacity=1; startTrial(); return; }
  }
  if (adjusting){
    if (k==='f' || k==='j'){ if (holdKey!==k) startHold(k); }
    else if (k==='r'){ idx = startIdx; pendingIndex = idx; }
    else if (k==='enter'){
      if (enterLocked) return; enterLocked = true;
      saveRow(); showFix(); adjusting = false; stopHold();
      setTimeout(async ()=>{
        hideFix(); enterLocked = false;
        if (taskType==='练习'){
          practiceTrial++;
          if (practiceTrial < PRACTICE_TRIALS) startTrial();
          else startCurrentBlock();
        } else if (taskType==='当前体型'){
          currentTrial++;
          if (currentTrial < CURRENT_TRIALS) startTrial();
          else startIdealBlock();
        } else if (taskType==='理想体型'){
          idealTrial++;
          if (idealTrial < IDEAL_TRIALS) startTrial();
          else {
            stimulus.style.display='none';
            document.body.classList.remove('hide-cursor');
            showUploadingOverlay();
            try{ await uploadAllResults(); hideUploadingOverlay(); goToSurvey(); } // ★ 修改：上传成功后进入问卷
            catch(err){ hideUploadingOverlay(); console.error('Upload failed:', err); showUploadFailedOverlay((err && err.message) ? err.message : String(err)); }
          }
        }
      }, FIX_MS);
    }
  }
});
window.addEventListener('keyup',(e)=>{ const k = e.key.toLowerCase(); if (k==='f' || k==='j') stopHold(); if (k==='enter') enterLocked = false; });

/* 初始提示 */
preloadTip.textContent = '等待选择性别开始预加载…';
</script>
</body>
</html>
