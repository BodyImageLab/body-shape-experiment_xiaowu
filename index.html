<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>体型调整实验 · COS 上传（整场一次上传 + BMI + 防闪屏）</title>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

<style>
  :root { --bg:#121212; --txt:#e0e0e0; --acc:#ffcc00; --muted:#b9c0c7; }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--txt);font-family:'Roboto',ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Microsoft YaHei",sans-serif;overflow:hidden}
  body{display:flex;align-items:center;justify-content:center;padding:36px}
  .hide-cursor{cursor:none}

  /* ===== 指导语字体大小（首页、练习、正式指导语） ===== */
  h1 {
    margin:10px 0;
    text-shadow:1px 1px 2px rgba(0,0,0,.7);
    font-size: 36px; /* 标题字体大小 */
  }
  p {
    margin:10px 0;
    text-shadow:1px 1px 2px rgba(0,0,0,.7);
    font-size: 28px; /* 正文字体大小 */
  }

  .btn{background:var(--acc);color:#000;border:0;border-radius:8px;padding:12px 70px;font-size:22px;cursor:pointer;margin:8px;font-weight:600}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .btn:hover{filter:brightness(1.05)}
  input{margin:8px;padding:10px;font-size:18px;border:2px solid var(--acc);border-radius:8px;background:#1e1e1e;color:#fff}
  .screen{position:absolute;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;text-align:center;padding:24px}
  .screen.active{display:flex}
  #stimulus{max-width:80%;height:60vh;display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);will-change:opacity,transform}
  #fixation{display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:64px;color:var(--acc)}
  .hint{position:absolute;font-size:24px;color:var(--acc);font-weight:600;background:rgba(30,30,30,.85);border:2px solid var(--acc);border-radius:10px;padding:10px 14px}
  .hint-left{left:8%;top:50%;transform:translateY(-50%);display:none}
  .hint-right{right:8%;top:50%;transform:translateY(-50%);display:none}
  #currentTypeLabel,#idealTypeLabel{font-size:26px;color:var(--acc);opacity:0;transition:opacity .2s;position:absolute;top:82%;left:50%;transform:translateX(-50%)}
  #practicePrompt{position:absolute;top:82%;left:50%;transform:translateX(-50%);color:var(--acc);display:none}
  .bar{width:66vw;max-width:900px;height:12px;background:#2a2a2a;border-radius:999px;overflow:hidden;margin-top:16px}
  .bar>span{display:block;height:100%;width:0;background:linear-gradient(90deg,#ffd54f,#ffcc00)}
  .muted{color:var(--muted);font-size:18px}
</style>
</head>
<body>

<!-- 指导语（首页） -->
<section id="guidelines" class="screen active">
  <h1>欢迎您参加本实验！</h1>
   <p>实验中，您将通过"F"键与"J"键来对呈现的体型胖瘦进行调整，直到符合相应体型。</p>
        <p>您可以通过长按或点击"F"键与"J"键来进行快速或精细的调整，</p>
        <p>调整完成后，按“回车键（Enter）”确认选择。</p>
  <p style="margin-top:6px">请选择您的性别</p>
  <div>
    <input id="studentId" placeholder="请输入学号" />
    <input id="subjectNumber" placeholder="请输手机号码后4位" />
  </div>
  <div>
    <button id="maleButton" class="btn">男性</button>
    <button id="femaleButton" class="btn">女性</button>
  </div>
  <div class="bar" style="margin-top:10px"><span id="preloadPg"></span></div>
  <p id="preloadTip" class="muted">等待选择性别开始预加载…</p>
  <button id="btnStartPractice" class="btn" disabled>进入练习</button>
  <p id="preloadTip" class="muted">请您耐心等待实验加载，若长时间未加载完成，可点击性别进行刷新或重新进入实验！</p>
  <p id="preloadTip" class="muted">注！！！请您一定准确填写您的学号，与手机号后4位，这将作为您的实验编码，以便于为您发放后续实验报酬，感谢您的配合！</p>
</section>

<!-- 练习/正式指导语 -->
<section id="practiceGuidelines" class="screen">
  <p>练习阶段（共 3 次）！</p>
        <p>您可以通过‘长按’ “F” 与 “J” 键，来进行体型的 ‘快速’ 调整，</p>
        <p>或通过‘点击’ “F” 与 “J” 键来对体型进行‘精细’ 调整。</p>
  <p>若您已经了解具体操作，按 <b>空格键</b> 开始练习！</p>
</section>

<section id="currentGuidelines" class="screen">
   <p>正式实验开始！</p>
        <p>“当前体型”调整任务（共10 次）！</p>
        <p>现在，您将通过"F"键与"J"键来调整出最接近您当前的体型。</p>
        <p>按“回车键（Enter）”确认保存调整结果，按“空格键”正式开始实验。</p>
</section>

<section id="idealGuidelines" class="screen">
   <p>“理想体型”调整任务（共10 次）！</p>
        <p>现在，您将通过"F"键与"J"键来调整您的理想体型。</p>
        <p>按“回车键（Enter）”确认保存调整结果，按“空格键”开始实验。</p>
</section>

<!-- 刺激层 -->
<img id="stimulus" alt="stimulus" decoding="async" loading="eager" fetchpriority="high">
<div id="fixation">+</div>
<div class="hint hint-left">长按“F”快速变瘦</div>
<div class="hint hint-right">长按“J”快速变胖</div>
<div id="currentTypeLabel"><p>调至与您<b>当前最相近</b>的体型，按 <b>Enter</b> 确认。</p></div>
<div id="idealTypeLabel"><p>调至您的<b>理想体型</b>，按 <b>Enter</b> 确认。</p></div>
<div id="practicePrompt" class="muted">熟悉后可按 <b>Enter</b> 结束本次练习</div>

<!-- 结束页与遮罩 -->
<section id="thankYou" class="screen">
  <p>请您备注好学号与手机号码后4位后，添加实验主试微信领取实验报酬！！！</p>
  <p>按下“ESC”后，关闭当前页面即可。</p>
  <h1>实验结束，感谢参与！</h1>
</section>

<div id="overlayUploading" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);color:#fff;z-index:9999;align-items:center;justify-content:center;flex-direction:column;">
  <div style="font-size:20px;margin-bottom:10px">正在上传数据，请稍候…</div>
  <div class="bar" style="width:300px"><span style="width:100%"></span></div>
</div>

<div id="overlayFailed" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);color:#fff;z-index:9999;align-items:center;justify-content:center;flex-direction:column;">
  <div style="font-size:20px;margin-bottom:12px">上传失败，请检查网络后重试</div>
  <button id="btnRetryUpload" class="btn">重试上传</button>
</div>

<!-- 引入 COS SDK -->
<script src="https://cdn.jsdelivr.net/npm/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js"></script>

<script>
/* ====== 改为 COS 上传所需常量 ====== */
const STS_URL    = 'https://bodyshape2025-8gk5msghc2121838-1373390636.ap-shanghai.app.tcloudbase.com/cos-sts-event';
const COS_BUCKET = 'bodyshape-data-1373390636';
const COS_REGION = 'ap-shanghai';

/* ===== 图片资源路径 ===== */
const IS_PROD   = location.hostname.endsWith('github.io');
const SITE_BASE = IS_PROD ? 'https://BodyImageLab.github.io/body-shape-experiment_xiaowu/' : './';
const BASE_URL_F = SITE_BASE + 'img_F/';
const BASE_URL_M = SITE_BASE + 'img_M/';

const MAX_F = 76, MAX_M = 76;
const F_EXT = 'png', M_EXT = 'png';
let F_LIST = [], M_LIST = [];

// 试次数/时序/频率
const PRACTICE_TRIALS = 3;
const CURRENT_TRIALS  = 10;
const IDEAL_TRIALS    = 10;
const FIX_MS = 800;
const HOLD_INTERVAL = 70;

/* ===== DOM/状态 ===== */
const screens = {
  guide: document.getElementById('guidelines'),
  pracG: document.getElementById('practiceGuidelines'),
  currG: document.getElementById('currentGuidelines'),
  idealG: document.getElementById('idealGuidelines'),
  thank: document.getElementById('thankYou')
};
const preloadPg = document.getElementById('preloadPg');
const preloadTip = document.getElementById('preloadTip');
const btnStartPractice = document.getElementById('btnStartPractice');
const maleBtn = document.getElementById('maleButton');
const femaleBtn = document.getElementById('femaleButton');

const stimulus = document.getElementById('stimulus');
const fixation = document.getElementById('fixation');
const hintL = document.querySelector('.hint-left');
const hintR = document.querySelector('.hint-right');
const labelCurrent = document.getElementById('currentTypeLabel');
const labelIdeal = document.getElementById('idealTypeLabel');
const practicePrompt = document.getElementById('practicePrompt');

const studentIdEl = document.getElementById('studentId');
const subjectNumberEl = document.getElementById('subjectNumber');

let gender = null, series = 'F', imgList = [];
let idx = 0, holdTimer = null, holdKey = null, adjusting = false, preloaded = false;
let practiceTrial = 0, currentTrial = 0, idealTrial = 0;
let currentStarts = [], idealStarts = [];
let t0 = 0, startIdx = 0, enterLocked = false, experimentStartTime = 0;
let taskType = '练习';
let results = [];
let sessionId = null;
let pendingIndex = null;

/* ===== 工具函数 ===== */
function enterFullscreen(){ const el=document.documentElement; if (el.requestFullscreen) el.requestFullscreen().catch(()=>{}); }
function showScreen(key){ Object.values(screens).forEach(s=>s.classList.remove('active')); screens[key].classList.add('active'); }
function genNames(prefix, n, ext){ const a=[]; for (let i=1;i<=n;i++) a.push(`${prefix}${i}.${ext}`); return a; }
function clamp(v,lo,hi){ return Math.min(hi, Math.max(lo,v)); }
function getSeriesURLs(which){
  if (which === 'M'){ const names = M_LIST.length ? M_LIST : genNames('M', MAX_M, M_EXT); return names.map(n => BASE_URL_M + n); }
  else { const names = F_LIST.length ? F_LIST : genNames('F', MAX_F, F_EXT); return names.map(n => BASE_URL_F + n); }
}

/* ===== 真·预加载 ===== */
async function preloadAll(urls){
  if (!urls.length) return;
  let done = 0, total = urls.length;
  const upd = ()=>{ preloadPg.style.width = ((done/total)*100).toFixed(1) + '%'; };
  for (const u of urls) {
    const im = new Image(); im.loading='eager'; im.decoding='async'; im.src=u;
    try { await im.decode(); } catch(e) {}
    done++; upd();
  }
}

/* ===== BMI 映射 ===== */
function bmiFromIndex(series, index){
  if (series === 'F'){ return +(10.8 + index * 0.432).toFixed(2); }
  else { return +(11.8 + index * 0.472).toFixed(2); }
}

/* ===== 呈现/索引 ===== */
function updateStimulus(){
  idx = clamp(idx, 0, imgList.length-1);
  stimulus.src = imgList[idx];
  stimulus.style.display = 'block';
  if (taskType === '练习'){
    hintL.style.display='block'; hintR.style.display='block';
    practicePrompt.style.display=(practiceTrial < PRACTICE_TRIALS)?'block':'none';
    labelCurrent.style.opacity=0; labelIdeal.style.opacity=0;
  } else {
    hintL.style.display='none'; hintR.style.display='none';
    practicePrompt.style.display='none';
    labelCurrent.style.opacity=(taskType==='当前体型')?1:0;
    labelIdeal.style.opacity=(taskType==='理想体型')?1:0;
  }
}
function showFix(){ stimulus.style.display='none'; labelCurrent.style.opacity=0; labelIdeal.style.opacity=0; hintL.style.display='none'; hintR.style.display='none'; practicePrompt.style.display='none'; fixation.style.display='block'; }
function hideFix(){ fixation.style.display='none'; }

/* ===== 记录一条试次 ===== */
function saveRow(){
  results.push({
    task_type: taskType,
    series,
    selected_image: imgList[idx] || '',
    index: idx,
    bmi: bmiFromIndex(series, idx),
    start_index: startIdx,
    response_time: new Date().toISOString(),
    response_duration_ms: Date.now() - t0,
    student_id: (studentIdEl.value||'').trim(),
    subject_number: (subjectNumberEl.value||'').trim(),
    gender
  });
}

/* ===== 长按快速步进 ===== */
function startHold(which){ stopHold(); const delta=(which==='f')?-1:+1; step(delta); holdKey=which; holdTimer=setInterval(()=>step(delta),HOLD_INTERVAL); }
function stopHold(){ if (holdTimer){ clearInterval(holdTimer); holdTimer=null; } holdKey=null; }
function step(delta){ if (!adjusting) return; idx = clamp(idx + delta, 0, imgList.length-1); pendingIndex = idx; }

/* ===== 渲染循环 ===== */
function renderLoop(){ if (pendingIndex !== null){ stimulus.src = imgList[pendingIndex]; pendingIndex = null; } requestAnimationFrame(renderLoop); }
renderLoop();

/* ===== 覆盖层控制 ===== */
function showUploadingOverlay(){ document.getElementById('overlayUploading').style.display='flex'; }
function hideUploadingOverlay(){ document.getElementById('overlayUploading').style.display='none'; }
function showUploadFailedOverlay(msg){
  const el = document.getElementById('overlayFailed'); el.style.display='flex';
  document.getElementById('btnRetryUpload').onclick = async ()=>{
    el.style.display='none'; showUploadingOverlay();
    try{ await uploadAllResults(); hideUploadingOverlay(); showScreen('thank'); }
    catch(e){ hideUploadingOverlay(); showUploadFailedOverlay(String(e)); }
  };
}

/* ===== 整场 payload ===== */
function buildPayload(){
  return { sessionId, pid: (studentIdEl.value||'').trim(), subjectNumber: (subjectNumberEl.value||'').trim(), gender, rows: results };
}

/* ===== 上传 ===== */
async function uploadAllResults(){
  const payload = buildPayload();
  const sts = await fetch(STS_URL).then(r=>r.json());
  if (!sts.ok) throw new Error(sts.error || 'Get STS failed');
  const cos = new COS({ getAuthorization: (options, cb) => cb({
      TmpSecretId:  sts.credentials.TmpSecretId,
      TmpSecretKey: sts.credentials.TmpSecretKey,
      SecurityToken: sts.credentials.Token,
      StartTime: Math.floor(Date.now()/1000) - 1,
      ExpiredTime: Math.floor(Date.now()/1000) + 600
    }) });
  const dateDir = new Date().toISOString().slice(0,10);
  const key = `sessions/${dateDir}/${payload.sessionId}.json`;
  await new Promise((resolve,reject)=>{
    cos.putObject({ Bucket: COS_BUCKET, Region: COS_REGION, Key: key,
      Body: new Blob([JSON.stringify(payload)], { type:'application/json' })
    }, (err,data)=>err?reject(err):resolve(data));
  });
  console.log('Uploaded to COS:', key);
  return key;
}

/* ===== 流程控制 ===== */
function startPracticeBlock(){ taskType='练习'; practiceTrial=0; showScreen('pracG'); }
function startCurrentBlock(){
  taskType='当前体型'; currentTrial=0;
  currentStarts = Array(5).fill(0).concat(Array(5).fill(imgList.length-1)).sort(()=>Math.random()-0.5);
  showScreen('currG');
}
function startIdealBlock(){
  taskType='理想体型'; idealTrial=0;
  idealStarts = Array(5).fill(0).concat(Array(5).fill(imgList.length-1)).sort(()=>Math.random()-0.5);
  showScreen('idealG');
}
function startTrial(){
  adjusting = true;
  document.body.classList.add('hide-cursor');
  stimulus.style.display='block';
  if (taskType==='练习'){
    idx = Math.floor(Math.random()*imgList.length);
  } else if (taskType==='当前体型'){
    idx = currentStarts[currentTrial];
  } else if (taskType==='理想体型'){
    idx = idealStarts[idealTrial];
  }
  startIdx = idx;
  updateStimulus();
  t0 = Date.now();
}

/* ===== 性别选择 ===== */
async function chooseGender(g){
  gender = (g==='M') ? 'Male' : 'Female';
  series = (g==='M') ? 'M' : 'F';
  enterFullscreen();
  preloadTip.textContent = `已选择：${gender==='Male'?'男性':'女性'}，开始预加载…`;
  imgList = getSeriesURLs(series);
  btnStartPractice.disabled = true;
  await preloadAll(imgList);
  preloaded = true;
  preloadTip.textContent = '预加载完成。现在可以进入练习。';
  btnStartPractice.disabled = false;
}

/* ===== 事件绑定 ===== */
maleBtn.addEventListener('click', ()=>chooseGender('M'));
femaleBtn.addEventListener('click', ()=>chooseGender('F'));

btnStartPractice.addEventListener('click', ()=>{
  if (!preloaded){ alert('请先等待预加载完成'); return; }
  if (!(studentIdEl.value && subjectNumberEl.value)){ alert('请先填写学号与被试序号'); return; }
  const d=new Date(), p=n=>(n<10?'0':'')+n;
  const ts = d.getFullYear()+''+p(d.getMonth()+1)+p(d.getDate())+p(d.getHours())+p(d.getMinutes())+p(d.getSeconds());
  sessionId = `${ts}_${(studentIdEl.value||'').trim()}_${(subjectNumberEl.value||'').trim()}`;
  experimentStartTime = Date.now();
  startPracticeBlock();
});

window.addEventListener('keydown',(e)=>{
  const k = e.key.toLowerCase();
  if (!adjusting){
    if (screens.pracG.classList.contains('active') && k===' '){ Object.values(screens).forEach(s=>s.classList.remove('active')); startTrial(); return; }
    if (screens.currG.classList.contains('active') && k===' '){ Object.values(screens).forEach(s=>s.classList.remove('active')); labelCurrent.style.opacity=1; startTrial(); return; }
    if (screens.idealG.classList.contains('active') && k===' '){ Object.values(screens).forEach(s=>s.classList.remove('active')); labelIdeal.style.opacity=1; startTrial(); return; }
  }
  if (adjusting){
    if (k==='f' || k==='j'){ if (holdKey!==k) startHold(k); }
    else if (k==='r'){ idx = startIdx; pendingIndex = idx; }
    else if (k==='enter'){
      if (enterLocked) return; enterLocked = true;
      saveRow(); showFix(); adjusting = false; stopHold();
      setTimeout(async ()=>{
        hideFix(); enterLocked = false;
        if (taskType==='练习'){
          practiceTrial++;
          if (practiceTrial < PRACTICE_TRIALS) startTrial();
          else startCurrentBlock();
        } else if (taskType==='当前体型'){
          currentTrial++;
          if (currentTrial < CURRENT_TRIALS) startTrial();
          else startIdealBlock();
        } else if (taskType==='理想体型'){
          idealTrial++;
          if (idealTrial < IDEAL_TRIALS) startTrial();
          else {
            stimulus.style.display='none';
            document.body.classList.remove('hide-cursor');
            showUploadingOverlay();
            try{ await uploadAllResults(); hideUploadingOverlay(); showScreen('thank'); }
            catch(err){ hideUploadingOverlay(); console.error('Upload failed:', err); showUploadFailedOverlay((err && err.message) ? err.message : String(err)); }
          }
        }
      }, FIX_MS);
    }
  }
});
window.addEventListener('keyup',(e)=>{ const k = e.key.toLowerCase(); if (k==='f' || k==='j') stopHold(); if (k==='enter') enterLocked = false; });

preloadTip.textContent = '等待选择性别开始预加载…';
</script>
</body>
</html>
