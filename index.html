<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>体型调整实验 · CloudBase 版（整场一次上传 + BMI + 防闪屏）</title>

<!-- 字体 -->
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

<!-- CloudBase SDK：先尝试官方 CDN，失败自动降级到 jsDelivr -->
<script src="https://imgcache.qq.com/qcloud/cloudbase-js-sdk/2.10.0/cloudbase.full.js"
        onerror="(function(){var s=document.createElement('script');s.src='https://cdn.jsdelivr.net/npm/@cloudbase/js-sdk@2.10.0/dist/cloudbase.full.min.js';document.head.appendChild(s);})();">
</script>
<script>
  // 加个提示：两条 CDN 都没成功的话给出警告
  window.addEventListener('load', function(){
    if (!window.cloudbase) {
      console.error('CloudBase SDK 未加载成功，请检查网络或更换打开方式（建议用本地HTTP服务或GitHub Pages）。');
      alert('CloudBase SDK 未加载成功：请确认联网、关闭拦截插件，或用本地HTTP服务/Pages打开页面。');
    }
  });
</script>

<style>
  :root { --bg:#121212; --txt:#e0e0e0; --acc:#ffcc00; --muted:#b9c0c7; }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--txt);font-family:'Roboto',ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Microsoft YaHei",sans-serif;overflow:hidden}
  body{display:flex;align-items:center;justify-content:center;padding:36px}
  .hide-cursor{cursor:none}
  h1,p{margin:10px 0;text-shadow:1px 1px 2px rgba(0,0,0,.7)}
  .btn{background:var(--acc);color:#000;border:0;border-radius:8px;padding:12px 22px;font-size:18px;cursor:pointer;margin:8px;font-weight:600}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .btn:hover{filter:brightness(1.05)}
  input{margin:8px;padding:10px;font-size:18px;border:2px solid var(--acc);border-radius:8px;background:#1e1e1e;color:#fff}
  .screen{position:absolute;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;text-align:center;padding:24px}
  .screen.active{display:flex}
  #stimulus{max-width:80%;height:60vh;display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);will-change:opacity,transform}
  #fixation{display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:64px;color:var(--acc)}
  .hint{position:absolute;font-size:24px;color:var(--acc);font-weight:600;background:rgba(30,30,30,.85);border:2px solid var(--acc);border-radius:10px;padding:10px 14px}
  .hint-left{left:8%;top:50%;transform:translateY(-50%);display:none}
  .hint-right{right:8%;top:50%;transform:translateY(-50%);display:none}
  #currentTypeLabel,#idealTypeLabel{font-size:26px;color:var(--acc);opacity:0;transition:opacity .2s;position:absolute;top:82%;left:50%;transform:translateX(-50%)}
  #practicePrompt{position:absolute;top:82%;left:50%;transform:translateX(-50%);color:var(--acc);display:none}
  .bar{width:66vw;max-width:900px;height:12px;background:#2a2a2a;border-radius:999px;overflow:hidden;margin-top:16px}
  .bar>span{display:block;height:100%;width:0;background:linear-gradient(90deg,#ffd54f,#ffcc00)}
  .muted{color:var(--muted);font-size:18px}
</style>
</head>
<body>

<!-- 指导语（首页） -->
<section id="guidelines" class="screen active">
  <h1>欢迎参加本实验</h1>
  <p>用 <b>F</b>/<b>J</b> 调整体型（长按快速、点按精细），按 <b>Enter</b> 确认保存。</p>
  <div>
    <input id="studentId" placeholder="请输入学号" />
    <input id="subjectNumber" placeholder="请输入被试序号" />
  </div>
  <p style="margin-top:6px">请选择您的性别（选择后将自动预加载）：</p>
  <div>
    <button id="maleButton" class="btn">男性</button>
    <button id="femaleButton" class="btn">女性</button>
  </div>
  <div class="bar" style="margin-top:10px"><span id="preloadPg"></span></div>
  <p id="preloadTip" class="muted">等待选择性别开始预加载…</p>
  <button id="btnStartPractice" class="btn" disabled>进入练习</button>
</section>

<!-- 练习/正式指导语 -->
<section id="practiceGuidelines" class="screen">
  <p>练习阶段：长按 “F/J” 快速调整，点按“F/J”精细调整。</p>
  <p>按 <b>空格键</b> 开始练习（共 3 次）。</p>
</section>

<section id="currentGuidelines" class="screen">
  <p>正式实验：<b>当前体型</b> 调整（10 次）</p>
  <p>调整至<b>最接近您当前</b>的体型，按 <b>Enter</b> 保存；按 <b>空格键</b> 开始。</p>
</section>

<section id="idealGuidelines" class="screen">
  <p>正式实验：<b>理想体型</b> 调整（10 次）</p>
  <p>调整至<b>您的理想体型</b>，按 <b>Enter</b> 保存；按 <b>空格键</b> 开始。</p>
</section>

<!-- 刺激层 -->
<img id="stimulus" alt="stimulus" decoding="async" loading="eager" fetchpriority="high">
<div id="fixation">+</div>
<div class="hint hint-left">长按“F”快速变瘦</div>
<div class="hint hint-right">长按“J”快速变胖</div>
<div id="currentTypeLabel"><p>调至与您<b>当前最相近</b>的体型，按 <b>Enter</b> 确认。</p></div>
<div id="idealTypeLabel"><p>调至您的<b>理想体型</b>，按 <b>Enter</b> 确认。</p></div>
<div id="practicePrompt" class="muted">熟悉后可按 <b>Enter</b> 结束本次练习</div>

<!-- 结束页与遮罩 -->
<section id="thankYou" class="screen">
  <h1>实验结束，感谢参与！</h1>
  <p>可关闭页面。</p>
</section>

<div id="overlayUploading" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);color:#fff;z-index:9999;align-items:center;justify-content:center;flex-direction:column;">
  <div style="font-size:20px;margin-bottom:10px">正在上传数据，请稍候…</div>
  <div class="bar" style="width:300px"><span style="width:100%"></span></div>
</div>

<div id="overlayFailed" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);color:#fff;z-index:9999;align-items:center;justify-content:center;flex-direction:column;">
  <div style="font-size:20px;margin-bottom:12px">上传失败，请检查网络后重试</div>
  <button id="btnRetryUpload" class="btn">重试上传</button>
</div>

<script>
/* ===== CloudBase 等待式初始化（已填你的环境ID） ===== */
let tcbApp = null;
function tcbDB(){ return tcbApp.database(); }

async function tcbBoot(){
  // 等 SDK 最多 3s
  const start = Date.now();
  while (!window.cloudbase && Date.now() - start < 3000){
    await new Promise(r=>setTimeout(r,100));
  }
  if (!window.cloudbase) throw new Error('CloudBase SDK 未就绪');

  // 初始化 + 匿名登录（持久化）
  const TCB_ENV_ID = 'bodyshape2025-8gk5msghc2121838';
  tcbApp = cloudbase.init({ env: TCB_ENV_ID });
  const auth = tcbApp.auth({ persistence: "local" });
  if (!auth.hasLoginState()) {
    await auth.anonymousAuthProvider().signIn();
  }
}

/* ===== 图片资源路径 ===== */
const IS_PROD   = location.hostname.endsWith('github.io');
const SITE_BASE = IS_PROD ? 'https://BodyImageLab.github.io/body-shape-experiment_xiaowu/' : './';
const BASE_URL_F = SITE_BASE + 'img_F/';
const BASE_URL_M = SITE_BASE + 'img_M/';

const MAX_F = 76, MAX_M = 76;
const F_EXT = 'png', M_EXT = 'png';
let F_LIST = []; // 留空即 F1..F76
let M_LIST = []; // 留空即 M1..M76

// 试次数/时序/频率
const PRACTICE_TRIALS = 3;
const CURRENT_TRIALS  = 10;
const IDEAL_TRIALS    = 10;
const FIX_MS = 800;
const HOLD_INTERVAL = 70;

/* ===== DOM/状态 ===== */
const screens = {
  guide: document.getElementById('guidelines'),
  pracG: document.getElementById('practiceGuidelines'),
  currG: document.getElementById('currentGuidelines'),
  idealG: document.getElementById('idealGuidelines'),
  thank: document.getElementById('thankYou')
};
const preloadPg = document.getElementById('preloadPg');
const preloadTip = document.getElementById('preloadTip');
const btnStartPractice = document.getElementById('btnStartPractice');
const maleBtn = document.getElementById('maleButton');
const femaleBtn = document.getElementById('femaleButton');

const stimulus = document.getElementById('stimulus');
const fixation = document.getElementById('fixation');
const hintL = document.querySelector('.hint-left');
const hintR = document.querySelector('.hint-right');
const labelCurrent = document.getElementById('currentTypeLabel');
const labelIdeal = document.getElementById('idealTypeLabel');
const practicePrompt = document.getElementById('practicePrompt');

const studentIdEl = document.getElementById('studentId');
const subjectNumberEl = document.getElementById('subjectNumber');

let gender = null;          // 'Female' | 'Male'
let series = 'F';           // 'F' | 'M'
let imgList = [];
let idx = 0, holdTimer = null, holdKey = null, adjusting = false, preloaded = false;
let practiceTrial = 0, currentTrial = 0, idealTrial = 0;
let t0 = 0, startIdx = 0, enterLocked = false, experimentStartTime = 0;
let taskType = '练习';
let results = []; // 整场数据
let sessionId = null; // 场次唯一ID

/* ===== 防闪屏补丁：下一帧统一换图 ===== */
let pendingIndex = null;

/* ===== 工具函数 ===== */
function enterFullscreen(){ const el=document.documentElement; if (el.requestFullscreen) el.requestFullscreen().catch(()=>{}); }
function showScreen(key){ Object.values(screens).forEach(s=>s.classList.remove('active')); screens[key].classList.add('active'); }
function genNames(prefix, n, ext){ const a=[]; for (let i=1;i<=n;i++) a.push(`${prefix}${i}.${ext}`); return a; }
function clamp(v,lo,hi){ return Math.min(hi, Math.max(lo,v)); }
function getSeriesURLs(which){
  if (which === 'M'){ const names = M_LIST.length ? M_LIST : genNames('M', MAX_M, M_EXT); return names.map(n => BASE_URL_M + n); }
  else { const names = F_LIST.length ? F_LIST : genNames('F', MAX_F, F_EXT); return names.map(n => BASE_URL_F + n); }
}

/* ===== 真·预加载：下载+解码 ===== */
async function preloadAll(urls){
  if (!urls.length) return;
  let done = 0, total = urls.length;
  const upd = ()=>{ preloadPg.style.width = ((done/total)*100).toFixed(1) + '%'; };
  for (const u of urls) {
    const im = new Image(); im.loading='eager'; im.decoding='async'; im.src=u;
    try { await im.decode(); } catch(e) {}
    done++; upd();
  }
}

/* ===== BMI 映射 ===== */
function bmiFromIndex(series, index){
  if (series === 'F'){ // F1 = 10.8, F76 = 43.2 → 步长 0.432
    return +(10.8 + index * 0.432).toFixed(2);
  } else {             // M1 = 11.8, M76 = 47.2 → 步长 0.472
    return +(11.8 + index * 0.472).toFixed(2);
  }
}

/* ===== 呈现/索引 ===== */
function updateStimulus(){
  if (!imgList.length) return;
  idx = clamp(idx, 0, imgList.length-1);
  stimulus.src = imgList[idx];
  stimulus.style.display = 'block';
  if (taskType === '练习'){
    hintL.style.display='block'; hintR.style.display='block'; practicePrompt.style.display=(practiceTrial < PRACTICE_TRIALS)?'block':'none';
    labelCurrent.style.opacity=0; labelIdeal.style.opacity=0;
  } else {
    hintL.style.display='none'; hintR.style.display='none'; practicePrompt.style.display='none';
    labelCurrent.style.opacity=(taskType==='当前体型')?1:0; labelIdeal.style.opacity=(taskType==='理想体型')?1:0;
  }
}
function showFix(){ stimulus.style.display='none'; labelCurrent.style.opacity=0; labelIdeal.style.opacity=0; hintL.style.display='none'; hintR.style.display='none'; practicePrompt.style.display='none'; fixation.style.display='block'; }
function hideFix(){ fixation.style.display='none'; }
function nextStartEdge(){ return (Math.random()<0.5)? 0 : (imgList.length-1); }

/* ===== 记录一条试次 ===== */
function saveRow(){
  const row = {
    task_type: taskType,                 // 练习 / 当前体型 / 理想体型
    series,                              // F / M
    selected_image: imgList[idx] || '',
    index: idx,
    bmi: bmiFromIndex(series, idx),
    start_index: startIdx,
    response_time: new Date().toISOString(),
    response_duration_ms: Date.now() - t0,
    student_id: (studentIdEl.value||'').trim(),
    subject_number: (subjectNumberEl.value||'').trim(),
    gender
  };
  results.push(row);
}

/* ===== 长按快速步进（不立刻换图，交给渲染循环） ===== */
function startHold(which){ stopHold(); const delta=(which==='f')?-1:+1; step(delta); holdKey=which; holdTimer=setInterval(()=>step(delta),HOLD_INTERVAL); }
function stopHold(){ if (holdTimer){ clearInterval(holdTimer); holdTimer=null; } holdKey=null; }
function step(delta){
  if (!adjusting) return;
  idx = clamp(idx + delta, 0, imgList.length-1);
  pendingIndex = idx; // 等下一帧统一切图
}

/* ===== 渲染循环：一帧最多切一次图 ===== */
function renderLoop(){
  if (pendingIndex !== null){
    stimulus.src = imgList[pendingIndex];
    pendingIndex = null;
  }
  requestAnimationFrame(renderLoop);
}
renderLoop();

/* ===== 流程控制 ===== */
function startPracticeBlock(){ taskType='练习'; practiceTrial=0; showScreen('pracG'); }
function startCurrentBlock(){ taskType='当前体型'; currentTrial=0; showScreen('currG'); }
function startIdealBlock(){ taskType='理想体型'; idealTrial=0; showScreen('idealG'); }
function startTrial(){
  adjusting = true;
  document.body.classList.add('hide-cursor');
  stimulus.style.display='block';
  idx = (taskType==='练习') ? Math.floor(Math.random()*imgList.length) : nextStartEdge();
  startIdx = idx; updateStimulus(); t0 = Date.now();
}

/* ===== 覆盖层控制 ===== */
function showUploadingOverlay(){ document.getElementById('overlayUploading').style.display='flex'; }
function hideUploadingOverlay(){ document.getElementById('overlayUploading').style.display='none'; }
function showUploadFailedOverlay(msg){
  const el = document.getElementById('overlayFailed'); el.style.display='flex';
  document.getElementById('btnRetryUpload').onclick = async ()=>{
    el.style.display='none'; showUploadingOverlay();
    try{ await uploadAllResults(); hideUploadingOverlay(); showScreen('thank'); }
    catch(e){ hideUploadingOverlay(); showUploadFailedOverlay(String(e)); }
  };
}

/* ===== 构造整场 payload ===== */
function buildPayload(){
  return {
    sessionId,
    pid: (studentIdEl.value||'').trim(),
    subjectNumber: (subjectNumberEl.value||'').trim(),
    gender,
    rows: results
  };
}

/* ===== CloudBase 上传（去重 + 均值 + 分批写） ===== */
const mean = arr => arr.length ? +(arr.reduce((x,y)=>x+y,0)/arr.length).toFixed(3) : null;

async function uploadAllResults(){
  // 确保 SDK 就绪 + 已匿名登录
  await tcbBoot();
  const db = tcbDB();

  const payload = buildPayload();
  const { sessionId, pid, subjectNumber, gender, rows } = payload;

  // 去重：同一 sessionId 不重复写
  const exist = await db.collection('logs').where({ session_id: sessionId }).get();
  if (exist.data.length) return;

  const nowISO = new Date().toISOString();
  const curBMIs   = rows.filter(r=>r.task_type==='当前体型').map(r=>r.bmi);
  const idealBMIs = rows.filter(r=>r.task_type==='理想体型').map(r=>r.bmi);

  // 1) logs（整场一条）
  await db.collection('logs').add({
    ts: nowISO,
    session_id: sessionId,
    pid, subjectNumber, gender,
    rows_json: rows,
    mean_bmi_current: mean(curBMIs),
    mean_bmi_ideal:  mean(idealBMIs)
  });

  // 2) trials（逐试次，分批写）
  const batch = 50;
  for (let i=0; i<rows.length; i+=batch){
    const chunk = rows.slice(i, i+batch).map(r => ({
      session_id: sessionId,
      session_ts: nowISO,
      pid, subjectNumber, gender,
      block: r.task_type,
      series: r.series,
      image_name: (r.selected_image||'').split('/').pop(),
      index0: r.index,
      bmi: r.bmi,
      rt_ms: r.response_duration_ms,
      trial_end_iso: r.response_time
    }));
    await db.collection('trials').add(chunk);
  }
}

/* ===== 性别选择 → 自动预载 ===== */
async function chooseGender(g){
  gender = (g==='M') ? 'Male' : 'Female';
  series = (g==='M') ? 'M' : 'F';
  enterFullscreen();
  preloadTip.textContent = `已选择：${gender==='Male'?'男性':'女性'}，开始预加载…`;
  imgList = getSeriesURLs(series);
  btnStartPractice.disabled = true;
  await preloadAll(imgList);
  preloaded = true;
  preloadTip.textContent = '预加载完成。现在可以进入练习。';
  btnStartPractice.disabled = false;
}

/* ===== 事件绑定 ===== */
maleBtn.addEventListener('click', ()=>chooseGender('M'));
femaleBtn.addEventListener('click', ()=>chooseGender('F'));

btnStartPractice.addEventListener('click', ()=>{
  if (!preloaded){ alert('请先等待预加载完成'); return; }
  if (!(studentIdEl.value && subjectNumberEl.value)){ alert('请先填写学号与被试序号'); return; }
  // 生成本场 sessionId：YYYYMMDDhhmmss_pid_sn
  const d=new Date(), p=n=>(n<10?'0':'')+n;
  const ts = d.getFullYear()+''+p(d.getMonth()+1)+p(d.getDate())+p(d.getHours())+p(d.getMinutes())+p(d.getSeconds());
  sessionId = `${ts}_${(studentIdEl.value||'').trim()}_${(subjectNumberEl.value||'').trim()}`;

  experimentStartTime = Date.now();
  startPracticeBlock();
});

window.addEventListener('keydown', (e)=>{
  const k = e.key.toLowerCase();

  if (!adjusting){
    if (screens.pracG.classList.contains('active') && k===' '){
      Object.values(screens).forEach(s=>s.classList.remove('active')); startTrial(); return;
    }
    if (screens.currG.classList.contains('active') && k===' '){
      Object.values(screens).forEach(s=>s.classList.remove('active')); labelCurrent.style.opacity=1; labelIdeal.style.opacity=0; startTrial(); return;
    }
    if (screens.idealG.classList.contains('active') && k===' '){
      Object.values(screens).forEach(s=>s.classList.remove('active')); labelCurrent.style.opacity=0; labelIdeal.style.opacity=1; startTrial(); return;
    }
  }

  if (adjusting){
    if (k==='f' || k==='j'){ if (holdKey!==k) startHold(k); }
    else if (k==='r'){ idx = startIdx; pendingIndex = idx; } // 重置到起点
    else if (k==='enter'){
      if (enterLocked) return; enterLocked = true;

      saveRow(); showFix(); adjusting = false; stopHold();

      setTimeout(async ()=>{
        hideFix(); enterLocked = false;

        if (taskType==='练习'){
          practiceTrial++;
          if (practiceTrial < PRACTICE_TRIALS) startTrial();
          else startCurrentBlock();
        } else if (taskType==='当前体型'){
          currentTrial++;
          if (currentTrial < CURRENT_TRIALS) startTrial();
          else startIdealBlock();
        } else if (taskType==='理想体型'){
          idealTrial++;
          if (idealTrial < IDEAL_TRIALS) startTrial();
          else {
            // —— 完成最后一个“理想体型”试次：整场上传 ——
            stimulus.style.display='none';
            document.body.classList.remove('hide-cursor');
            showUploadingOverlay();
            try{
              await uploadAllResults();
              hideUploadingOverlay();
              showScreen('thank');
            }catch(err){
              hideUploadingOverlay();
              showUploadFailedOverlay(String(err));
            }
          }
        }
      }, FIX_MS);
    }
  }
});

window.addEventListener('keyup',(e)=>{
  const k = e.key.toLowerCase();
  if (k==='f' || k==='j') stopHold();
  if (k==='enter') enterLocked = false;
});

/* 初始提示 */
preloadTip.textContent = '等待选择性别开始预加载…';
</script>
</body>
</html>
