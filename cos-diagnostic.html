<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>COS 上传诊断页</title>
<style>
  body{font:16px/1.6 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Microsoft YaHei",sans-serif;padding:20px}
  button{padding:10px 16px;font-size:16px;border-radius:8px;border:0;background:#1e80ff;color:#fff;cursor:pointer}
  pre{background:#111;color:#eee;padding:12px;border-radius:8px;white-space:pre-wrap;word-break:break-all}
</style>
</head>
<body>
<h2>腾讯云 COS 上传诊断</h2>
<p>点击下面的按钮将依次测试：1）获取 STS；2）上传一个测试文件到 COS。</p>
<p><b>当前页面 Origin：</b> <code id="origin"></code></p>
<p><button id="btn">开始诊断</button></p>
<pre id="log"></pre>

<!-- COS SDK -->
<script src="https://cdn.jsdelivr.net/npm/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js"></script>
<script>
  // ===== 按你的实际情况填写 =====
  const STS_URL    = 'https://bodyshape2025-8gk5msghc2121838-1373390636.ap-shanghai.app.tcloudbase.com/cos-sts-event';
  const COS_BUCKET = 'bodyshape-data-1373390636';
  const COS_REGION = 'ap-shanghai';

  const $log = document.getElementById('log');
  const $btn = document.getElementById('btn');
  document.getElementById('origin').textContent = location.origin;

  function log(...args){
    console.log(...args);
    $log.textContent += args.map(x => typeof x==='string'? x : JSON.stringify(x,null,2)).join(' ') + '\n';
  }

  async function run(){
    try{
      $log.textContent = '';
      log('== 1) 取 STS ==');
      log('STS_URL =', STS_URL);

      const resp = await fetch(STS_URL, { mode:'cors', cache:'no-store' });
      log('STS 响应状态 =', resp.status);
      log('STS 允许跨域 =', resp.headers.get('access-control-allow-origin'));
      const bodyText = await resp.text();
      log('STS 原始响应 =', bodyText.slice(0,2000)); // 截断避免太长
      let sts;
      try { sts = JSON.parse(bodyText); } catch(e){ throw new Error('STS 响应不是 JSON，无法解析'); }
      if (!sts.ok) throw new Error('STS 返回 ok=false: ' + (sts.error || 'unknown'));

      log('== 2) 用 STS 初始化 COS ==');
      const cos = new COS({
        getAuthorization: (options, cb) => cb({
          TmpSecretId:  sts.credentials.TmpSecretId,
          TmpSecretKey: sts.credentials.TmpSecretKey,
          SecurityToken: sts.credentials.Token,
          StartTime: Math.floor(Date.now()/1000) - 1,
          ExpiredTime: Math.floor(Date.now()/1000) + 600
        })
      });

      log('== 3) 上传测试对象到 COS ==');
      const key = `diagnostics/test-${Date.now()}.txt`;
      const body = new Blob([`Hello COS! Time=${new Date().toISOString()}\nOrigin=${location.origin}\n`], {type: 'text/plain'});

      await new Promise((resolve, reject)=>{
        cos.putObject({
          Bucket: COS_BUCKET,
          Region: COS_REGION,
          Key: key,
          Body: body
        }, (err, data)=> err ? reject(err) : resolve(data));
      });

      log('上传成功 ✅');
      log('Bucket =', COS_BUCKET);
      log('Region =', COS_REGION);
      log('Key    =', key);
      log('\n请到 COS 控制台查看对象是否写入成功。');

    }catch(e){
      log('❌ 诊断失败：', e && e.message ? e.message : e);
    }
  }

  $btn.addEventListener('click', run);
</script>
</body>
</html>
