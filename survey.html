<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>问卷填写 · 沿用实验样式（淡黄磨砂 + 粒子）</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
  :root{
    /* —— 与实验页一致的主题变量 —— */
    --bg-grad-1:#1a1a1a; --bg-grad-2:#22201c; --bg-grad-3:#26231f;
    --txt:#e9e7e4; --muted:#bfc4c9;
    --acc:#f2c14e; --acc-2:#ffd86b;

    --panel-bg: rgba(30,30,30,.38);
    --panel-blur: 16px;
    --panel-saturate: 145%;
    --panel-radius: 16px;
    --panel-pad: 32px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;color:var(--txt);font-family:'Roboto',ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Microsoft YaHei",sans-serif;
    background:
      radial-gradient(1200px 700px at 20% 0%, rgba(255,207,92,.06), transparent 65%),
      radial-gradient(1000px 700px at 80% 100%, rgba(255,207,92,.05), transparent 60%),
      linear-gradient(180deg, var(--bg-grad-1), var(--bg-grad-2) 40%, var(--bg-grad-3));
  }

  /* 全局粒子画布（沿用实验页） */
  #fxCanvas{position:fixed; inset:0; z-index:-1; pointer-events:none}

  /* 玻璃面板容器：改为可滚动，适配电脑屏（宽屏居中） */
  .panel{
    position: fixed; inset: 0; display:flex; align-items:flex-start; justify-content:center;
    background: var(--panel-bg);
    backdrop-filter: blur(var(--panel-blur)) saturate(var(--panel-saturate));
    -webkit-backdrop-filter: blur(var(--panel-blur)) saturate(var(--panel-saturate));
    padding: clamp(18px, 3vw, 36px);
    overflow-y:auto; /* 关键：表单较长时滚动 */
  }

  /* 顶部区：标题 + 进度 */
  .shell{width:min(1100px, 92vw)}
  .card{
    background:rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.14);
    border-radius:18px; box-shadow:0 18px 42px rgba(0,0,0,.35), inset 0 1px rgba(255,255,255,.2);
  }
  .hd{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:16px 18px; border-bottom:1px solid rgba(255,255,255,.12)}
  .title{display:flex; align-items:center; gap:10px; font-size:22px; font-weight:800}
  .badge{font-size:14px;background:linear-gradient(180deg,var(--acc-2),var(--acc)); color:#2b1f08; padding:6px 10px; border-radius:999px; font-weight:800}
  .desc{margin:0; color:#f3f3f3; opacity:.9; font-size:14px}

  .bd{padding:18px}
  .bar{width:100%;height:12px;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,.10);box-shadow:inset 0 2px 6px rgba(0,0,0,.45)}
  .bar>span{display:block;height:100%;width:0;background:linear-gradient(90deg,#ffe082,#ffc107 30%,#ffca28 70%,#ffd54f)}

  /* 步骤条（注意：此处的 .step 专用于步骤条视觉，不再用于表单分步容器） */
  .stepper{display:flex; gap:10px; flex-wrap:wrap}
  .step{flex:1; min-width:220px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:10px; display:flex; align-items:center; gap:10px}
  .step i{width:26px; height:26px; border-radius:50%; background:#23252e; color:#ffe59a; display:grid; place-items:center; font-weight:900}
  .step.active{border-color:#ffd86b; box-shadow:0 0 0 3px rgba(242,193,78,.22)}
  .step.active i{background:linear-gradient(180deg,var(--acc-2),var(--acc)); color:#2b1f08}

  /* 表单控件（沿用实验的输入框风格） */
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:14px}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} }
  label{font-weight:700; display:block; margin:2px 0 6px}
  .tip{font-size:12px; color:var(--muted)}

  input[type="text"], input[type="number"], input[type="email"], select, textarea{
    margin:0; padding:12px 14px; font-size:16px; width:100%;
    border:1.5px solid rgba(255,255,255,.16); border-radius:12px;
    background:rgba(255,255,255,.06); color:#fff; outline:none;
    transition:.2s border-color,.2s box-shadow,.2s background;
  }
  textarea{min_height:120px; resize:vertical}
  input::placeholder, textarea::placeholder{ color:#d7d7d7; opacity:.75 }
  input:focus, select:focus, textarea:focus{
    border-color:var(--acc);
    box-shadow:0 0 0 3px rgba(242,193,78,.18);
    background:rgba(255,255,255,.08);
  }

  /* 题组卡片 */
  .qcard{margin-top:14px}
  .qcard .bd>section{padding:10px 0}
  .q{margin:10px 0}
  .opts{display:flex; gap:12px; flex-wrap:wrap}
  .radio{display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border:1px solid rgba(255,255,255,.12); border-radius:10px; background:rgba(255,255,255,.04)}

  /* —— 逐题下方评分样式 —— */
  .likert{display:block;}
  .q-list{display:grid; gap:14px;}
  .q-item{
    background:rgba(255,255,255,.04);
    border:1px solid rgba(255,255,255,.12);
    border-radius:12px;
    padding:12px;
  }
  .q-text{font-weight:700; line-height:1.6; margin-bottom:10px}
  .scale-row{
    display:flex; gap:8px; flex-wrap:nowrap; justify-content:space-between;
  }
  .pill{position:relative; display:inline-block}
  .pill input{
    position:absolute; inset:0; width:100%; height:100%; opacity:0; cursor:pointer;
  }
  .pill span{
    display:grid; place-items:center;
    min-width:40px; padding:8px 0;
    border-radius:10px;
    border:1px solid rgba(255,255,255,.18);
    background:rgba(255,255,255,.05);
    font-weight:800;
    user-select:none;
  }
  .pill input:focus + span{ box-shadow:0 0 0 3px rgba(242,193,78,.22); border-color:var(--acc); }
  .pill input:checked + span{
    background:linear-gradient(180deg, var(--acc-2), var(--acc));
    border-color:transparent; color:#2b1f08;
    box-shadow:0 8px 18px rgba(242,193,78,.15), inset 0 1px rgba(255,255,255,.35);
  }
  .anchors{display:flex; justify-content:space-between; font-size:12px; color:#var(--muted); margin-top:6px; padding:0 2px}

  /* 操作区按钮沿用 .btn */
  .actions{display:flex; gap:10px; justify-content:flex-end; padding:14px; border-top:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.04); border-radius:0 0 18px 18px}
  .btn{position:relative; overflow:hidden; background:linear-gradient(180deg, var(--acc-2), var(--acc)); color:#2b1f08; border:0; border-radius:14px; padding:12px 20px; font-size:16px; cursor:pointer; font-weight:800; box-shadow:0 8px 18px rgba(242,193,78,.15), inset 0 1px rgba(255,255,255,.35); transition:.18s transform ease, .18s filter ease, .18s box-shadow ease}
  .btn[disabled]{opacity:.55;cursor:not-allowed}
  .btn:hover{filter:brightness(1.05); transform:translateY(-1px)}
  .btn:active{transform:translateY(0)}
  .btn.ghost{background:rgba(255,255,255,.06); color:#f7f7f7; border:1px solid rgba(255,255,255,.14)}

  .err{color:#ff7676; font-size:13px; margin-top:6px; display:none}
  .ok{color:#9deabf; font-size:13px}
  .footer{color:var(--muted); text-align:center; font-size:12px; padding:14px}

  @media print{ .panel{position:relative; inset:auto; background:#fff; backdrop-filter:none} #fxCanvas, .actions, .stepper, .bar, .footer{display:none!important} .card{break-inside:avoid} body{background:#fff} }
  /* 让某个栅格项横跨两列 */
  .grid .span-2{ grid-column: 1 / -1; }
  /* 紧凑型步骤条：放在进度条下的小胶囊 */
  .stepper-compact{
    display:flex; gap:8px; flex-wrap:wrap;
    align-items:center; justify-content:flex-start;
    margin-top:10px;
  }
  .stepper-compact .step{
    flex:0 0 auto;
    min-width:auto;
    padding:6px 10px;
    border-radius:10px;
    background:rgba(255,255,255,.05);
    border:1px solid rgba(255,255,255,.10);
  }
  .stepper-compact .step i{ width:20px; height:20px; font-size:12px; }
  .stepper-compact .step div{ font-size:14px; }
  .stepper-compact .step.active{
    border-color:#ffd86b;
    box-shadow:0 0 0 2px rgba(242,193,78,.20);
  }
  @media (max-width:600px){
    .stepper-compact .step div{ display:none; }
  }
  /* 圆点评分：小圆圈 + 下方文字 */
  .scale-row{ display:flex; justify-content:space-between; gap:10px; flex-wrap:nowrap; }
  .dot{
    position:relative; display:flex; flex-direction:column; align-items:center; gap:6px;
    width:68px;
  }
  .dot input{ position:absolute; inset:0; opacity:0; cursor:pointer; }
  .dot .circle{
    width:44px; height:44px; border-radius:999px; display:grid; place-items:center;
    border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.06); font-weight:800;
  }
  .dot input:focus + .circle{ box-shadow:0 0 0 3px rgba(242,193,78,.22); border-color:var(--acc); }
  .dot input:checked + .circle{
    background:linear-gradient(180deg,var(--acc-2),var(--acc)); color:#2b1f08;
    border-color:transparent; box-shadow:0 8px 18px rgba(242,193,78,.15), inset 0 1px rgba(255,255,255,.35);
  }
  .dot em{
    font-style:normal; font-size:12px; color:#var(--muted); text-align:center; line-height:1.15;
  }

  @media (max-width:980px){
    .dot{ width:56px }
    .dot .circle{ width:40px; height:40px }
    .scale-row{ gap:6px }
  }
  /* === Likert 紧凑版（小圆圈 + 小卡片） === */
  .q-list{ gap:10px; }
  .q-item{ padding:8px 10px; border-radius:10px; }
  .q-text{ margin-bottom:6px; line-height:1.45; }

  /* 小圆圈尺寸（原：44/68） */
  .scale-row{ gap:8px; }
  .dot{ width:72px; }
  .dot .circle{ width:32px; height:32px; font-size:14px; }
  .dot em{ font-size:14px; }

  @media (max-width:980px){
    .dot{ width:48px; }
    .dot .circle{ width:32px; height:32px; font-size:13px; }
    .scale-row{ gap:6px; }
  }

  /* 修正“民族”下拉框在弹出列表中对白底白字的问题 */
  select { color:#fff; }
  select option,
  select optgroup{
    color:#1a1a1a !important;
    background:#ffffff !important;
    text-shadow:none !important;
  }
  select optgroup{ font-weight:700; }
  select option:checked{
    background:#ffe082 !important;
    color:#1a1a1a !important;
  }
  select:required:invalid{ color:var(--muted); }

  /* === 新增：未作答高亮样式 === */
  .missing{
    border-color:#ff7676 !important;
    box-shadow:0 0 0 3px rgba(255,118,118,.25) !important;
  }
  .q-item.missing{
    border-color:rgba(255,118,118,.9) !important;
  }
  /* 提交成功卡片更高 & 居中 */
#result .bd{
  min-height: 45vh;          /* 想更高就调大：例如 60vh */
  display:flex;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  padding:28px;
}
#download-json,
#download-csv,
#print-pdf,
#result .bd .tip{
  display:none !important;
}
/* === 只改题目为黄色；评分数字与说明保持白色 === */
:root{
  --q-color:#ffd86b;          /* 题目黄 */
  --q-size-label:16px;        /* 基本信息题目字号 */
  --q-size-qtext:20px;        /* 量表题干字号 */
}

/* Step 1 基本信息里的题目（输入框上方那行） */
.qcard.step-sec[data-step="1"] .bd .grid > div > label{
  color: var(--q-color);
  font-size: var(--q-size-label);
}

/* 各量表题干（renderLikertList 生成的 .q-text） */
.q-text{
  color: var(--q-color);
  font-size: var(--q-size-qtext);
}

/* 保证评分数字与说明为白色（未选/选中都白） */
.dot .circle,
.dot em{
  color: var(--txt);
}
.dot input:checked + .circle{
  color: var(--txt); /* 覆盖原先选中时变深色的规则 */
}

/* 避免把“男/女”等选项文字染黄 */
label.radio{ color: var(--txt); }

</style>
</head>
<body>
  <canvas id="fxCanvas" aria-hidden="true"></canvas>
  <div class="panel">
    <div class="shell">
     <!-- 顶部：标题与进度条 -->
<div class="card">
  <div class="hd">
    <div class="title"><span class="badge">BODY IMAGE</span> 调查问卷</div>
    <div id="formId" class="tip">表单ID：—</div>
  </div>
  <div class="bd">
    <p class="desc">同学们好，欢迎参加本次问卷调查！答案无对错，我们只想了解你最真实的情况。</p>
    <div class="bar" aria-label="填写进度"><span id="pg" style="width:0%"></span></div>

    <!-- 新：紧贴进度条下的小步骤条 -->
    <div id="stepper" class="stepper stepper-compact"></div>
  </div>
</div>


      <!-- 表单主体（多步骤） -->
      <form id="form" novalidate>

        <!-- Step 1：基本信息（由原第 3 步前移） -->
        <section class="card qcard step-sec" data-step="1">
          <div class="hd"><div class="title" style="font-size:18px"><span class="badge" style="font-size:12px">STEP 1</span> 基本信息</div></div>
          <div class="bd">
            <div class="grid">
              <div>
                <label for="age">1. 年龄<span style="color:#ffd86b">*</span></label>
                <!-- 修改：两位数字 -->
                <input id="age" name="age" type="text" inputmode="numeric"
                       placeholder="例如 20" required minlength="2" maxlength="2" pattern="^\d{2}$" />
                <div class="err" data-err="age">必填</div>
              </div>
              <div>
                <label>7. 性别<span style="color:#ffd86b">*</span></label>
                <div class="opts">
                  <label class="radio"><input type="radio" name="gender" value="男" required>男</label>
                  <label class="radio"><input type="radio" name="gender" value="女">女</label>
                </div>
                <div class="err" data-err="gender">必选</div>
              </div>
              <div>
                <label for="major">2. 专业<span style="color:#ffd86b">*</span></label>
                <!-- 修改：仅中文 + 关闭浏览器自动补全 -->
                <input id="major" name="major" type="text" placeholder="例如 心理学" required
                       pattern="^[\u4E00-\u9FFF·\s]+$" autocomplete="off" />
                <div class="err" data-err="major">必填</div>
                <!-- 新增：英文/非中文输入法提示 -->
                <div class="tip" id="majorHint" style="display:none;color:#ffd86b">
                  当前为英文/非中文输入，无法录入。请切换到中文输入法（按 <kbd>Shift</kbd> 或“中/英”键）。
                </div>
              </div>
              <div>
                <label>9. 独生子女<span style="color:#ffd86b">*</span></label>
                <div class="opts">
                  <label class="radio"><input type="radio" name="onlyChild" value="是" required>是</label>
                  <label class="radio"><input type="radio" name="onlyChild" value="否">否</label>
                </div>
                <div class="err" data-err="onlyChild">必选</div>
              </div>
              
              <div>
                <label for="studentId">3. 学号<span style="color:#ffd86b">*</span></label>
                <!-- 修改：严格 11 位数字 -->
                <input id="studentId" name="studentId" type="text" placeholder="请准确输入11位学号" required
                       inputmode="numeric" minlength="11" maxlength="11" pattern="^\d{11}$" />
                <div class="err" data-err="studentId">必填</div>
              </div>
              <div>
                <label>8. 生源地<span style="color:#ffd86b">*</span></label>
                <div class="opts">
                  <label class="radio"><input type="radio" name="origin" value="城镇" required>城镇</label>
                  <label class="radio"><input type="radio" name="origin" value="农村">农村</label>
                </div>
                <div class="err" data-err="origin">必选</div>
              </div>

              <!-- ⇩⇩⇩ 仅此处修改：改为“长栏”单输入，自动格式化为 1.75M ⇩⇩⇩ -->
              <div>
                <label for="height">4. 身高（m）<span style="color:#ffd86b">*</span></label>
                <input id="height" name="height_cm" type="text" inputmode="numeric"
                       placeholder="例如 1.75" required />
                <div class="err" data-err="height_cm">必填</div>
              </div>
              <!-- ⇧⇧⇧ 仅此处修改 ⇧⇧⇧ -->

              <div>
                <label>11. 年级<span style="color:#ffd86b">*</span></label>
                <div class="opts">
                  <label class="radio"><input type="radio" name="grade" value="大一" required>大一</label>
                  <label class="radio"><input type="radio" name="grade" value="大二">大二</label>
                  <label class="radio"><input type="radio" name="grade" value="大三">大三</label>
                  <label class="radio"><input type="radio" name="grade" value="大四">大四</label>
                  <label class="radio"><input type="radio" name="grade" value="研究生">研究生</label>
                </div>
                <div class="err" data-err="grade">必选</div>
              </div>

              <!-- ⇩⇩⇩ 仅此处修改：改为“长栏”单输入，自动格式化为 45.20KG ⇩⇩⇩ -->
              <div>
                <label for="weight">5. 体重（kg）<span style="color:#ffd86b">*</span></label>
                <input id="weight" name="weight_kg" type="text" inputmode="numeric"
                       placeholder="例如 45.20" required />
                <div class="err" data-err="weight_kg">必填</div>
              </div>
              <!-- ⇧⇧⇧ 仅此处修改 ⇧⇧⇧ -->

              <div>
  <label for="ethnicity">10. 民族<span style="color:#ffd86b">*</span></label>
  <select id="ethnicity" name="ethnicity" required>
    <option value="">请选择</option>
    <option>汉族</option>
    <optgroup label="少数民族">
      <option>壮族</option><option>回族</option><option>满族</option><option>维吾尔族</option>
      <option>苗族</option><option>彝族</option><option>土家族</option><option>蒙古族</option>
      <option>藏族</option><option>布依族</option><option>侗族</option><option>瑶族</option>
      <option>朝鲜族</option><option>白族</option><option>哈尼族</option><option>哈萨克族</option>
      <option>黎族</option><option>傣族</option><option>畲族</option><option>傈僳族</option>
      <option>仡佬族</option><option>东乡族</option><option>高山族</option><option>拉祜族</option>
      <option>水族</option><option>佤族</option><option>纳西族</option><option>羌族</option>
      <option>土族</option><option>仫佬族</option><option>锡伯族</option><option>柯尔克孜族</option>
      <option>达斡尔族</option><option>景颇族</option><option>毛南族</option><option>撒拉族</option>
      <option>布朗族</option><option>塔吉克族</option><option>阿昌族</option><option>普米族</option>
      <option>鄂温克族</option><option>怒族</option><option>京族</option><option>基诺族</option>
      <option>德昂族</option><option>保安族</option><option>俄罗斯族</option><option>裕固族</option>
      <option>乌孜别克族</option><option>门巴族</option><option>鄂伦春族</option><option>独龙族</option>
      <option>赫哲族</option><option>塔塔尔族</option>
    </optgroup>
  </select>
  <div class="err" data-err="ethnicity">必选</div>
</div>
              <div class="span-2">
                <label for="email">6. 邮箱（可选）</label>
                <input id="email" name="email" type="email" placeholder="xxxxxxxxxx@xxx.com" />
              </div>
            </div>
            <p class="tip">说明：请如实填写个人基本信息；学号仅用于研究记录与报酬发放，不对外展示。</p>
          </div>
          <div class="actions">
            <button type="button" class="btn" data-next>下一步 →</button>
          </div>
        </section>

        <!-- Step 2：特质感恩（原第 1 步顺延） -->
        <section class="card qcard step-sec" data-step="2" hidden>
          <div class="hd">
            <div class="title" style="font-size:18px">
              <span class="badge" style="font-size:12px">STEP 2</span>
              以下是你对生活中人、事、物的情感深浅的体验，请您选出最符合自己的选项作答即可。1=完全不同意，7=完全同意。
            </div>
          </div>
          <div class="bd">
            <div class="likert" id="blockD"></div>
            <p class="tip">注意力检查：第 7 题请选第 4 个选项。</p>
          </div>
          <div class="actions">
            <button type="button" class="btn ghost" data-prev>← 上一步</button>
            <button type="button" class="btn" data-next>下一步 →</button>
          </div>
        </section>

        <!-- Step 3：体重偏见内化量表（原第 2 步顺延） -->
        <section class="card qcard step-sec" data-step="3" hidden>
          <div class="hd">
            <div class="title" style="font-size:18px">
              <span class="badge" style="font-size:12px">STEP 3</span>
              下列是一些对于自身行为的看法和感觉，请你仔细阅读每一个问题，对照自己与每一项的符合程度，尽量快速如实地回答。
            </div>
          </div>
          <div class="bd">
            <div class="likert" id="blockWB"></div>
            <p class="tip">说明：请根据您的真实感受作答。</p>
          </div>
          <div class="actions">
            <button type="button" class="btn ghost" data-prev>← 上一步</button>
            <button type="button" class="btn" data-next>下一步 →</button>
          </div>
        </section>

        <!-- Step 4：身体监控量表（7点，8题） -->
        <section class="card qcard step-sec" data-step="4" hidden>
          <div class="hd">
            <div class="title" style="font-size:18px">
              <span class="badge" style="font-size:12px">STEP 4</span>
              请认真阅读下面每个条目，并选择其陈述与您的实际情况最为相符的选项。
            </div>
          </div>
          <div class="bd">
            <div class="likert" id="blockBM"></div>
          </div>
          <div class="actions">
            <button type="button" class="btn ghost" data-prev>← 上一步</button>
            <button type="button" class="btn" data-next>下一步 →</button>
          </div>
        </section>

        <!-- Step 5：身体欣赏（5点，10题）→ 最后提交 -->
        <section class="card qcard step-sec" data-step="5" hidden>
          <div class="hd"><div class="title" style="font-size:18px"><span class="badge" style="font-size:12px">STEP 5</span> 请认真阅读下面每个条目，并选择其陈述与您的实际情况最为相符的选项。</div></div>
          <div class="bd">
            <div class="likert" id="blockB"></div>
          </div>
          <div class="actions">
            <button type="button" class="btn ghost" data-prev>← 上一步</button>
            <button type="submit" class="btn">提交问卷</button>
          </div>
        </section>
      </form>

      <!-- 提交结果 -->
      <div id="result" class="card qcard" hidden>
        <div class="hd"><div class="title" style="font-size:18px"><span class="badge" style="font-size:12px">DONE</span> 提交成功</div></div>
        <div class="bd" style="text-align:center">
          <p>🎉 感谢你的填写，实验结束！🎉</p>
          <p> 请您备注好学号与手机号码后4位后，添加实验主试微信领取实验报酬！！！</p>
          <p> 按下“ESC”后，关闭当前页面即可。</p>
          <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:10px">
            <button id="download-json" class="btn ghost">下载 JSON</button>
            <button id="download-csv" class="btn ghost">下载 CSV</button>
            <button id="print-pdf" class="btn ghost">打印/另存为 PDF</button>
          </div>
          <p class="tip" style="margin-top:10px">如需上传到服务器，可在脚本顶部配置 <code>SUBMIT_ENDPOINT</code>。</p>
        </div>
      </div>

      <div class="footer">© 2025 问卷 · 沿用实验样式（淡黄磨砂 + 粒子） · 自动保存草稿 · CSV/JSON 导出</div>
    </div>
  </div>

<!-- ✅ 引入 COS SDK（与实验页一致） -->
<script src="https://cdn.jsdelivr.net/npm/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js"></script>

<script>
// ✅ 是否被嵌在 iframe 中（实验页里）
const IS_EMBEDDED = (window.top !== window.self);

// ========== 1) 配置 ==========
const FORM_ID = (()=>{ const d=new Date(); return 'Q-' + d.toISOString().replace(/[-:TZ.]/g,'').slice(0,14) + '-' + Math.random().toString(36).slice(2,6).toUpperCase(); })();
const SUBMIT_ENDPOINT = 'survey.html';// 可填入你的后端 URL
const DRAFT_KEY = 'survey-draft-experimentstyle-v1';

// ✅ 由问卷页“自己”上传（与实验同库）
const UPLOAD_BY_PARENT = false;

// ✅ COS（与实验页保持一致的目标存储）
const STS_URL    = 'https://bodyshape2025-8gk5msghc2121838-1373390636.ap-shanghai.app.tcloudbase.com/cos-sts-event';
const COS_BUCKET = 'bodyshape-data-1373390636';
const COS_REGION = 'ap-shanghai';

/* ✅ 接收/缓存“实验数据” */
let __expData = null;
function loadExperimentData(){
  if (__expData) return __expData;
  const keys = [`experiment:${FORM_ID}`, `exp:${FORM_ID}`, 'experiment_data', 'exp_data'];
  for(const k of keys){
    const raw = sessionStorage.getItem(k) || localStorage.getItem(k);
    if(raw){ try{ __expData = JSON.parse(raw);}catch(_){ __expData = raw;} return __expData; }
  }
  return null;
}
window.addEventListener('message', (e)=>{
  try{
    const msg = e.data || {};
    if(!msg || typeof msg!=='object') return;
    if(msg.type==='EXPERIMENT_DATA' || msg.type==='EXPERIMENT_DONE' || msg.type==='EXP_DATA'){
      __expData = msg.payload ?? msg.data ?? msg.result ?? null;
      try{ sessionStorage.setItem(`experiment:${FORM_ID}`, JSON.stringify(__expData)); }catch(_){}
    }
  }catch(_){}
});

// 量表题库（保持不变）
const SCALE_A = {
  title:'下面是您对当前身体形象的情感体验，请选出最符合自己的选项。',
  labels:['非常不满意','不满意','比较不满意','一般','比较满意','满意','非常满意'],
  items:[
    '现在这一刻，我对自己的外貌感觉。',
    '现在这一刻，我对自己的体型感觉。',
    '现在这一刻，我对自己的体重感觉。',
    '现在这一刻，我对自己的身体吸引力感觉。',
    '现在这一刻，我感觉我比平时看起来。',
    '现在这一刻，我感觉比一般人看起来。'
  ]
};
const SCALE_B = {
  title:'请认真阅读下面每个条目，并选择其陈述与您的实际情况最为相符的选项（身体欣赏）。',
  labels:['绝不','很少','有时','经常','总是'],
  items:[
    '我尊重自己的身体。','我自觉我的身材还算不错。','我觉得我的身材有些还算不错的地方。',
    '我对我的身材抱有正面的态度。','我关注我的身体所需。','我喜欢我的身体。',
    '我欣赏我自己所拥有独特和不同的体型。','我用正面的态度对待我的身体。例如：抬高头和对人微笑。',
    '我安逸于自己的体型。','虽然我不像媒体上的人物那么吸引（例如模特、演员），但我仍然觉得自己美丽。'
  ]
};
const SCALE_C = {
  title:'根据您的真实感受程度，在以下问题中选出您认为最贴切的选项（内感受性知觉）。',
  labels:['完全不符合','相当不符合','有些不符合','一般符合','有些符合','相当符合','完全符合'],
  items:[
    '我注意到身体对各种食物的反应方式有所不同。','当我撞到自己时，我总能知道它是否会变成瘀伤。',
    '我总是知道自己锻炼到什么程度第二天会感到酸痛。','当我吃某些食物时，我总是知道我的能量水平变化。',
    '当我快要得流感时，我会提前知道。','我不需要测量体温就知道自己在发烧。',
    '我可以分辨饥饿引起的疲劳和缺乏睡眠引起的疲劳。','我可以准确地预测一天中什么时间会发困。',
    '我知道自己一整天的活动水平有一个周期。','我无法通过身体运作方式注意到季节性的节律和周期。',
    '我早上一醒来就知道自己这一天将有多少精力。','当我上床睡觉时，就能知道那天晚上会睡得多好。',
    '当我疲劳时，我注意到明显的身体反应。','我注意到身体对天气变化的特殊反应。',
    '我能预测我晚上需要多少睡眠第二天才能神清气爽地起床。','当我的锻炼习惯改变时，我能非常准确地预测这将如何影响我的精力水平。',
    '我晚上似乎有一个最佳的睡觉时间。','我注意到身体对过度饥饿的特殊反应。'
  ]
};
const SCALE_D = {
  title:'以下是你对生活中人、事、物的情感深浅体验（特质感恩）。1=完全不同意，7=完全同意。',
  labels:['完全不同意','相当不同意','有些不同意','不确定','有些同意','相当同意','完全同意'],
  items:[
    '我生活里实在有太多值得我感激的。','如果要把所有我想感谢的都记下来，这个记录将会很长。',
    '环顾这个世界，我没有找到什么是值得我多谢的。','对于很多不同的人我都心存感激。',
    '我发觉随着年龄的增长，我越懂得欣赏我生活中的人，事情和处境。','我可以经过一段很长时间，都没有感觉要向任何人或事致谢谢。','本题请选择第四个选项。'
  ]
};
/* 身体监控量表 */
const SCALE_BM = {
  title:'请阅读每个条目，并选择与您实际情况最相符的选项（身体监控）。',
  labels:['完全不符合','相当不符合','有些不符合','一般符合','有些符合','相当符合','完全符合'],
  items:[
    '我很少关注自己的外表看起来怎样','对我而言，衣服穿着舒适要比穿起来是否好看更重要',
    '与身体（外表）看起来如何相比，我更关注（注重）身体内部的感觉（如冷，饿）',
    '我很少将自己的外表与他人进行比较','我每天会多次想起自己（的外表）看起来怎样',
    '我经常担忧穿着的衣服是否让自己看起来好看','我很少担忧自己在别人眼中看起来怎样',
    '与外表看起来如何相比，我更关注我的身体能做什么（例如，耐力如何，力量如何）'
  ]
};
/* 体重偏见内化量表 */
const SCALE_WB = {
  title:'下列是一些对于自身行为的看法和感觉（体重偏见内化）。请快速、如实作答。',
  labels:['完全不符合','相当不符合','有些不符合','不确定','有些同意','相当同意','完全同意'],
  items:[
    '作为一个超重的人，我觉得我和其他人一样有能力。','因为我的体重，我没有其他人有吸引力。',
    '因为人们对我的看法，我对超重感到焦虑。','我希望我能彻底改变我的体重。','每当我想到很多关于超重的事时，我就会感到沮丧。',
    '我讨厌自己超重。','我的体重是我判断我作为一个人的价值的主要方式。','我觉得只要我超重，我就不值得拥有真正充实的社会生活。',
    '我的体重还可以。','因为我超重，我感觉这不像真实的自己。','因为我的体重，我不明白有什么有魅力的人会想和我约会。'
  ]
};

// ========== 2) 粒子背景 ==========
(function mountFX(){
  const cvs = document.getElementById('fxCanvas');
  const ctx = cvs.getContext('2d');
  const DPR = Math.min(2, window.devicePixelRatio || 1);
  let W=0,H=0, t=0, bubbles=[];
  function resize(){ W=cvs.width=innerWidth*DPR; H=cvs.height=innerHeight*DPR; cvs.style.width=innerWidth+'px'; cvs.style.height=innerHeight+'px'; init(); }
  function init(){ const n=90; bubbles.length=0; for(let i=0;i<n;i++){ const z=Math.random(); const r=(6+20*z)*DPR; const x=Math.random()*W; const y=Math.random()*H; const vy=(-.2-1.2*z)*DPR; const hue=40+15*z; bubbles.push({x,y,r,vy,z,hue,tw:Math.random()*Math.PI*2}); } }
  function frame(){ t+=0.005; ctx.clearRect(0,0,W,H);
    for(const b of bubbles){
      b.y+=b.vy*(.7+.3*Math.sin(b.tw+t*2));
      if(b.y+b.r<0){ b.y=H+b.r; b.x=Math.random()*W; }
      ctx.save(); ctx.globalCompositeOperation='lighter';
      const g=ctx.createRadialGradient(b.x, b.y, b.r*0.1, b.x, b.y, b.r);
      g.addColorStop(0, `hsla(${b.hue},85%,70%,.45)`);
      g.addColorStop(.6, `hsla(${b.hue+10},85%,65%,.12)`);
      g.addColorStop(1,'rgba(0,0,0,0)');
      ctx.fillStyle=g; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill();
      ctx.restore();
    }
    requestAnimationFrame(frame);
  }
  addEventListener('resize', resize); resize(); frame();
})();

// ========== 3) 表单渲染与逻辑 ==========
const $ = s=>document.querySelector(s); const $$ = s=>Array.from(document.querySelectorAll(s));
/* ✅ 步骤顺序：1(基本信息)→2(特质感恩)→3(体重偏见内化)→4(身体监控)→5(身体欣赏) */
const steps = [1,2,3,4,5]; let current=1; const pgEl=$('#pg'); const stepper=$('#stepper'); const form=$('#form'); const result=$('#result');
$('#formId').textContent = '表单ID：'+FORM_ID;

function renderStepper(){
  stepper.innerHTML = steps.map((s,i)=>`<div class="step ${current===s?'active':''}"><i>${i+1}</i><div>第 ${i+1} 步</div></div>`).join('');
}
function setProgress(){ const pct=Math.round((steps.indexOf(current)+1)/steps.length*100); pgEl.style.width=pct+'%'; renderStepper(); }
function showStep(n){
  current=n;
  document.querySelectorAll('section.step-sec').forEach(sec=>sec.hidden = Number(sec.dataset.step)!==n);
  setProgress(); window.scrollTo({top:0,behavior:'smooth'});
}

/** 逐题下方评分渲染 */
function renderLikertList(containerId, prefix, labels, items){
  const wrap = document.getElementById(containerId);
  const list = document.createElement('div');
  list.className = 'q-list';

  items.forEach((text, idx)=>{
    const name = `${prefix}${idx+1}`;
    const item = document.createElement('div');
    item.className = 'q-item';

    const q = document.createElement('div');
    q.className = 'q-text';
    q.textContent = `${idx+1}. ${text}`;
    item.appendChild(q);

    const row = document.createElement('div');
    row.className = 'scale-row';

    labels.forEach((lab, i)=>{
      const lbl = document.createElement('label');
      lbl.className = 'dot';
      lbl.title = `${i+1}：${lab}`;
      lbl.innerHTML = `
        <input type="radio" name="${name}" value="${i+1}" ${i===0?'required':''} aria-label="${lab}">
        <span class="circle">${i+1}</span>
        <em>${lab}</em>
      `;
      row.appendChild(lbl);
    });

    item.appendChild(row);

    /* ✅ 每题就地错误提示（默认隐藏） */
    const miss = document.createElement('div');
    miss.className = 'err';
    miss.dataset.err = name;
    miss.textContent = '请作答此题';
    item.appendChild(miss);

    list.appendChild(item);
  });

  wrap.innerHTML = '';
  const tip = document.createElement('p');
  tip.className = 'tip'; tip.style.margin = '0 0 8px 0';
  tip.textContent = '请在每题下方选择最符合您情况的数字（每个数字下方附有文字说明）。';
  wrap.appendChild(tip);
  wrap.appendChild(list);
}

// 渲染题组（逐题下方评分）
renderLikertList('blockD','D', SCALE_D.labels, SCALE_D.items);       // Step 2
renderLikertList('blockWB','WB', SCALE_WB.labels, SCALE_WB.items);   // Step 3
renderLikertList('blockBM','BM', SCALE_BM.labels, SCALE_BM.items);   // Step 4
renderLikertList('blockB','B', SCALE_B.labels, SCALE_B.items);       // Step 5

/* === 新增：Step1 实时输入过滤（确保键入即合规） === */
(function enforceInputs(){
  const age = document.getElementById('age');
  const major = document.getElementById('major');
  const majorHint = document.getElementById('majorHint');
  const sid = document.getElementById('studentId');
  let majorComposing = false;
  const showMajorHint = (show)=>{ if(majorHint) majorHint.style.display = show ? 'block' : 'none'; };

  if (age){
    age.addEventListener('input', ()=>{
      age.value = age.value.replace(/\D/g,'').slice(0,2); // 只留数字，最多2位
    });
    age.addEventListener('blur', ()=>{
      if (age.value){
        let n = parseInt(age.value,10);
        if (isNaN(n)) return;
        if (n < 10) n = 10;
        if (n > 99) n = 99;
        age.value = String(n).padStart(2,'0').slice(-2);
      }
    });
  }

  if (major){
    // 合成开始：拼音/五笔候选期间不改动内容
    major.addEventListener('compositionstart', ()=>{ majorComposing = true; });
    // 合成结束：统一过滤一次
    major.addEventListener('compositionend', ()=>{
      majorComposing = false;
      major.value = major.value.replace(/[^\u4E00-\u9FFF·\s]/g,'');
      showMajorHint(false);
    });
    // 普通输入：非合成期才过滤，并尽量保持光标
    major.addEventListener('input', (e)=>{
      if (e.isComposing || majorComposing) return;
      const before = major.value;
      const selStart = major.selectionStart, selEnd = major.selectionEnd;
      const filtered = before.replace(/[^\u4E00-\u9FFF·\s]/g,'');
      if (filtered !== before){
        major.value = filtered;
        const diff = before.length - filtered.length;
        const pos = Math.max(0, (selStart ?? filtered.length) - diff);
        try{ major.setSelectionRange(pos, pos); }catch(_){}
        showMajorHint(true);
      }else{
        showMajorHint(false);
      }
    });
    major.addEventListener('blur', ()=> showMajorHint(false));
  }

  if (sid){
    sid.addEventListener('input', ()=>{
      sid.value = sid.value.replace(/\D/g,'').slice(0,11); // 只留数字，最多11位
    });
  }

  /* === 新增：身高/体重自动格式化（长栏内保持当前数字输入方式） === */
  // 身高：3 位数字 => X.YZ
  const height = document.getElementById('height');
  if (height){
    const fmtH = (digits)=>{
      digits = String(digits || '').replace(/\D/g,'').slice(0,3);
      if(!digits) return '';
      let s = digits[0];
      if(digits.length >= 2) s += '.' + digits.slice(1);
      return s ;
    };
    height.addEventListener('input', ()=>{
      const raw = height.value.replace(/\D/g,'');
      height.value = fmtH(raw);
    });
    height.addEventListener('blur', ()=>{
      const raw = height.value.replace(/\D/g,'').slice(0,3);
      if(raw) height.value = fmtH(raw);
    });
  }

  // 体重：4 位数字 => XY.ZW
  const weight = document.getElementById('weight');
  if (weight){
    const fmtW = (digits)=>{
      digits = String(digits || '').replace(/\D/g,'').slice(0,4);
      if(!digits) return '';
      if(digits.length <= 2) return digits;
      return digits.slice(0,2) + '.' + digits.slice(2) ;
    };
    weight.addEventListener('input', ()=>{
      const raw = weight.value.replace(/\D/g,'');
      weight.value = fmtW(raw);
    });
    weight.addEventListener('blur', ()=>{
      const raw = weight.value.replace(/\D/g,'').slice(0,4);
      if(raw) weight.value = fmtW(raw);
    });
  }
})();

/* ✅ 增强版校验（红框高亮 + 就地提示 + 自动滚到第一处漏答） */
function validateStep(n){
  const sec = document.querySelector(`section.step-sec[data-step="${n}"]`);
  let ok = true;
  let firstMiss = null;

  // 清理旧状态
  sec.querySelectorAll('.missing').forEach(el=>el.classList.remove('missing'));
  sec.querySelectorAll('.err').forEach(el=>el.style.display='none');

  // 1) 文本/数字/下拉/多行（非单选组）
  const singles = sec.querySelectorAll('input[required]:not([type=radio]):not([type=checkbox]), select[required], textarea[required]');
  singles.forEach(ctrl=>{
    const v = (ctrl.value||'').trim() !== '';
    if(!v){
      ok = false;
      if(!firstMiss) firstMiss = ctrl;
      ctrl.classList.add('missing');
      const errEl = sec.querySelector(`[data-err="${ctrl.name||ctrl.id}"]`);
      if(errEl) errEl.style.display = 'block';
    }
  });

  /* === 新增：仅 Step 1 的硬性规则 === */
  if (n === 1){
    const age = sec.querySelector('#age');
    if (age){
      const v = (age.value||'').trim();
      if (!/^\d{2}$/.test(v) || +v < 10 || +v > 99){
        ok = false;
        if(!firstMiss) firstMiss = age;
        age.classList.add('missing');
        const errEl = sec.querySelector('[data-err="age"]');
        if (errEl){ errEl.textContent = '请输入两位数字（10–99）'; errEl.style.display = 'block'; }
      }
    }

    const major = sec.querySelector('#major');
    if (major){
      const v = (major.value||'').trim();
      if (!/^[\u4E00-\u9FFF·\s]+$/.test(v)){
        ok = false;
        if(!firstMiss) firstMiss = major;
        major.classList.add('missing');
        const errEl = sec.querySelector('[data-err="major"]');
        if (errEl){ errEl.textContent = '专业仅限中文字符'; errEl.style.display = 'block'; }
      }
    }

    const sid = sec.querySelector('#studentId');
    if (sid){
      const v = (sid.value||'').trim();
      if (!/^\d{11}$/.test(v)){
        ok = false;
        if(!firstMiss) firstMiss = sid;
        sid.classList.add('missing');
        const errEl = sec.querySelector('[data-err="studentId"]');
        if (errEl){ errEl.textContent = '学号需为 11 位数字'; errEl.style.display = 'block'; }
      }
    }

    /* === 新增：身高/体重的格式校验 === */
    const heightCtrl = sec.querySelector('#height');
    if (heightCtrl){
      const v = (heightCtrl.value || '').trim();
      if (!/^\d\.\d{2}$/.test(v)){
        ok = false;
        if(!firstMiss) firstMiss = heightCtrl;
        heightCtrl.classList.add('missing');
        const errEl = sec.querySelector('[data-err="height_cm"]');
        if (errEl){ errEl.textContent = '请输入 3 位数字（形如 1.75M）'; errEl.style.display = 'block'; }
      }
    }

    const weightCtrl = sec.querySelector('#weight');
    if (weightCtrl){
      const v = (weightCtrl.value || '').trim();
      if (!/^\d{2}\.\d{2}$/.test(v)){
        ok = false;
        if(!firstMiss) firstMiss = weightCtrl;
        weightCtrl.classList.add('missing');
        const errEl = sec.querySelector('[data-err="weight_kg"]');
        if (errEl){ errEl.textContent = '请输入 4 位数字（形如 45.20KG）'; errEl.style.display = 'block'; }
      }
    }
  }

  // 2) 单选题组（Likert & 基本信息单选）
  const radioNames = new Set(Array.from(sec.querySelectorAll('input[type=radio][name]')).map(x=>x.name));
  radioNames.forEach(name=>{
    const group = sec.querySelectorAll(`input[type=radio][name="${name}"]`);
    const answered = Array.from(group).some(x=>x.checked);
    if(!answered){
      ok = false;
      if(!firstMiss) firstMiss = group[0];

      const err1 = sec.querySelector(`[data-err="${name}"]`);
      if(err1) err1.style.display = 'block';

      const qi = group[0].closest('.q-item');
      if(qi){
        qi.classList.add('missing');
        const err2 = sec.querySelector(`.err[data-err="${name}"]`);
        if(err2) err2.style.display = 'block';
      }
    }
  });

  if(!ok && firstMiss){
    firstMiss.scrollIntoView({behavior:'smooth', block:'center'});
  }
  return ok;
}

$$('[data-next]').forEach(b=>b.addEventListener('click',()=>{ if(!validateStep(current)) return; const i=steps.indexOf(current); if(i<steps.length-1) showStep(steps[i+1]); }));
$$('[data-prev]').forEach(b=>b.addEventListener('click',()=>{ const i=steps.indexOf(current); if(i>0) showStep(steps[i-1]); }));

// 序列化 & 草稿
function serialize(){
  const data = { __meta:{formId:FORM_ID, submittedAt:new Date().toISOString(), ua:navigator.userAgent} };
  const fd = new FormData(form); const multi={};
  for(const [k,v] of fd.entries()){ if(multi[k]){ if(!Array.isArray(data[k])) data[k]=[]; data[k].push(v); } else { if(data[k]!==undefined){ if(!Array.isArray(data[k])) data[k]=[data[k]]; data[k].push(v);} else data[k]=v; } }
  return data;
}
function saveDraft(){ try{ localStorage.setItem(DRAFT_KEY, JSON.stringify(serialize())); }catch(e){} }
function loadDraft(){ try{
  const raw=localStorage.getItem(DRAFT_KEY); if(!raw) return;
  const data=JSON.parse(raw);
  for(const k in data){
    if(k==='__meta') continue;
    const val=data[k];
    if(Array.isArray(val)){
      val.forEach(v=>{ const el=form.querySelector(`[name="${k}"][value="${v}"]`); if(el) el.checked=true; });
    } else {
      const el=form.querySelector(`[name="${k}"]`);
      if(el){
        if(el.type==='radio'||el.type==='checkbox'){ const rb=form.querySelector(`[name="${k}"][value="${val}"]`); rb && (rb.checked=true); }
        else el.value=val;
      }
    }
  }
}catch(e){} }
form.addEventListener('input', ()=>{ clearTimeout(window.__draft); window.__draft = setTimeout(saveDraft, 600); });

/* ✅ 作答变更即清除该题的错误显示/红框 */
document.addEventListener('change', (e)=>{
  const t = e.target;
  if(!t.name) return;
  const sec = t.closest('section.step-sec');
  const key = t.type === 'radio' ? t.name : (t.name || t.id);
  const err = sec && sec.querySelector(`[data-err="${key}"]`);
  if(err) err.style.display = 'none';

  if(t.type === 'radio'){
    const qi = t.closest('.q-item');
    if(qi) qi.classList.remove('missing');
  }else{
    t.classList.remove('missing');
  }
});

/* ========== ✅ 与 COS 的统一上传（保留原函数，不改动逻辑，但提交时不再调用） ========== */
function getSessionIdFromCombined(combined){
  const exp = combined && combined.experiment;
  return (exp && (exp.sessionId || exp.pid)) || ('SURVEY_' + FORM_ID);
}
async function uploadCombinedToCOS(combined){
  const sts = await fetch(STS_URL).then(r=>r.json());
  if (!sts || !sts.ok) throw new Error((sts && sts.error) || 'Get STS failed');
  const cos = new COS({
    getAuthorization: (options, cb) => cb({
      TmpSecretId:  sts.credentials.TmpSecretId,
      TmpSecretKey: sts.credentials.TmpSecretKey,
      SecurityToken: sts.credentials.Token,
      StartTime: Math.floor(Date.now()/1000) - 1,
      ExpiredTime: Math.floor(Date.now()/1000) + 600
    })
  });
  const dateDir = new Date().toISOString().slice(0,10);
  const sid = getSessionIdFromCombined(combined);
  const key = `sessions/${dateDir}/${sid}_combined.csv`;
  const surveyObj = (combined && combined.survey) ? combined.survey : serialize();
  const csvText = '\ufeff' + toCSV(surveyObj);
  await new Promise((resolve,reject)=>{
    cos.putObject({
      Bucket: COS_BUCKET,
      Region: COS_REGION,
      Key: key,
      Body: new Blob([csvText], { type:'text/csv;charset=utf-8' })
    }, (err,data)=> err ? reject(err) : resolve(data));
  });
  console.log('Uploaded combined CSV to COS:', key);
  return key;
}

// 提交
form.addEventListener('submit', async (e)=>{
  e.preventDefault(); if(!validateStep(current)) return;

  // 注意力检查：特质感恩第 7 题必须选 4
  const attn = form.querySelector('input[name="D7"]:checked');
  if(!attn || attn.value !== '4'){ alert('注意力检查未通过：请将“特质感恩”第 7 题选择第 4 个选项。'); return; }

  const data = serialize();

  /* 缓存问卷数据（可选） */
  try{
    sessionStorage.setItem('survey:'+FORM_ID, JSON.stringify(data));
    sessionStorage.setItem('survey_last_form_id', FORM_ID);
  }catch(_e){}

  /* 告知父页：问卷完成（若嵌入在实验页可用） */
  parent.postMessage({type:'SURVEY_DONE', payload: data}, '*');

  /* ✅ 新增：把整张问卷转成 answers[]，并把 experiment + survey 一起回传父页面
     —— 父页面会用 makeCsvWide() 把问卷字段并入“同一行宽表”并上传。 */
  const exp = loadExperimentData(); // 可能为 null

  /* ✅ 新增：从表单构建 answers 数组（qid 为控件 name；answer 为值） */
  function buildAnswersFromForm(formEl){
    const answers = [];
    const seen = new Set();
    const add = (qid, answer, label, question) => {
      answers.push({ qid, answer, label: label || '', question: question || '' });
    };
    const elements = formEl.querySelectorAll('input, textarea, select');
    elements.forEach(el => {
      const name = el.name?.trim();
      if (!name) return;
      if (seen.has(name)) return;
      seen.add(name);

      if (el.type === 'radio') {
        const checked = formEl.querySelector(`input[type="radio"][name="${CSS.escape(name)}"]:checked`);
        add(name, checked ? checked.value : '');
      } else if (el.type === 'checkbox') {
        const checkedAll = Array.from(formEl.querySelectorAll(`input[type="checkbox"][name="${CSS.escape(name)}"]:checked`)).map(i => i.value);
        add(name, checkedAll.join('|'));
      } else if (el.tagName === 'SELECT') {
        if (el.multiple) {
          const vals = Array.from(el.selectedOptions).map(o=>o.value);
          add(name, vals.join('|'));
        } else {
          add(name, el.value ?? '');
        }
      } else {
        add(name, el.value ?? '');
      }
    });
    return answers;
  }

  const answers = buildAnswersFromForm(form);

  /* ✅ 修改：不在问卷页自行上传合并文件；改为把 payload 发给父页，
     由父页现有 uploadCombined() 生成“单行合并 CSV”并上传。 */
  parent.postMessage({
    type: 'SURVEY_READY_TO_UPLOAD',
    payload: {
      experiment: exp ?? null,
      survey: { answers }
    }
  }, '*');

  // ===== 下载按钮等保持原样 =====
  document.getElementById('download-json').onclick = ()=>{
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=FORM_ID + '.json'; a.click(); URL.revokeObjectURL(a.href);
  };
  document.getElementById('download-csv').onclick = ()=>{
    const csv = toCSV(data); const blob = new Blob([csv], {type:'text/csv;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=FORM_ID + '.csv'; a.click(); URL.revokeObjectURL(a.href);
  };
  document.getElementById('print-pdf').onclick = ()=> window.print();

  localStorage.removeItem(DRAFT_KEY);

  form.hidden = true;
  result.hidden = false;
  current = steps[steps.length-1]; setProgress();
  window.scrollTo({top:0, behavior:'smooth'});
});

// CSV 工具：把扁平的问卷数据导出
function toCSV(obj){
  const flat = {...obj}; delete flat.__meta;
  const keys = Object.keys(flat);
  const head = ['__meta.formId','__meta.submittedAt', ...keys];
  const row = [FORM_ID, new Date().toISOString(), ...keys.map(k=>{
    const v = flat[k]; const s = Array.isArray(v)? v.join('; ') : (v ?? ''); return '"'+String(s).replace(/"/g,'""')+'"';
  })];
  return head.join(',') + "\n" + row.join(',');
}

// 初始化
loadDraft(); renderStepper(); showStep(1);
</script>
</body>
</html>
