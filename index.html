<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å®éªŒç½‘ç»œç¤¾åŒº Â· å…¬å¼€æƒ…å¢ƒ UIï¼ˆè“é’ä¸»é¢˜ Â· ç´§å‡‘ç‰ˆ + å®éªŒåµŒå¥—ï¼‰</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
  /* ========== å¤–å±‚ï¼šå…¬å¼€æƒ…å¢ƒ UIï¼ˆä¿æŒä½ åŸæ ·å¼ï¼‰ ========== */
  :root{
    --bg1:#0a1421; --bg2:#0a111b; --bg3:#07101a;
    --ink:#eaf4ff; --muted:#9fb7c9;
    --acc:#35c9ff; --acc-2:#22d3ee;
    --line:#203349;
    --panel:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.025));
    --wb-bar:#0f1724; --wb-search:#152235;
    --header-h:58px; --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{
    height:100%;margin:0;color:var(--ink);
    font-family:'Roboto',ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Microsoft YaHei",sans-serif;
    background:
      radial-gradient(1200px 700px at 15% 0%, rgba(53,201,255,.10), transparent 65%),
      radial-gradient(1000px 700px at 90% 100%, rgba(34,211,238,.08), transparent 60%),
      linear-gradient(180deg, var(--bg1), var(--bg2) 40%, var(--bg3));
  }

  /* ========== â˜… é¢„é˜¶æ®µå®¹å™¨ï¼ˆä¸åµŒå¥— UIï¼Œç‹¬ç«‹å…¨å±ï¼‰ ========== */
  #preStage{position:fixed; inset:0; display:block;}
  #preStage .screen{position:absolute; inset:0; display:none; align-items:center; justify-content:center; padding:28px; text-align:center}
  #preStage .screen.active{display:flex}
  #preStage .panel{
    position:absolute; inset:0;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    background: rgba(13,26,43,.30);
    backdrop-filter: blur(14px) saturate(140%);
    -webkit-backdrop-filter: blur(14px) saturate(140%);
    border:1px solid rgba(53,201,255,.18);
    border-radius: 12px;
    box-shadow: none;
    padding: 28px;
  }
  #preStage .btn{
    position:relative; overflow:hidden;
    background:linear-gradient(180deg, var(--acc-2), var(--acc));
    color:#062438; border:0; border-radius:12px;
    padding:12px 26px; font-size:18px; cursor:pointer; margin:8px 6px; font-weight:800;
    box-shadow:0 8px 18px rgba(48,170,220,.18), inset 0 1px rgba(255,255,255,.25);
    transition:.18s transform ease, .18s filter ease, .18s box-shadow ease;
  }
  #preStage .btn[disabled]{opacity:.55;cursor:not-allowed}
  #preStage .btn:hover{filter:brightness(1.06); transform:translateY(-1px)}
  #preStage .btn:active{transform:translateY(0)}
  #preStage input{
    margin:6px; padding:10px 12px; font-size:16px;
    border:1.5px solid rgba(255,255,255,.12); border-radius:10px;
    background:rgba(255,255,255,.06); color:#eaf4ff; outline:none;
    transition:.2s border-color,.2s box-shadow,.2s background;
  }
  #preStage input::placeholder{ color:#cfe0f2; opacity:.75 }
  #preStage input:focus{
    border-color:var(--acc);
    box-shadow:0 0 0 3px rgba(53,201,255,.18);
    background:rgba(255,255,255,.08);
  }
  #preStage .bar{width:min(900px,78%);height:12px;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border-radius:999px;overflow:hidden;margin-top:10px;border:1px solid rgba(255,255,255,.10);box-shadow:inset 0 2px 6px rgba(0,0,0,.45)}
  #preStage .bar>span{display:block;height:100%;width:0;background:linear-gradient(90deg,#9fe6ff,#55c2ff 50%,#2aa7ff)}
  /* === æ–°å¢ï¼šç»ƒä¹ ç»“æŸè¿‡æ¸¡é¡µçš„æ—‹è½¬åŠ è½½åœˆ === */
  #preStage .loader{
    width:44px;height:44px;margin:12px auto;border-radius:50%;
    border:3px solid rgba(255,255,255,.18);
    border-top-color:var(--acc);
    animation:preSpin 1s linear infinite;
  }
  @keyframes preSpin{ to{ transform: rotate(360deg);} }

  /* === æ–°å¢ï¼špostPractice ç£¨ç ‚ç»ç’ƒæ–‡æœ¬æ¡† === */
  #preStage .glass-note{
    width:min(880px,92%);
    margin:14px 0 6px;
    padding:14px 16px;
    text-align:left;
    background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));
    border:1px solid rgba(255,255,255,.22);
    border-radius:14px;
    backdrop-filter: blur(14px) saturate(130%);
    -webkit-backdrop-filter: blur(14px) saturate(130%);
    box-shadow:0 10px 30px rgba(0,0,0,.30), inset 0 0 0 1px rgba(255,255,255,.04);
  }
  #preStage .glass-note h3{
    text-align: center;
    margin:0 0 8px 0;
    font-weight:800;
    font-size:calc(18px * var(--pre-scale));
  }
  #preStage .glass-note ul{
    margin:0;
    padding-left:18px;
    line-height:1.75;
    font-size:calc(18px * var(--pre-scale));
    color:#eaf4ff;
    opacity:.95;
  }
  #preStage .glass-note li + li{ margin-top:4px; }

  /* ========== ç¤¾åŒº UI åº”ç”¨ï¼ˆåˆå§‹åŒ–éšè—ï¼Œè¿›å…¥æ­£å¼å®éªŒæ‰æ˜¾ç¤ºï¼‰ ========== */
  .app{position:fixed;inset:0;display:grid;grid-template-rows:var(--header-h) 1fr}
  #communityApp{display:none;} /* â˜… åˆå§‹éšè—ï¼Œç»ƒä¹ ç»“æŸåæ˜¾ç¤º */

  .wb-header{background:var(--wb-bar);border-bottom:1px solid #0b1320}
  .wb-inner{
    height:var(--header-h);
    max-width:1280px; margin:0 auto;
    display:grid; align-items:center;
    grid-template-columns: minmax(360px, 440px) 1fr minmax(320px, 360px);
    gap:16px; padding:0 22px;
  }
  .wb-left{display:flex;align-items:center;gap:12px;min-width:0}
  .brand{display:flex;align-items:center;gap:10px;font-weight:700;white-space:nowrap}
  .brand svg{display:block}
  .wb-search{
    flex:1;display:flex;align-items:center;gap:8px;min-width:220px;
    padding:6px 12px;border-radius:999px;background:var(--wb-search);color:#cfe0f2
  }
  .wb-search input{flex:1;border:0;outline:0;background:transparent;color:#e8f2ff;font-size:14px;min-width:0}
  .wb-center{height:100%;display:flex;align-items:center;justify-content:center;gap:28px}
  .wb-tab{position:relative;display:flex;align-items:center;gap:6px;color:#e6eef9;opacity:.95}
  .wb-tab.active{color:#ffffff}
  .wb-tab.active::after{
    content:"";position:absolute;left:-6px;right:-6px;bottom:-12px;height:3px;border-radius:999px;
    background:linear-gradient(90deg,#35c9ff,#22d3ee);
  }
  .wb-right{display:flex;align-items:center;gap:14px;justify-content:flex-end}
  .wb-icon{width:30px;height:30px;border-radius:50%;display:grid;place-items:center;background:#142439;flex:0 0 auto}
  .wb-post{padding:8px 14px;border-radius:10px;background:linear-gradient(90deg,#35c9ff,#22d3ee);color:#042333;font-weight:800;border:0;cursor:pointer}
  .layout{display:grid;grid-template-columns:260px minmax(0,1fr) 320px;gap:12px;padding:12px;height:calc(100dvh - var(--header-h))}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);overflow:hidden}
  .nav{padding:14px;display:flex;flex-direction:column;min-height:0}
  .sec{font-size:12px;color:#89a6bf;margin:6px}
  .nav a{position:relative;display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;color:var(--ink);text-decoration:none;transition:.18s}
  .nav a .ico{width:24px;height:24px;display:grid;place-items:center;border-radius:10px;background:linear-gradient(180deg,#0f1f33,#0c1828);border:1px solid rgba(120,160,200,.18);box-shadow:inset 0 0 0 1px rgba(255,255,255,.05)}
  .nav a:hover{background:linear-gradient(180deg,rgba(53,201,255,.10),rgba(34,211,238,.06));box-shadow:0 6px 18px rgba(20,40,80,.25)}
  .nav a.active{background:linear-gradient(180deg,rgba(53,201,255,.14),rgba(34,211,238,.10));box-shadow:0 10px 26px rgba(25,110,180,.22)}
  .nav a.active::before{content:"";position:absolute;left:6px;top:8px;bottom:8px;width:3px;border-radius:999px;background:linear-gradient(180deg,#35c9ff,#22d3ee)}
  .tags{display:flex;flex-direction:column;gap:10px;padding:6px 6px 0}
  .tag{display:inline-flex;align-items:center;gap:8px;width:100%;padding:10px 12px;border-radius:999px;font-weight:600;color:#d9f3ff;text-decoration:none;background:linear-gradient(180deg,#0e2136,#0c1b2c);border:1px solid rgba(120,160,200,.18)}
  .tag::before{content:"#";font-weight:900;color:var(--acc)}
  .main{display:grid;grid-template-rows:auto minmax(420px,1fr) auto;gap:12px;min-width:0;padding:10px}
  .composer{border:1px solid var(--line);border-radius:12px;background:linear-gradient(180deg,#0e1a2b,#0a1523);box-shadow:0 8px 24px rgba(10,20,40,.25)}
  .composer-top{padding:10px 12px 0}
  .composer-input{width:100%;min-height:52px;resize:vertical;border:0;outline:0;border-radius:10px;padding:10px 12px;font-size:13px;color:#eaf4ff;background:#0f1a2a;box-shadow:inset 0 0 0 1px rgba(53,201,255,.08)}
  .composer-bottom{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px 10px;border-top:1px solid rgba(255,255,255,.06)}
  .composer-actions{display:flex;align-items:center;gap:12px}
  .act{display:flex;flex-direction:column;align-items:center;gap:4px;color:#cde7ff;font-size:11px;opacity:.95}
  .act svg{width:20px;height:20px}
  .composer-right{display:flex;align-items:center;gap:10px}
  .divider{width:1px;height:20px;background:#2a3a4f}
  .privacy{display:flex;align-items:center;gap:6px;padding:6px 10px;border-radius:8px;background:#0f2134;border:1px solid rgba(53,201,255,.18)}
  .privacy select{background:transparent;color:#eaf4ff;border:0;outline:0}
  .send{padding:8px 12px;border-radius:10px;background:linear-gradient(90deg,#35c9ff,#22d3ee);color:#042333;font-weight:800;border:0;cursor:pointer}
  .viewport{position:relative;min-height:420px;border:1px dashed rgba(47,107,255,.35);border-radius:12px;background:linear-gradient(180deg,#0d1a2b,#0a1523)}
  .center-note{position:absolute;inset:0;display:grid;place-items:center;text-align:center;padding:18px}
  .center-note h2{margin:0 0 10px;font-size:28px}
  .center-note p{margin:6px 0;font-size:18px;color:var(--muted)}
  .kbd{display:inline-block;padding:1px 6px;border-radius:6px;border:1px solid rgba(53,201,255,.35);background:#0f2134;font-weight:700;font-size:16px}
  .ticker{height:38px;border:1px solid var(--line);border-radius:10px;background:linear-gradient(180deg,#0f1a2a,#0c1524);overflow:hidden;display:flex;align-items:flex-start}
  .ticker ul{list-style:none;margin:0;padding:0}
  .ticker li{display:flex;align-items:center;gap:8px;height:38px;padding:0 12px;font-size:12px;color:var(--muted);white-space:nowrap}
  .dot{width:6px;height:6px;border-radius:999px;background:var(--acc)}
  .aside{display:grid;grid-template-rows:auto auto 1fr;gap:12px;padding:10px;overflow-y:hidden}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:8px}
  .subject{display:flex;align-items:center;gap:12px}
  .subject .big-av{width:48px;height:48px;border-radius:50%;background:#142439 center/cover no-repeat;border:1px solid #2a3a42;box-shadow:inset 0 0 0 1px rgba(255,255,255,.06)}
  .subject .meta{display:flex;flex-direction:column}
  .subject .meta .id{font-weight:700;letter-spacing:.3px}
  .pill{font-size:11px;padding:2px 8px;border:1px solid var(--line);border-radius:999px;color:var(--muted);align-self:flex-start}
  .peers-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .peer{background:linear-gradient(180deg,#131e2d,#101a28);border:1px solid var(--line);border-radius:12px;padding:6px}
  .peer-vp{position:relative;aspect-ratio:16/10;border-radius:10px;overflow:hidden;background:linear-gradient(180deg,#0e1a2a,#0a1523)}
  .peer-vp img{position:absolute;inset:0;width:100%;height:100%;object-fit:contain}
  .mini-av{position:absolute;left:8px;top:8px;width:20px;height:20px;border-radius:50%;background:#1a2534 center/cover no-repeat;border:1px solid rgba(255,255,255,.55);box-shadow:0 0 0 2px rgba(10,20,30,.35)}
  .peer-meta{display:flex;align-items:center;justify-content:space-between;margin-top:6px;font-size:11px;color:var(--muted)}
  .self-vp{position:relative;aspect-ratio:16/10;border-radius:10px;overflow:hidden;background:linear-gradient(180deg,#0e1a2a,#0a1523)}
  .self-vp img{position:absolute;inset:0;width:100%;height:100%;object-fit:contain}
  .progress{margin-top:6px}
  .progress .label{display:flex;align-items:center;justify-content:space-between;font-size:11px;color:#muted;margin-bottom:4px}
  .bar{width:100%;height:10px;border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,.10);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));box-shadow:inset 0 2px 6px rgba(0,0,0,.45)}
  .bar>span{display:block;height:100%;width:0;background:linear-gradient(90deg,#91dcff,#55c2ff 50%,#2aa7ff)}
  @media (max-width:1200px){ .wb-inner{grid-template-columns:minmax(300px,380px) 1fr minmax(280px,320px)} }
  @media (max-width:1000px){ .wb-inner{grid-template-columns:1fr auto auto}.wb-center{display:none} }
  @media (max-width:900px){ .layout{grid-template-columns:1fr;grid-template-rows:auto auto auto;height:auto}.aside{order:-1} }

  /* ========== å†…å±‚ï¼šå®éªŒåµŒå¥—è¿›ä¸­æ  .viewport çš„æ ·å¼é™å®šï¼ˆä¿ç•™ï¼‰ ========== */
  #expHost { position:absolute; inset:0; }
  #expHost .screen{position:absolute;inset:0;display:none;align-items:center;justify-content:center;padding:28px;text-align:center}
  #expHost .screen.active{display:flex}
  #expHost .panel{
    position:absolute; inset:0;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    background: rgba(13,26,43,.30);
    backdrop-filter: blur(14px) saturate(140%);
    -webkit-backdrop-filter: blur(14px) saturate(140%);
    border:1px solid rgba(53,201,255,.18);
    border-radius: 12px;
    box-shadow: none;
    padding: 28px;
  }
  #expHost{ --txt:#e9edf6; --muted:#9fb7c9; --acc:#35c9ff; --acc-2:#22d3ee; }
  #expHost .btn{
    position:relative; overflow:hidden;
    background:linear-gradient(180deg, var(--acc-2), var(--acc));
    color:#062438; border:0; border-radius:12px;
    padding:12px 26px; font-size:18px; cursor:pointer; margin:8px 6px; font-weight:800;
    box-shadow:0 8px 18px rgba(48,170,220,.18), inset 0 1px rgba(255,255,255,.25);
    transition:.18s transform ease, .18s filter ease, .18s box-shadow ease;
  }
  #expHost .btn[disabled]{opacity:.55;cursor:not-allowed}
  #expHost .btn:hover{filter:brightness(1.06); transform:translateY(-1px)}
  #expHost .btn:active{transform:translateY(0)}
  #expHost input{
    margin:6px; padding:10px 12px; font-size:16px;
    border:1.5px solid rgba(255,255,255,.12); border-radius:10px;
    background:rgba(255,255,255,.06); color:#eaf4ff; outline:none;
    transition:.2s border-color,.2s box-shadow,.2sèƒŒæ™¯;
  }
  #expHost input::placeholder{ color:#cfe0f2; opacity:.75 }
  #expHost input:focus{
    border-color:var(--acc);
    box-shadow:0 0 0 3px rgba(53,201,255,.18);
    background:rgba(255,255,255,.08);
  }
  #expHost .bar{width:min(900px,78%);height:12px;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border-radius:999px;overflow:hidden;margin-top:10px;border:1px solid rgba(255,255,255,.10);box-shadow:inset 0 2px 6px rgba(0,0,0,.45)}
  #expHost .bar>span{display:block;height:100%;width:0;background:linear-gradient(90deg,#9fe6ff,#55c2ff 50%,#2aa7ff)}
  #expHost #stimulus{max-width:min(86vw, 100%);  /* è§†å£ 86%ï¼ŒåŒæ—¶ä¸è¶…è¿‡å®¹å™¨ */;height:64vh; width: auto;display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);will-change:opacity,transform}
  #expHost #fixation{display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:64px;color:var(--acc)}
  #expHost .hint{position:absolute;font-size:18px;color:#062438;font-weight:800;background:linear-gradient(180deg,#bfe9ff,#7fd3ff);border:0;border-radius:10px;padding:6px 10px;box-shadow:0 6px 20px rgba(0,0,0,.22)}
  #expHost .hint-left{left:6%;top:50%;transform:translateY(-50%);display:none}
  #expHost .hint-right{right:6%;top:50%;transform:translateY(-50%);display:none}
  #expHost #currentTypeLabel,#expHost #idealTypeLabel{font-size:18px;color:#cfe8ff;opacity:0;transition:opacity .2s;position:absolute;top:86%;left:50%;transform:translateX(-50%)}
  #expHost #practicePrompt{position:absolute;top:86%;left:50%;transform:translateX(-50%);color:#cfe8ff;display:none}
  #expHost #fxCanvas{position:absolute; inset:0; z-index:0; pointer-events:none}
  #overlayUploading, #overlayFailed{position:absolute !important; inset:0 !important;}

  /* â€”â€” ä¿®å¤ç‚¹å‡»ï¼šé¿å…è¿›åº¦æ¡æŒ¡ä½æŒ‰é’®ï¼Œä¿è¯æŒ‰é’®åœ¨æœ€ä¸Šå±‚ â€”â€” */
  #preStage{ z-index:9999; pointer-events:auto; }
  #preStage .nz-actions{ position:relative; z-index:3; }
  #preStage #btnNoticeNext{ position:relative; z-index:4; pointer-events:auto; cursor:pointer; }
  #preStage .bar{ pointer-events:none; }

  /* â˜…â˜…â˜… æ–°å¢ï¼šç»ƒä¹ é˜¶æ®µåœ¨ preStage å†…ç‹¬ç«‹å‘ˆç°ä¸»æœºä½ï¼ˆä¸æ”¹åŠ¨å…¶ä»–åŒºåŸŸï¼‰ â˜…â˜…â˜… */
  #practiceHost{ position:absolute; inset:0; display:none; }
  #practiceHost img#pStimulus{
    max-width:86%; height:64vh; display:none;
    position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
    will-change:opacity,transform;
  }
  #practiceHost #pFixation{
    display:none; position:absolute; top:50%; left:50%;
    transform:translate(-50%,-50%); font-size:64px; color:var(--acc);
  }
  #practiceHost .hint{
    position:absolute; font-size:18px; color:#062438; font-weight:800;
    background:linear-gradient(180deg,#bfe9ff,#7fd3ff); border:0; border-radius:10px;
    padding:6px 10px; box-shadow:0 6px 20px rgba(0,0,0,.22);
  }
  #practiceHost .hint-left{ left:6%; top:50%; transform:translateY(-50%); display:none }
  #practiceHost .hint-right{ right:6%; top:50%; transform:translateY(-50%); display:none }
  #practiceHost #pPracticePrompt{
    position:absolute; top:86%; left:50%; transform:translateX(-50%);
    color:#cfe8ff; display:none;
  }

  /* â˜… æ–°å¢ï¼šä¸­æ æç¤ºæ ‡é¢˜ & ä¾§æ ç´§å‡‘å‘å¸–æ¡†ï¼ˆä¸å½±å“å…¶ä»–åŒºåŸŸï¼‰ */
.main-tip{
  border:1px solid var(--line);
  border-radius:12px;
  padding:12px 14px;
  background:linear-gradient(180deg,#0e1a2b,#0a1523);
  box-shadow:0 8px 24px rgba(10,20,40,.25);
}
.main-tip .title{ display:flex; align-items:center; gap:8px; font-weight:700; letter-spacing:.3px; }
.main-tip .sub{ font-size:12px; color:var(--muted); margin-top:4px; }

/* ä»…å½“ composer ä½äºå³ä¾§æ æ—¶ï¼Œåšé€‚é…ç¼©æ”¾ */
.aside .composer{ padding:8px; }
.aside .composer-top{ padding:8px 8px 0; }
.aside .composer-input{ min-height:44px; font-size:12px; }
.aside .composer-bottom{ padding:6px 8px; }
.aside .act svg{ width:18px; height:18px; }
.aside .act span{ display:none; }         /* å›¾æ ‡ä¿ç•™ï¼Œæ–‡å­—ç¼©æ‰ä»¥çœç©ºé—´ */
.aside .privacy{ padding:4px 8px; }
.aside .send{ padding:6px 10px; }


  /* â˜…â˜…â˜… æ–°å¢ï¼šå…¬ç¤ºçª—å°è§†çª—è¿›åº¦ç¯ï¼ˆä»…æ”¹æ­¤å—æ ·å¼ä»¥å®¹çº³ç¯å¿ƒå¤´åƒï¼‰ â˜…â˜…â˜… */
  @keyframes ringBeat{
    0%,100%{ transform:scale(1); }
    50%{ transform:scale(1.06); }
  }
  .peer-vp .ring{
    position:absolute; right:8px; top:8px; width:26px; height:26px;
    border-radius:50%;
    background: conic-gradient(var(--acc) calc(var(--p,0)*1turn), rgba(255,255,255,.15) 0);
    display:grid; place-items:center;
    box-shadow: inset 0 0 0 2px rgba(255,255,255,.12), 0 0 0 2px rgba(0,0,0,.25);
    animation: ringBeat 2s ease-in-out infinite;
  }
  .peer-vp .ring::after{
    content:''; width:22px; height:22px; border-radius:50%;
    background:rgba(10,20,35,.85);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.08);
    position:absolute; inset:2px;
  }
  .peer-vp .ring .av{
    position:absolute; inset:4px;
    border-radius:50%;
    background:center/cover no-repeat;
    box-shadow:0 0 0 1px rgba(255,255,255,.45), 0 0 0 2px rgba(10,20,30,.35);
    /* ç¡®ä¿ä¸å—çˆ¶çº§äº®åº¦åŠ¨ç”»å½±å“ï¼ˆçˆ¶çº§æœªå†ä½¿ç”¨filterï¼Œå·²é¿å…é—ªçƒï¼‰ */
    will-change:transform;
  }
  /* ä»…ä½œç”¨äºå·¦æ  åœ¨çº¿ï¼ˆå®æ—¶ï¼‰ çš„å¤´åƒä¸åç§° */
aside.panel.nav .status .avatars .avatar{
  justify-self: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 44px;                 /* ä¸å¤´åƒåŒå®½ï¼Œç»™ label ä¸€ä¸ªæ¢è¡Œå‚ç…§ */
}

aside.panel.nav .status .avatars .avatar label{
  display: block;
  width: 44px;                 /* å…³é”®ï¼šé™åˆ¶å®½åº¦æ‰ä¼šæ¢è¡Œ */
  margin-top: 4px;
  text-align: center;
  white-space: normal;         /* å…è®¸æ¢è¡Œ */
  overflow-wrap: anywhere;     /* æ²¡ç©ºæ ¼ä¹Ÿèƒ½æ–­å¼€ */
  word-break: break-word;      /* å…œåº• */
  line-height: 1.2;
}
.peers-grid .peer .peer-meta .t{ display:none; }
/* éšè—ä¸­éƒ¨å¯¼èˆª tabs */
.wb-center{ display:none !important; }

/* å¤´éƒ¨ç”± 3 åˆ— -> 2 åˆ—ï¼šå·¦(å“ç‰Œ+æœç´¢) | å³(å›¾æ ‡+å‘å¸ƒ) */
.wb-inner{
  grid-template-columns: minmax(360px,1fr) minmax(320px,360px);
}

/* çª„å±æ—¶ä¹Ÿä¿æŒä¸¤åˆ—ï¼ˆè¦†ç›–åŸ @media çš„ 1fr auto autoï¼‰ */
@media (max-width:1000px){
  .wb-inner{ grid-template-columns: 1fr minmax(320px,360px); }
}
/* é¡¶éƒ¨å¤´éƒ¨ï¼šæ”¹æˆ 2 åˆ—å¸ƒå±€â€”â€”å·¦ 1fr | å³ auto */
.wb-inner{
  grid-template-columns: 1fr auto;
}

/* å·¦åˆ—å æ»¡å¯ç”¨ç©ºé—´ï¼Œæœç´¢æ¡†æ’‘å¼€ï¼Œé¿å…è¢«æŒ¤ */
.wb-left{ min-width: 0; }          /* å…è®¸æ”¶ç¼© */
.wb-left .wb-search{ flex: 1; }     /* æœç´¢æ¡†æ‹‰ä¼¸å æ»¡å·¦åˆ— */

/* å³åˆ—å†…å®¹è´´å³å¯¹é½ */
.wb-right{ justify-content: flex-end; }

/* çª„å±ä¹Ÿä¿æŒä¸¤åˆ—ï¼ˆè¦†ç›–åŸæœ‰ @mediaï¼‰ */
@media (max-width:1000px){
  .wb-inner{ grid-template-columns: 1fr auto; }
}
.wb-inner{ max-width: none; width: 100%; }  /* å¯ä¿ç•™åŸæœ‰ padding ä½œä¸ºå·¦å³å†…è¾¹è· */
.main .ticker{ height: 52px; }      /* æƒ³å¤šé«˜å°±å†™å¤šå°‘ï¼Œæ¯”å¦‚ 52 æˆ– 56 */
.main .ticker li{ height: 52px; }   /* æ¯æ¡æ¶ˆæ¯è¡Œé«˜åŒæ­¥ */
/* æ­£å¼å®éªŒçš„å±•ç¤ºå›¾å¾€ä¸Šæï¼ˆ50%â†’46%ï¼Œæ•°å€¼è¶Šå°è¶Šé ä¸Šï¼‰ */
#expHost #stimulus{ top:46%; }

/* ç»ƒä¹ é˜¶æ®µä¸€èµ·ä¸Šæ */
#practiceHost #pStimulus{ top:46%; }
/* â€”â€” å¤§æ¡†ï¼ˆåŒ…ä½æ•´å— Noticeï¼‰â€”â€” */
#preStage .nz-card{
  position: relative;
  width: min(1100px, 94%) !important;   /* æ¯”åŸæ¥æ›´å®½ä¸€ç‚¹ */
  margin: 0 auto;
  padding: 22px 22px 16px !important;   /* å¤§æ¡†å†…è¾¹è· */
  border-radius: 18px !important;
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  border: 1.5px solid rgba(53,201,255,.22);
  box-shadow: 0 18px 50px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.04);
  backdrop-filter: blur(8px) saturate(130%);
}

/* å¤§æ¡†é‡Œçš„å†…åœˆæè¾¹ï¼ˆå¯é€‰ï¼Œè®©â€œå¥—â€æ„Ÿæ›´æ˜æ˜¾ï¼‰ */
#preStage .nz-card::before{
  content:"";
  position:absolute; inset:10px; border-radius:14px;
  border:1px solid rgba(255,255,255,.08);
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
  pointer-events:none;
}

/* â€”â€” å°æ¡†ï¼ˆæ¯ä¸ªé¢æ¿ï¼‰â€”â€” */
#preStage .nz-pane{
  background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)) !important;
  border: 1px solid rgba(53,201,255,.20) !important;
  border-radius: 14px !important;
  padding: 16px !important;
  box-shadow: 0 6px 24px rgba(0,0,0,.25);
}

/* æ ‡é¢˜ç¨å¤§ä¸€ç‚¹ï¼ŒåŒ¹é…â€œå¥—æ¡†â€çš„æ°”è´¨ */
#preStage .nz-pane h2{
  font-size: 20px !important;
  margin: 0 0 10px 0 !important;
}

/* ä¸¤åˆ—å¸ƒå±€ï¼ˆä¿ç•™ä¸¤å—æ—¶ç”¨ï¼‰ï¼›æƒ³å•æ å°±æŠŠä¸‹é¢ä¸€æ®µæ”¹æˆ 1fr */
#preStage .nz-grid{
  grid-template-columns: 1fr 1fr !important;
  gap: 16px !important;
}

/* åˆ—è¡¨å»åœ†ç‚¹ï¼ˆå¦‚æœä½ è¿˜æ²¡å»æ‰çš„è¯ï¼‰ */
#preStage .nz-pane ul{ list-style:none; padding-left:0 !important; line-height:1.9; font-size:16px; }
/* æ•´ä¸ª Notice å¡ï¼ˆå¤§æ¡†+å°æ¡†+æ–‡å­—ï¼‰ç»Ÿä¸€æ”¾å¤§ 1.15 å€ */
#preStage .nz-card{
  transform: scale(1.15);
  transform-origin: top center;
  width: min(980px, 90%);           /* ç•¥æ”¶çª„ä»¥æŠµæ¶ˆæ”¾å¤§åçš„å¤–æº¢ï¼Œå¯æŒ‰éœ€å¾®è°ƒ */
}
/* é˜²æ­¢è¢«è£åˆ‡ */
#preStage .panel{ overflow: visible; }

/* Notice ä¸¤ä¸ªé¢æ¿ä¸Šä¸‹æ’å¸ƒ */
#preStage .nz-grid{
  grid-template-columns: 1fr !important;  /* å•åˆ— */
  gap: 16px !important;                   /* ä¸Šä¸‹é—´è· */
}
/* === ç»Ÿä¸€æ”¾å¤§å¼€å…³ï¼ˆæ”¹è¿™é‡Œçš„æ¯”ä¾‹å³å¯ï¼‰ === */
:root{ --pre-scale: 1.25; } /* 1.0=åŸå¤§å°ï¼›1.2/1.25/1.3 æ›´å¤§ */

/* 1) æŒ‡å¯¼è¯­é¡µ & ç»ƒä¹ è¯´æ˜é¢æ¿é‡Œçš„æ–‡å­—æ•´ä½“æ”¾å¤§ */
#guidelines .panel,
#practiceGuidelines .panel{
  font-size: calc(22px * var(--pre-scale));
  line-height: calc(0.5 * 1); /* è¡Œé«˜åŒæ­¥æ”¾ä¸€äº›æ›´å¥½è¯» */
}
#guidelines h1{
  font-size: calc(22px * var(--pre-scale));
  font-weight: 800;
}

/* 2) è¿™ä¸¤é¡µé‡Œçš„æŒ‰é’®/è¾“å…¥æ¡†ä¸€èµ·æ”¾å¤§ */
#preStage .btn{
  font-size: calc(18px * var(--pre-scale));
  padding: calc(12px * var(--pre-scale)) calc(26px * var(--pre-scale));
  border-radius: calc(12px * var(--pre-scale));
}
#preStage input{
  font-size: calc(16px * var(--pre-scale));
  padding: calc(10px * var(--pre-scale)) calc(12px * var(--pre-scale));
  border-radius: calc(10px * var(--pre-scale));
}

/* 3) ç»ƒä¹ é˜¶æ®µå±å¹•ä¸Šçš„æç¤ºæ–‡å­—ä¹Ÿæ”¾å¤§ï¼ˆé•¿æŒ‰F/Jã€å°æç¤ºç­‰ï¼‰ */
#practiceHost .hint{                               /* å·¦å³ä¸¤è¾¹è“è‰²å°è´´ç‰‡ */
  font-size: calc(18px * var(--pre-scale));
  padding: calc(6px * var(--pre-scale)) calc(10px * var(--pre-scale));
  border-radius: calc(10px * var(--pre-scale));
}
#practiceHost #pPracticePrompt{                   /* åº•éƒ¨â€œæŒ‰Enterç»“æŸæœ¬æ¬¡ç»ƒä¹ â€ */
  font-size: calc(16px * var(--pre-scale));
}

/* ï¼ˆå¯é€‰ï¼‰è¦†ç›–è¿™é¡µçš„å°å­—æç¤ºâ€œç­‰å¾…é€‰æ‹©æ€§åˆ«å¼€å§‹é¢„åŠ è½½â€¦â€çš„å†…è”å­—å· */
#guidelines #preloadTip{ font-size: calc(14px * var(--pre-scale)) !important; }

/* ï¼ˆå¯é€‰ï¼‰å¦‚æœæƒ³æŠŠâ€œä¸Šä¼ å¤±è´¥â€å¼¹çª—é‡Œçš„æŒ‰é’®ä¹Ÿä¸€å¹¶æ”¾å¤§ */
#expHost .btn{ font-size: calc(18px * var(--pre-scale)); }
/* â˜… é¢„é˜¶æ®µä¸“ç”¨ç²’å­ç”»å¸ƒ */
#preStage #preFxCanvas{
  position:absolute;
  inset:0;
  z-index:0;
  pointer-events:none;
}
/* å³ä¾§ï¼šç”¨çºµå‘ flexï¼ŒæŠŠå¤šä½™é«˜åº¦åˆ†æ‘Šåˆ°ä¸¤å¤„é—´è·é‡Œ */
.aside{
  display: flex;              /* è¦†ç›–åŸæ¥çš„ grid */
  flex-direction: column;
  justify-content: space-between;              /* æŠŠå‰©ä½™é«˜åº¦åˆ†é…åˆ°é—´è· */
  gap: clamp(12px, 2.5vh, 28px);               /* æœ€å°é—´è·éšé«˜åº¦é€‚é…ï¼Œ12~28px */
}

/* é˜²æ­¢å†…éƒ¨æŠŠå¡ç‰‡æ’‘å¼€ï¼ŒæŒ‰å†…å®¹é«˜åº¦æ’å¸ƒå³å¯ */
.aside .card{ flex: 0 0 auto; }

/* ä¸­é—´â€œæ­£åœ¨å‚ä¸è€…â€åˆ—è¡¨éœ€è¦æ»šåŠ¨æ—¶ä¸æŠŠå¡ç‰‡é¡¶é«˜ */
.aside .peers-grid{
  max-height: 100%;
  overflow: auto;
  min-height: 0;
}

/* ç¬¬ä¸‰å—é‡Œé¢„è§ˆåŒºåŸŸæŒ‰å®¹å™¨è‡ªé€‚åº”ï¼Œä¸å†é¢å¤–æ’‘é«˜ */
.aside .self-vp{ min-height: 0; }
.aside .self-vp img{ width:100%; height:100%; object-fit:contain; }
/* å³ä¾§å…¬ç¤ºçª—ï¼šæŠŠâ€œæ­£åœ¨è°ƒæ•´â€¦â€æ”¾åˆ°ç¼–ç ä¸Šæ–¹ï¼Œå·¦å¯¹é½æ˜¾ç¤º */
.peers-grid .peer .peer-meta{
  display: flex;               /* æ”¹ä¸ºçºµå‘æ’åˆ— */
  flex-direction: column;
  align-items: flex-start;
  gap: 4px;                    /* ä¸Šä¸‹é—´è· */
  margin-top: 6px;             /* ä¿ç•™åŸå¤–è¾¹è· */
}

.peers-grid .peer .peer-meta .t{
  order: -1;                   /* æ”¾åˆ°ç¼–ç (.n)çš„å‰é¢ */
  display: inline-block !important;  /* è¦†ç›–ä½ å…ˆå‰çš„ display:none */
  font-size: 11px;
  line-height: 1.2;
  color: #9fb7c9;
  opacity: .95;
  /* å¯é€‰ï¼šåšæˆå°èƒ¶å›Šæ ‡ç­¾ */
  padding: 2px 8px;
  border-radius: 999px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.12);
}

.peers-grid .peer .peer-meta .n{
  font-weight: 600;
}


/* ========== æ–°å¢ï¼šæ„Ÿè°¢é¡µä¸åœ¨ UI åµŒå¥—ä¸‹çš„æ ·å¼ï¼Œä»…ä½œç”¨äº #thankYou ========== */
#thankYou{
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 28px;
  text-align: center;
  z-index: 10000; /* é«˜äºç¤¾åŒºUIä¸é¢„é˜¶æ®µ */
}
#thankYou.active{ display:flex; }
#thankYou .panel{
  position:absolute; inset:0;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  background: rgba(13,26,43,.30);
  backdrop-filter: blur(14px) saturate(140%);
  -webkit-backdrop-filter: blur(14px) saturate(140%);
  border:1px solid rgba(53,201,255,.18);
  border-radius: 12px;
  box-shadow: none;
  padding: 28px;
}
</style>
</head>
<body>

<!-- ========== â˜… é¢„é˜¶æ®µï¼ˆä¸åµŒå¥— UIï¼‰ ========== -->
<div id="preStage" aria-label="é¢„é˜¶æ®µ">
    <!-- â˜… é¢„é˜¶æ®µç²’å­ç”»å¸ƒ -->
  <canvas id="preFxCanvas" aria-hidden="true"></canvas>
  <!-- Notice -->
  <section id="notice" class="screen active">
    <div class="panel" role="region" aria-label="å®éªŒæ³¨æ„äº‹é¡¹">
      <article class="nz-card" style="width:min(980px,92%); text-align:left;">
        <header class="nz-head" style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
          <span class="nz-badge" style="font-size:18px;background:linear-gradient(180deg,var(--acc-2),var(--acc)); color:#062438; padding:4px 10px; border-radius:999px; font-weight:800">NOTICE</span>
          <h1 class="nz-title" style="margin:0;font-size:22px">æ¬¢è¿å‚åŠ ä½“å‹è°ƒæ•´å®éªŒ</h1>
        </header>
        <section class="nz-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div class="nz-pane" style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:14px">
            <h2 style="margin:0 0 8px 0;font-size:22px;text-align:center">å®éªŒèƒŒæ™¯</h2>
            <ul style="margin:8px 0 0 0;padding-left:18px;line-height:1.7;font-size:20px">
              <li>æœ¬æ¬¡å®éªŒé‚€è¯·åˆ°äº†å„å­¦é™¢ä¸åŒä¸“ä¸šçš„å­¦ç”Ÿå¤§æ¦‚200åï¼Œåœ¨å‰æœŸå®éªŒä¸­å¤§å®¶å…±åŒå‚ä¸äº†ä½“å‹æ„ŸçŸ¥å®éªŒçš„åŸºçº¿æµ‹éªŒä»»åŠ¡ã€‚ä»Šå¤©çš„æ­£å¼å®éªŒä»»åŠ¡å°†ä¼šç”±æ‰€æœ‰å‰æœŸå‚ä¸æ´»åŠ¨äººå‘˜å…±åŒåœ¨æœ¬æ¬¡å®éªŒæ‰€åˆ›å»ºçš„â€œå®éªŒç½‘ç»œç¤¾åŒºâ€å†…å®Œæˆï¼Œç¤¾åŒºå†…ä¼šæœ‰æ­£åœ¨å®Œæˆå®éªŒåŒå­¦çš„å®æ—¶çŠ¶æ€å…¬å¸ƒï¼Œä»¥åŠå·²å®ŒæˆåŒå­¦çš„ä½“éªŒåˆ†äº«ï¼Œå½“ç„¶æ‚¨çš„å®éªŒè¿‡ç¨‹ä¹ŸåŒæ ·ä¼šåœ¨â€œå®éªŒç½‘ç»œç¤¾åŒºâ€å†…å‘å¸ƒã€‚</li>
            </ul>
          </div>
          <div class="nz-pane" style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:14px">
            <h2 style="margin:0 0 8px 0;font-size:22px;text-align:center">ä¿å¯†åŸåˆ™</h2>
            <ul style="margin:8px 0 0 0;padding-left:18px;line-height:1.7;font-size:20px">
             <li><b>åŒ¿åå¤„ç†ï¼š</b>å®éªŒè®°å½•ä¸åŒ…å«å¯ç›´æ¥è¯†åˆ«èº«ä»½çš„ä¿¡æ¯ï¼›å…¬å¼€æŠ¥å‘Šä»…å‘ˆç°æ±‡æ€»ç»Ÿè®¡ã€‚</li>
             <li><b>é™åˆ¶ç”¨é€”ï¼š</b>æ•°æ®ä»…ç”¨äºç§‘å­¦ç ”ç©¶ä¸å­¦æœ¯å‘è¡¨ï¼Œä¸ä½œå•†ä¸šç”¨é€”ã€‚</li>
             <li><b>å®‰å…¨å­˜å‚¨ï¼š</b>æ•°æ®å­˜æ”¾äºå—æ§ç ”ç©¶è´¦å·äº‘ç«¯ï¼Œè®¿é—®ã€ä¼ è¾“é‡‡ç”¨åŠ å¯†é€šé“ä¿æŠ¤ã€‚</li>
             <li><b>è‡ªæ„¿å‚ä¸ï¼š</b>å®éªŒéµå¾ªè‡ªæ„¿åŸåˆ™ï¼Œè‹¥æ‚¨æœ‰ä¸é€‚ï¼Œå¯éšæ—¶é€€å‡ºå®éªŒã€‚</li>
             <li><b>ç»ä¸å¤–ä¼ ï¼š</b>ä¸ºé¿å…å¹²æ‰°ä»–äººå‚ä¸ï¼Œè¯·å‹¿åœ¨ç ”ç©¶å®Œæˆå‰å…¬å¼€è®¨è®ºé¢˜ç›®æˆ–ä¼ æ’­é¡µé¢å†…å®¹ã€‚</li>
            </ul>
          </div>
        </section>
        <div class="nz-actions" style="display:flex;gap:10px;align-items:center;justify-content:space-between;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:10px;margin-top:12px">
          <div class="nz-ck" style="display:flex;align-items:center;gap:8px">
            <input id="agree" type="checkbox" aria-label="æˆ‘å·²é˜…è¯»å¹¶åŒæ„æ³¨æ„äº‹é¡¹ä¸ä¿å¯†æ¡æ¬¾" style="width:22px;height:22px;border-radius:6px;border:2px solid rgba(255,255,255,.28);background:transparent">
            <label for="agree">æˆ‘å·²é˜…è¯»å¹¶åŒæ„æ³¨æ„äº‹é¡¹ä¸ä¿å¯†æ¡æ¬¾</label>
          </div>
          <div class="bar" aria-hidden="true" style="width:240px;height:12px">
            <span id="noticePg" style="width:0%"></span>
          </div>
          <button id="btnNoticeNext" class="btn" disabled>æˆ‘å·²é˜…è¯»ï¼Œè¿›å…¥å®éªŒ</button>
        </div>
      </article>
    </div>
  </section>

  <!-- æŒ‡å¯¼è¯­ï¼ˆé¦–é¡µï¼‰ -->
  <section id="guidelines" class="screen">
    <div class="panel">
       <h1>æ¬¢è¿æ‚¨å‚åŠ æœ¬å®éªŒï¼</h1>
       <p>å®éªŒä¸­ï¼Œæ‚¨å°†é€šè¿‡"F"é”®ä¸"J"é”®æ¥å¯¹å‘ˆç°çš„ä½“å‹èƒ–ç˜¦è¿›è¡Œè°ƒæ•´ï¼Œç›´åˆ°ç¬¦åˆç›¸åº”ä½“å‹ã€‚</p>
       <p>æ‚¨å¯ä»¥é€šè¿‡é•¿æŒ‰æˆ–ç‚¹å‡»"F"é”®ä¸"J"é”®æ¥è¿›è¡Œå¿«é€Ÿæˆ–ç²¾ç»†çš„è°ƒæ•´ï¼Œ</p>
       <p>è°ƒæ•´å®Œæˆåï¼ŒæŒ‰â€œå›è½¦é”®ï¼ˆEnterï¼‰â€ç¡®è®¤é€‰æ‹©ã€‚</p>
       <p style="margin-top:6px">è¯·é€‰æ‹©æ‚¨çš„æ€§åˆ«</p>
      <div>
        <input id="studentId" placeholder="è¯·è¾“å…¥å­¦å·" />
        <input id="subjectNumber" placeholder="è¯·è¾“æ‰‹æœºå·ç å4ä½" />
      </div>
      <div>
        <button id="maleButton" class="btn">ç”·æ€§</button>
        <button id="femaleButton" class="btn">å¥³æ€§</button>
      </div>
      <div class="bar" style="margin-top:8px"><span id="preloadPg"></span></div>
      <p id="preloadTip" style="color:var(--muted);font-size:14px">ç­‰å¾…é€‰æ‹©æ€§åˆ«å¼€å§‹é¢„åŠ è½½â€¦</p>
      <button id="btnStartPractice" class="btn" disabled>è¿›å…¥ç»ƒä¹ </button>
      <p style="color:var(--muted);font-size:12px">æ³¨ï¼šå­¦å·ä¸æ‰‹æœºå·å4ä½å°†ç”¨äºç¼–ç ä¸æŠ¥é…¬å¯¹è´¦ã€‚</p>
    </div>
  </section>

  <!-- ç»ƒä¹ æŒ‡å¯¼è¯­ -->
  <section id="practiceGuidelines" class="screen">
    <div class="panel">
      <p>ç»ƒä¹ é˜¶æ®µï¼ˆå…± 3 æ¬¡ï¼‰ï¼</p>
    <p>æ‚¨å¯ä»¥é€šè¿‡â€˜é•¿æŒ‰â€™ â€œFâ€ ä¸ â€œJâ€ é”®ï¼Œæ¥è¿›è¡Œä½“å‹çš„ â€˜å¿«é€Ÿâ€™ è°ƒæ•´ï¼Œ</p>
    <p>æˆ–é€šè¿‡â€˜ç‚¹å‡»â€™ â€œFâ€ ä¸ â€œJâ€ é”®æ¥å¯¹ä½“å‹è¿›è¡Œâ€˜ç²¾ç»†â€™ è°ƒæ•´ã€‚</p>
    <p>è‹¥æ‚¨å·²ç»äº†è§£å…·ä½“æ“ä½œï¼ŒæŒ‰ <b>ç©ºæ ¼é”®</b> å¼€å§‹ç»ƒä¹ ï¼</p>
    </div>
  </section>

  <!-- â˜… ç»ƒä¹ é˜¶æ®µå‘ˆç°ä¸»æœºä½ï¼ˆä¸åµŒå¥— UIï¼‰ -->
  <div id="practiceHost" aria-label="ç»ƒä¹ å‘ˆç°å±‚">
    <img id="pStimulus" alt="practice stimulus" decoding="async" loading="eager" fetchpriority="high">
    <div id="pFixation">+</div>
    <div id="pHintL" class="hint hint-left">é•¿æŒ‰â€œFâ€å˜ç˜¦</div>
    <div id="pHintR" class="hint hint-right">é•¿æŒ‰â€œJâ€å˜èƒ–</div>
    <div id="pPracticePrompt" style="color:#cfe8ff;display:none">
      ç†Ÿæ‚‰åå¯æŒ‰ <b>Enter</b> ç»“æŸæœ¬æ¬¡ç»ƒä¹ 
    </div>
  </div>

  <!-- â˜… æ–°å¢ï¼šç»ƒä¹ ç»“æŸåçš„æŒ‡å¯¼ä¸åŠ è½½é¡µï¼ˆå«ç£¨ç ‚ç»ç’ƒæ–‡æœ¬æ¡†ï¼‰ -->
  <section id="postPractice" class="screen">
    <div class="panel">
      <h1 style="margin:6px 0 8px 0">å‡†å¤‡è¿›å…¥æ­£å¼å®éªŒ</h1>
     <div class="loader" aria-hidden="true"></div>
      <!-- ç£¨ç ‚ç»ç’ƒæ–‡æœ¬æ¡†ï¼šç”¨äºæ”¾æŒ‡å¯¼è¯­ -->
      <div class="glass-note" role="note" aria-label="æ­£å¼é˜¶æ®µæ“ä½œæé†’">
        <h3>è¿›å…¥æ­£å¼å®éªŒå‰ï¼Œæ‚¨éœ€å®Œæˆä»¥ä¸‹ä»»åŠ¡</h3>
        <ul>
          æ­å–œæ‚¨æ‚¨å·²ç»å®Œæˆç»ƒä¹ éƒ¨åˆ†ï¼Œæ¥ä¸‹æ¥ä¼šæœ‰çŸ­æš‚åŠ è½½è”ç½‘é˜¶æ®µ(2-3åˆ†é’Ÿ)ï¼ŒåŠ è½½å®Œæˆåå°†æ­£å¼è¿›å…¥â€œå®éªŒç½‘ç»œç¤¾åŒºâ€å¹³å°ã€‚
          æ­¤æ®µæ—¶é—´éœ€è¦æ‚¨æ‹¿èµ·åˆšåˆšå®Œæˆçš„ä¹¦å†™ä»»åŠ¡å†…å®¹è¿›è¡Œé˜…è¯»å¹¶å°½åŠ›å›å¿†è¿™ä¸‰ä»¶äº‹çš„åœºæ™¯ï¼Œ
          åœ¨æ¥ä¸‹æ¥çš„è°ƒæ•´ä»»åŠ¡ä¸­ä¹Ÿè¯·æ‚¨å¸¦ç€è¿™ä¸€æƒ…ç»ªçŠ¶æ€è¿›è¡Œã€‚ä¸‹é¢è¯·æ‚¨å¼€å§‹é˜…è¯»å¹¶å›å¿†......
        </ul>
      </div>

      <p style="color:var(--muted)">æˆ‘ä»¬æ­£åœ¨æ•´ç†ç»ƒä¹ æ•°æ®å¹¶å‡†å¤‡æ­£å¼é˜¶æ®µï¼Œè¯·ç¨å€™â€¦</p>
     
      <div class="bar" style="width:min(900px,78%);margin-top:10px">
        <span id="postPg" style="width:0%"></span>
      </div>
      <p id="postTip" style="color:var(--muted);font-size:14px;margin-top:6px">èµ„æºå‡†å¤‡ä¸­â€¦</p>
      <button id="btnPostGo" class="btn" disabled>â€œç©ºæ ¼é”®â€å¼€å§‹æ­£å¼å®éªŒ</button>
    </div>
  </section>
</div>
<!-- ========== é¢„é˜¶æ®µç»“æŸ ========== -->

<div class="app" id="communityApp">
  <!-- é¡¶éƒ¨ -->
  <header class="wb-header">
    <div class="wb-inner">
      <div class="wb-left">
        <div class="brand" title="å®éªŒç½‘ç»œç¤¾åŒº">
          <svg width="32" height="32" viewBox="0 0 48 48" aria-hidden="true">
            <defs><linearGradient id="g" x1="0" y="0" x2="1" y="1"><stop offset="0" stop-color="#35c9ff"/><stop offset=".8" stop-color="#22d3ee"/></linearGradient></defs>
            <rect x="2" y="2" rx="10" ry="10" width="44" height="44" fill="url(#g)"/>
            <path d="M16 18c4-3 12-3 16 0M18 18c-2 6 0 10 6 12M30 18c2 6 0 10-6 12" fill="none" stroke="#061724" stroke-width="2.6" stroke-linecap="round"/>
            <circle cx="24" cy="24" r="2.6" fill="#061724"/>
          </svg>
          <span>å®éªŒç½‘ç»œç¤¾åŒº   Experimental Network Community</span>
        </div>
        <div class="wb-search">
         
        </div>
      </div>
      <nav class="wb-center" aria-label="ä¸»èœå•">
        <div class="wb-tab active"><svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M3 10.5L12 3l9 7.5V21a1 1 0 0 1-1 1h-6v-6H10v6H4a1 1 0 0 1-1-1v-10.5Z" stroke="#bfe6ff" stroke-width="1.6" stroke-linejoin="round"/></svg><span>é¦–é¡µ</span></div>
        <div class="wb-tab"><svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M12 2l1.9 4 4.4.6-3.2 3.2.8 4.5-3.9-2.1-3.9 2.1.8-4.5L5.7 6.6 10.1 6 12 2Z" stroke="#e5f2ff" stroke-width="1.6" stroke-linejoin="round"/></svg><span>çƒ­æ¦œ</span></div>
        <div class="wb-tab"><svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M12 2l1.9 4 4.4.6-3.2 3.2.8 4.5-3.9-2.1-3.9 2.1.8-4.5L5.7 6.6 10.1 6 12 2Z" stroke="#e5f2ff" stroke-width="1.6" stroke-linejoin="round"/></svg><span>è§†é¢‘</span></div>
        <div class="wb-tab"><svg width="22" height="22" viewBox="0 0 24 24" fill="none"><rect x="3" y="5" width="18" height="14" rx="2" stroke="#e5f2ff" stroke-width="1.6"/><path d="M6 7h12v2H6zM6 11h6v2H6z" fill="#e5f2ff"/></svg><span>ç§ä¿¡</span></div>
      </nav>
      <div class="wb-right">
        <div class="wb-icon" title="äº‘"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 18h11a4 4 0 0 0 0-8h-.3A6 6 0 1 0 6 18Z" stroke="#e5f2ff" stroke-width="1.6"/></svg></div>
        <div class="wb-icon" title="è®¾ç½®"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" stroke="#e5f2ff" stroke-width="1.6"/><path d="M19 12a7 7 0 0 1-.2 1.7l2 1.5-2 3.4-2.3-1a7 7 0 0 1-2.6 1.5l-.3 2.5H12l-.6 2.5a7 7 0 0 1-2.6-1.5l-2.3 1-2-3.4 2-1.5A7 7 0  0 1 5 12c0-.6.1-1.1.2-1.7l-2-1.5 2-3.4 2.3 1a7 7 0 0 1 2.6-1.5L11.4 2h1.2l.6 2.5a7 7 0 0 1 2.6 1.5l2.3-1 2 3.4-2  1.5c(.1).6.2 1.1.2 1.7Z" stroke="#cfe6ff" stroke-width="1.2"/></svg></div>
        
      </div>
    </div>
  </header>

  <!-- ä¸»ä½“ -->
  <div class="layout">
    <!-- å·¦ä¾§ -->
    <aside class="panel nav">
      <div class="sec">å¯¼èˆª</div>
      <a class="active" href="#"><span class="ico">ğŸ </span> é¦–é¡µ</a>
      <a href="#"><span class="ico">ğŸ“–</span> æ´»åŠ¨è§„åˆ™</a>
      <div style="height:8px"></div>
      <div class="sec">çƒ­é—¨è¯é¢˜</div>
      <div class="tags">
        <a class="tag" href="#">æˆ‘çš„ä½“å‹æ•…äº‹</a>
        <a class="tag" href="#">ç†æƒ³ç›®æ ‡</a>
        <a class="tag" href="#">å±•ç¤ºèˆå°</a>
      </div>
      <div class="status" style="margin-top:auto">
        <div class="sec">åœ¨çº¿ï¼ˆå®æ—¶ï¼‰</div>
        <div style="display:flex;align-items:center;justify-content:space-between;margin:4px 6px 8px">
          <span style="font-size:12px;padding:4px 8px;border:1px solid var(--line);border-radius:999px;color:var(--muted)">å½“å‰åœ¨çº¿ <span id="onlineLeft">â€”</span></span>
        </div>
        <div class="avatars" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding:8px 4px">
          <div class="avatar"><div class="img" style="width:44px;height:44px;border-radius:50%;background:#1a2534 center/cover no-repeat;border:1px solid #2e3f52;background-image:url('https://picsum.photos/seed/a/80')"></div><label style="font-size:12px;color:var(--muted)">20224011021_1533</label></div>
          <div class="avatar"><div class="img" style="width:44px;height:44px;border-radius:50%;background:#1a2534 center/cover no-repeat;border:1px solid #2e3f52;background-image:url('https://picsum.photos/seed/b/80')"></div><label style="font-size:12px;color:var(--muted)">20234015023_7893</label></div>
          <div class="avatar"><div class="img" style="width:44px;height:44px;border-radius:50%;background:#1a2534 center/cover no-repeat;border:1px solid #2e3f52;background-image:url('https://picsum.photos/seed/c/80')"></div><label style="font-size:12px;color:var(--muted)">20244402321_7547</label></div>
          <div class="avatar"><div class="img" style="width:44px;height:44px;border-radius:50%;background:#1a2534 center/cover no-repeat;border:1px solid #2e3f52;background-image:url('https://picsum.photos/seed/d/80')"></div><label style="font-size:12px;color:var(--muted)">20224005003_7746</label></div>
          <div class="avatar"><div class="img" style="width:44px;height:44px;border-radius:50%;background:#1a2534 center/cover no-repeat;border:1px solid #2e3f52;background-image:url('https://picsum.photos/seed/e/80')"></div><label style="font-size:12px;color:var(--muted)">20244521024_0021</label></div>
          <div class="avatar"><div class="img" style="width:44px;height:44px;border-radius:50%;background:#1a2534 center/cover no-repeat;border:1px solid #2e3f52;background-image:url('https://picsum.photos/seed/f/80')"></div><label style="font-size:12px;color:var(--muted)">20234021011_1963</label></div>
          <div class="avatar"><div class="img" style="width:44px;height:44px;border-radius:50%;background:#1a2534 center/cover no-repeat;border:1px solid #2e3f52;background-image:url('https://picsum.photos/seed/g/80')"></div><label style="font-size:12px;color:var(--muted)">20234001029_1569</label></div>
          <div class="avatar"><div class="img" style="width:44px;height:44px;border-radius:50%;background:#1a2534 center/cover no-repeat;border:1px solid #2e3f52;background-image:url('https://picsum.photos/seed/h/80')"></div><label style="font-size:12px;color:var(--muted)">20234061025_1234</label></div>
          <div class="avatar"><div class="img" style="width:44px;height:44px;border-radius:50%;background:#1a2534 center/cover no-repeat;border:1px solid #2e3f52;background-image:url('https://picsum.photos/seed/i/80')"></div><label style="font-size:12px;color:var(--muted)">20244011001_1532</label></div>
        </div>
      </div>
    </aside>

    <!-- ä¸­æ ï¼šå‘å¸ƒæ  / è§†å£ / å®æ—¶åŠ¨æ€ -->
    <main class="panel main">

      <section class="main-tip" aria-label="æç¤ºæ ‡é¢˜">
        <div class="title">ğŸ”µæ‚¨æ­£åœ¨å…¬å¼€å±•ç¤ºæƒ…æ™¯ï¼Œå®æ—¶è°ƒæ•´è¿‡ç¨‹å°†å…¬ç¤ºåœ¨ç¤¾åŒºå…¬ç¤ºçª—</div>
      </section>

      <!-- å®éªŒåµŒå¥— -->
      <section class="viewport" aria-label="ä½“å‹è°ƒæ•´å®éªŒè§†å£">
        <div class="center-note" id="note" style="display:none">
          <div>
           <p>æ­£å¼å®éªŒå¼€å§‹ï¼</p>
           <p>â€œå½“å‰ä½“å‹â€è°ƒæ•´ä»»åŠ¡ï¼ˆå…±10 æ¬¡ï¼‰ï¼</p>
           <p>ç°åœ¨ï¼Œæ‚¨å°†é€šè¿‡"F"é”®ä¸"J"é”®æ¥è°ƒæ•´å‡ºæœ€æ¥è¿‘æ‚¨å½“å‰çš„ä½“å‹ã€‚</p>
           <p>æŒ‰â€œå›è½¦é”®ï¼ˆEnterï¼‰â€ç¡®è®¤ä¿å­˜è°ƒæ•´ç»“æœï¼ŒæŒ‰â€œç©ºæ ¼é”®â€æ­£å¼å¼€å§‹å®éªŒã€‚</p>
          </div>
        </div>

        <!-- âœ… å®éªŒä¸»æœºä½ -->
        <div id="expHost">
          <canvas id="fxCanvas" aria-hidden="true"></canvas>

          <section id="currentGuidelines" class="screen">
            <div class="panel">
             <p>æ­£å¼å®éªŒå¼€å§‹ï¼</p>
           <p>â€œå½“å‰ä½“å‹â€è°ƒæ•´ä»»åŠ¡ï¼ˆå…±10 æ¬¡ï¼‰ï¼</p>
           <p>ç°åœ¨ï¼Œæ‚¨å°†é€šè¿‡"F"é”®ä¸"J"é”®æ¥è°ƒæ•´å‡ºæœ€æ¥è¿‘æ‚¨å½“å‰çš„ä½“å‹ã€‚</p>
           <p>æŒ‰â€œå›è½¦é”®ï¼ˆEnterï¼‰â€ç¡®è®¤ä¿å­˜è°ƒæ•´ç»“æœï¼ŒæŒ‰â€œç©ºæ ¼é”®â€æ­£å¼å¼€å§‹å®éªŒã€‚</p>
            </div>
          </section>

          <section id="idealGuidelines" class="screen">
            <div class="panel">
             <p>â€œç†æƒ³ä½“å‹â€è°ƒæ•´ä»»åŠ¡ï¼ˆå…±10 æ¬¡ï¼‰ï¼</p>
             <p>ç°åœ¨ï¼Œæ‚¨å°†é€šè¿‡"F"é”®ä¸"J"é”®æ¥è°ƒæ•´æ‚¨çš„ç†æƒ³ä½“å‹ã€‚</p>
             <p>æŒ‰â€œå›è½¦é”®ï¼ˆEnterï¼‰â€ç¡®è®¤ä¿å­˜è°ƒæ•´ç»“æœï¼ŒæŒ‰â€œç©ºæ ¼é”®â€å¼€å§‹å®éªŒã€‚</p>
            </div>
          </section>

          <img id="stimulus" alt="stimulus" decoding="async" loading="eager" fetchpriority="high">
          <div id="fixation">+</div>
          <div class="hint hint-left">é•¿æŒ‰â€œFâ€å˜ç˜¦</div>
          <div class="hint hint-right">é•¿æŒ‰â€œJâ€å˜èƒ–</div>
          <div id="currentTypeLabel"><p>è°ƒè‡³ä¸æ‚¨<b>å½“å‰æœ€ç›¸è¿‘</b>çš„ä½“å‹ï¼ŒæŒ‰ <b>Enter</b>ã€‚</p></div>
          <div id="idealTypeLabel"><p>è°ƒè‡³æ‚¨çš„<b>ç†æƒ³ä½“å‹</b>ï¼ŒæŒ‰ <b>Enter</b>ã€‚</p></div>
          <div id="practicePrompt" style="color:#cfe8ff;display:none">ç†Ÿæ‚‰åå¯æŒ‰ <b>Enter</b> ç»“æŸæœ¬æ¬¡ç»ƒä¹ </div>

          <!-- ï¼ˆå·²ç§»é™¤ï¼šæ„Ÿè°¢é¡µä¸å†åµŒå¥—åœ¨ UI ä¸­ï¼‰ -->

          <div id="overlayUploading" style="display:none;background:rgba(0,0,0,.55);color:#fff;z-index:9;align-items:center;justify-content:center;flex-direction:column;">
            <div style="font-size:16px;margin-bottom:8px">æ­£åœ¨ä¸Šä¼ æ•°æ®ï¼Œè¯·ç¨å€™â€¦</div>
            <div class="bar" style="width:260px;height:12px"><span style="width:100%"></span></div>
          </div>
          <div id="overlayFailed" style="display:none;background:rgba(0,0,0,.60);color:#fff;z-index:9;align-items:center;justify-content:center;flex-direction:column;">
            <div style="font-size:16px;margin-bottom:10px">ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•</div>
            <button id="btnRetryUpload" class="btn">é‡è¯•ä¸Šä¼ </button>
          </div>
        </div>
      </section>

      <div class="ticker" aria-live="polite">
        <ul id="tickerList"></ul>
      </div>
    </main>

    <!-- å³ä¾§é¢æ¿ -->
    <aside class="panel aside">
      <section class="card">
        <div class="subject">
          <div class="big-av" id="subjectAvatar" style="background-image:url('https://picsum.photos/seed/subject/120')"></div>
          <div class="meta">
            <span class="pill">æ­£åœ¨è°ƒæ•´</span>
            <span class="id" id="subjectId">20234018028-2724</span>
          </div>
        </div>
      </section>
      <section class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
          <div style="font-weight:600">æ­£åœ¨å‚ä¸è€…</div>
          <span class="pill">å…¬ç¤ºçª—</span>
        </div>
        <div class="peers-grid" id="peers"></div>
      </section>
      <section class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
          <div style="font-weight:600">æˆ‘çš„è°ƒæ•´å…¬ç¤º</div>
          <span class="pill" id="selfStage">å½“å‰ä½“å‹</span>
        </div>
        <div class="self-vp"><img id="selfImg" alt="æˆ‘çš„å®æ—¶é¢„è§ˆ" loading="lazy" decoding="async"></div>
        <div class="progress">
          <div class="label"><span id="taskStage">å½“å‰ä½“å‹</span><span id="taskCount">0/10</span></div>
          <div class="bar"><span id="taskBar"></span></div>
        </div>

            
          </div>
        </div>
      </section>
    </aside>

  </div>
</div>

<!-- â˜…â˜…â˜… æ–°ä½ç½®ï¼šæ„Ÿè°¢é¡µï¼ˆä¸åœ¨ UI åµŒå¥—ä¸‹ï¼‰ -->
<section id="thankYou" class="screen">
  <div class="panel">
    <p>è¯·å¤‡æ³¨å­¦å·ä¸æ‰‹æœºå·å4ä½ï¼Œæ·»åŠ ä¸»è¯•å¾®ä¿¡é¢†å–æŠ¥é…¬ã€‚</p>
    <p>æŒ‰ â€œESCâ€ å…³é—­é¡µé¢ã€‚</p>
    <h1>å®éªŒç»“æŸï¼Œæ„Ÿè°¢å‚ä¸ï¼</h1>
  </div>
</section>

<!-- COS SDKï¼ˆä¾›å®éªŒä¸Šä¼ ï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js"></script>

<script>
/* ========== å·¦æ åœ¨çº¿äººæ•° / å³ä¾§å…¬ç¤ºçª— ========== */
(function(){const left=document.getElementById('onlineLeft');let n=11; const set=v=>left.textContent=v+' äºº'; set(n); setInterval(()=>{ n=Math.max(5,n+(Math.random()>.5?1:-1)); set(n); }, 3000);})();
(function(){
  const peers=document.getElementById('peers');
  const names=['20224011021_1533','20234015023_7893','20224005003_7746','20244402321_7547','20244521024_0021','20234021011_1963','20234001029_1569','20234061025_1234','20244011001_1532','20244021022_7532','20234031031_1332','20234031021_3312'];
  const pick=a=>a[Math.floor(Math.random()*a.length)];

  /* â€”â€” ä½¿ç”¨ä¸æ­£å¼å®éªŒä¸€è‡´çš„ä½“å‹åºåˆ—èµ„æº â€”â€” */
  const IS_PROD = location.hostname.endsWith('github.io');
  const SITE_BASE = IS_PROD ? 'https://BodyImageLab.github.io/body-shape-experiment_xiaowu/' : './';
  const BASE_URL_F = SITE_BASE + 'img_F/';
  const BASE_URL_M = SITE_BASE + 'img_M/';
  const MAX_F = 76, MAX_M = 76; const F_EXT='png', M_EXT='png';
  const imgURL = (series, idx)=> (series==='M' ? (BASE_URL_M + 'M' + (idx+1) + '.' + M_EXT) : (BASE_URL_F + 'F' + (idx+1) + '.' + F_EXT));

  /* â€”â€” ç”Ÿæˆå¡ç‰‡ï¼šé»˜è®¤â€œæ­£åœ¨è°ƒæ•´â€¦â€ï¼Œå¹¶åœ¨è¿›åº¦ç¯ä¸­å¿ƒæ”¾å¤´åƒ â€”â€” */
  for(let i=0;i<6;i++){
    const card=document.createElement('div'); card.className='peer';

    // éšæœºæ€§åˆ«ä¸åˆå§‹ç´¢å¼•ï¼ˆå›´ç»•åºåˆ—ä¸­æ®µæ›´è‡ªç„¶ï¼‰
    const series = Math.random()>.5 ? 'F' : 'M';
    const max = series==='M'?MAX_M:MAX_F;
    const startIdx = Math.max(0, Math.min(max-1, Math.floor(max*0.25 + Math.random()*max*0.5)));
    const dir = Math.random()>.5 ? 1 : -1;

    // å›ºå®šå¤´åƒï¼ˆä¸é—ªçƒï¼‰
    const avSeed = Math.floor(Math.random()*1000);
    const avatarURL = `https://picsum.photos/seed/av-${avSeed}/60/60`;

    // å¡ç‰‡ DOM
    card.innerHTML=`
      <div class="peer-vp">
        <img alt="å‚ä¸è€…é¢„è§ˆ">
        <div class="ring" style="--p:0"><span class="av" style="background-image:url('${avatarURL}')"></span></div>
      </div>
      <div class="peer-meta"><span class="n">${pick(names)}</span><span class="t">æ­£åœ¨è°ƒæ•´â€¦</span></div>`;

    // è®°å½•çŠ¶æ€
    const vpImg = card.querySelector('img');
    card.dataset.series = series;
    card.dataset.idx = String(startIdx);
    card.dataset.dir = String(dir);
    card.dataset.p = (Math.random()*0.2).toFixed(3);
    if(i>0) card.dataset.forceAdjust = '1'; // éç¬¬ä¸€å¼ å¼ºåˆ¶ä¿æŒâ€œæ­£åœ¨è°ƒæ•´â€¦â€

    // åˆå§‹æ˜¾ç¤ºä½“å‹å›¾
    vpImg.src = imgURL(series, startIdx);

    peers.appendChild(card);
  }

  const cards=[...peers.children];

  /* â˜…â˜…â˜… è¿›åº¦ç¯â€”â€”éå¸¸æ…¢æ¨è¿›ï¼ˆé™¤ç¬¬ä¸€å¼ ç”±ä¸»æµç¨‹æ§åˆ¶å¤–ï¼‰ */
  setInterval(()=>{
    cards.forEach((card)=>{
      if (card.dataset && card.dataset.locked==='1') return; // ç¬¬ä¸€å¼ ç”±ä¸»æµç¨‹é©±åŠ¨
      let p = parseFloat(card.dataset.p||'0');
      const step = 0.0008 + Math.random()*0.0012; // æ…¢é€Ÿæ¨è¿›
      p = Math.min(0.985, p + step);
      card.dataset.p = p.toFixed(3);
      const ring = card.querySelector('.ring'); if(ring) ring.style.setProperty('--p', p);
      const t = card.querySelector('.t'); if (t && card.dataset.forceAdjust==='1') t.textContent='æ­£åœ¨è°ƒæ•´â€¦';
    });
  }, 3600);

  /* â˜…â˜…â˜… æ¨¡æ‹Ÿä½“å‹â€œè½»å¾®è°ƒæ•´â€ï¼šå°æ­¥è¿›ã€æ¥å›ç¼“åŠ¨ï¼ˆä¸æ›´æ¢å¤´åƒï¼Œä¸ç”¨éšæœºç…§ç‰‡ï¼‰ */
  setInterval(()=>{
    cards.forEach((card, i)=>{
      if (card.dataset && card.dataset.locked==='1') return; // ç¬¬ä¸€å¼ äº¤ç”±ä¸»æµç¨‹
      const series = card.dataset.series||'F';
      const max = series==='M'?MAX_M:MAX_F;
      let idx = parseInt(card.dataset.idx||'0',10);
      let dir = parseInt(card.dataset.dir||'1',10);

      // ä»¥ 1 æ­¥ä¸ºä¸»ï¼Œå¶å°” 2 æ­¥ï¼›åˆ°è¾¹ç•Œåå¼¹ï¼›å¹¶åœ¨ä¸­æ®µéšæœºæ¢å‘ï¼Œé¿å…æœºæ¢°æ„Ÿ
      const delta = (Math.random()<0.12 ? 2 : 1) * dir;
      idx += delta;
      if (idx<=0 || idx>=max-1) { dir = -dir; idx = Math.max(0, Math.min(max-1, idx)); }
      else if (Math.random()<0.06) { dir = -dir; }

      card.dataset.idx = String(idx);
      card.dataset.dir = String(dir);

      const img = card.querySelector('img');
      if (img) img.src = imgURL(series, idx);

      const t = card.querySelector('.t');
      if (t && card.dataset.forceAdjust==='1') t.textContent='æ­£åœ¨è°ƒæ•´â€¦';
    });
  }, 1400); // çº¦ 1.4 ç§’ä¸€å°æ­¥ï¼Œç»†è…»ä¸”ä¸çªå…€
})();

/* â€”â€” åˆ é™¤åŸæœ¬â€œè‡ªæˆ‘é¢„è§ˆ/è¿›åº¦â€çš„æ¼”ç¤ºè½®æ’­ï¼Œæ”¹ç”±æ­£å¼å®éªŒå®æ—¶é©±åŠ¨ â€”â€” */

(function(){
  const ul=document.getElementById('tickerList');
  ['âœ… 20224011021_1533 åˆšåˆšå®Œæˆäº†å®éªŒ Â· å…¬ç¤ºå·²ç”Ÿæˆ',
   'âœ… 20234015023_7893 å®Œæˆâ€œç†æƒ³ä½“å‹â€è°ƒæ•´ Â· å…¬å¼€å¯è§',
   'âœ… 20224005003_7746 æäº¤æ•°æ®æˆåŠŸ Â· å·®å€¼â‰ˆ2',
   'âœ… 20244402321_7547 å®Œæˆâ€œå½“å‰ä½“å‹â€è°ƒæ•´ Â· è¿›å…¥åç»­',
   'âœ… 20244521024_0021 ç»“æŸå®éªŒ Â· æ„Ÿè°¢å‚ä¸'].forEach(m=>{
     const li=document.createElement('li'); li.innerHTML=`<span class="dot"></span><span>${m}</span>`; ul.appendChild(li);
   });
  setInterval(()=>{
    if(ul.children.length<=1) return;
    ul.style.transition='transform .45s ease';
    ul.style.transform='translateY(-52px)';
    setTimeout(()=>{ ul.style.transition='none'; ul.appendChild(ul.children[0]); ul.style.transform='translateY(0)'; }, 480);
  }, 2600);
})();

/* ========== å®éªŒè„šæœ¬ ========== */
{
/* ===== å¸¸é‡ ===== */
const STS_URL    = 'https://bodyshape2025-8gk5msghc2121838-1373390636.ap-shanghai.app.tcloudbase.com/cos-sts-event';
const COS_BUCKET = 'bodyshape-data-1373390636';
const COS_REGION = 'ap-shanghai';

/* ===== å›¾ç‰‡èµ„æºè·¯å¾„ ===== */
const IS_PROD   = location.hostname.endsWith('github.io');
const SITE_BASE = IS_PROD ? 'https://BodyImageLab.github.io/body-shape-experiment_xiaowu/' : './';
const BASE_URL_F = SITE_BASE + 'img_F/';
const BASE_URL_M = SITE_BASE + 'img_M/';

const MAX_F = 76, MAX_M = 76;
const F_EXT = 'png', M_EXT = 'png';
let F_LIST = [], M_LIST = [];

// è¯•æ¬¡æ•°/æ—¶åº/é¢‘ç‡
const PRACTICE_TRIALS = 3;
const CURRENT_TRIALS  = 10;
const IDEAL_TRIALS    = 10;
const FIX_MS = 800;
const HOLD_INTERVAL = 70;

/* ===== DOM/çŠ¶æ€ ===== */
const exp = document.getElementById('expHost');
function $(id){ return document.getElementById(id); }

const screens = {
  notice: $('notice'),
  guide: $('guidelines'),
  pracG: $('practiceGuidelines'),
  postG: $('postPractice'),        // â˜… æ–°å¢ï¼šç»ƒä¹ ç»“æŸè¿‡æ¸¡é¡µ
  currG: $('currentGuidelines'),
  idealG: $('idealGuidelines'),
  thank: $('thankYou')
};
const preloadPg = $('preloadPg');
const preloadTip = $('preloadTip');
const btnStartPractice = $('btnStartPractice');
const maleBtn = $('maleButton');
const femaleBtn = $('femaleButton');
const btnNoticeNext = $('btnNoticeNext');

const stimulus = $('stimulus');
const fixation = $('fixation');
const hintL = exp.querySelector('.hint-left');
const hintR = exp.querySelector('.hint-right');
const labelCurrent = $('currentTypeLabel');
const labelIdeal = $('idealTypeLabel');
const practicePrompt = $('practicePrompt');

const studentIdEl     = $('studentId');
const subjectNumberEl = $('subjectNumber');

// === æ–°å¢ï¼šæ ¹æ®è¾“å…¥æ‹¼å‡ºâ€œå­¦å·_å°¾å·â€ï¼Œå¹¶å®æ—¶æ›´æ–°å³ä¾§æ  ===
function buildSubjectCode(){
  const sidRaw  = (studentIdEl?.value || '').trim().replace(/\D/g, '');
  const telRaw  = (subjectNumberEl?.value || '').trim().replace(/\D/g, '');
  const telTail = telRaw.slice(-4);
  if (!sidRaw || !telTail) return 'â€”â€”';
  return `${sidRaw}_${telTail}`;
}

function syncSubjectHeader(){
  const code = buildSubjectCode();
  const idEl = document.getElementById('subjectId');
  const avEl = document.getElementById('subjectAvatar');
  if (idEl) idEl.textContent = code;
  if (avEl) {
    avEl.style.backgroundImage =
      `url('https://picsum.photos/seed/subject-${encodeURIComponent(code)}/120')`;
  }
}

// è¾“å…¥æ—¶å®æ—¶åˆ·æ–°
studentIdEl     && studentIdEl.addEventListener('input',  syncSubjectHeader);
subjectNumberEl && subjectNumberEl.addEventListener('input', syncSubjectHeader);
syncSubjectHeader(); // åˆå§‹åŒ–ä¸€æ¬¡
// === æ–°å¢ç»“æŸ ===

let gender = null, series = 'F', imgList = [];
let idx = 0, holdTimer = null, holdKey = null, adjusting = false, preloaded = false;
let practiceTrial = 0, currentTrial = 0, idealTrial = 0;
let currentStarts = [], idealStarts = [];
let t0 = 0, startIdx = 0, enterLocked = false, experimentStartTime = 0;
let taskType = 'ç»ƒä¹ ';
let results = [];
let sessionId = null;
let pendingIndex = null;

/* â˜…â˜…â˜… æ–°å¢ï¼šç»ƒä¹ é˜¶æ®µ DOMï¼ˆåœ¨ preStage å†…ï¼‰ â˜…â˜…â˜… */
const pHost = $('practiceHost');
const pStimulus = $('pStimulus');
const pFixation = $('pFixation');
const pHintL = $('pHintL');
const pHintR = $('pHintR');
const pPracticePrompt = $('pPracticePrompt');

/* â˜…â˜…â˜… æ–°å¢ï¼šHost é€‰æ‹©å™¨ä¸å¼€å…³ â˜…â˜…â˜… */
function elStim(){ return (taskType==='ç»ƒä¹ ') ? pStimulus : stimulus; }
function elFix(){ return (taskType==='ç»ƒä¹ ') ? pFixation : fixation; }
function elHintLeft(){ return (taskType==='ç»ƒä¹ ') ? pHintL : hintL; }
function elHintRight(){ return (taskType==='ç»ƒä¹ ') ? pHintR : hintR; }
function elPracticePrompt(){ return (taskType==='ç»ƒä¹ ') ? pPracticePrompt : practicePrompt; }
function usePracticeHost(on){ if(pHost){ pHost.style.display = on ? 'block' : 'none'; } }

/* ===== åŒæ„é¡µï¼šæŒ‰é’®å¯ç‚¹ä¸è¿›åº¦ ===== */
const agree = $('agree');
const noticePg = $('noticePg');

function runNoticeProgress(){
  return new Promise(resolve=>{
    let w = 0;
    noticePg && (noticePg.style.width = '0%');
    const timer = setInterval(()=>{
      w += 12 + Math.random()*18;
      if (w >= 100){
        w = 100; clearInterval(timer); resolve();
      }
      noticePg && (noticePg.style.width = w.toFixed(0) + '%');
    }, 120);
  });
}

if (agree && btnNoticeNext){
  function syncAgree(){
    const ok = !!agree.checked;
    btnNoticeNext.disabled = !ok;
    btnNoticeNext.setAttribute('aria-disabled', String(!ok));
  }
  ['change','input','click','keyup'].forEach(ev => agree.addEventListener(ev, syncAgree));
  window.addEventListener('load', syncAgree);

  btnNoticeNext.addEventListener('click', async (e)=>{
    if (btnNoticeNext.disabled) return;
    btnNoticeNext.disabled = true;
    await runNoticeProgress();
    enterFullscreen();
    showScreen('guide');
  });
}

/* ===== èƒŒæ™¯ç²’å­ï¼ˆæŒ‰é¡µé¢é€‰æ‹©ç”»å¸ƒï¼šé¢„é˜¶æ®µç”¨ preFxCanvasï¼Œç¤¾åŒºé˜¶æ®µç”¨ fxCanvasï¼‰ ===== */
const FX_PAGES = new Set([
  'notice',          // å¯åŠ¨é¡µï¼ˆé¢„é˜¶æ®µï¼‰
  'guide',           // æŒ‡å¯¼è¯­ï¼ˆé¢„é˜¶æ®µï¼‰
  'postG',           // ç»ƒä¹ ç»“æŸè¿‡æ¸¡é¡µï¼ˆé¢„é˜¶æ®µï¼‰
  'thank'            // æ„Ÿè°¢é¡µï¼ˆç¤¾åŒºï¼‰
]);

let bgFX = null;

function mountFX(screenKey){
  // æ¯æ¬¡åˆ‡æ¢é¡µé¢æ—¶ï¼Œé”€æ¯æ—§å®ä¾‹ï¼Œé‡æ–°é’ˆå¯¹å½“å‰å®¹å™¨æŒ‚è½½
  if (bgFX) bgFX.destroy();

  const isPreStage = (screenKey === 'notice' || screenKey === 'guide' || screenKey === 'pracG' || screenKey === 'postG');
  const container  = isPreStage ? document.getElementById('preStage') : document.getElementById('expHost');
  const cvs        = isPreStage ? document.getElementById('preFxCanvas') : document.getElementById('fxCanvas');

  if (!container || !cvs) return;

  const ctx = cvs.getContext('2d');
  const DPR = Math.min(2, window.devicePixelRatio || 1);
  const reduce = matchMedia('(prefers-reduced-motion: reduce)').matches;
  let W=0, H=0, t=0, rafId=null, bubbles=[];

  function resize(){
    const rect = container.getBoundingClientRect();
    // é˜²æ­¢ 0 å®½é«˜
    const w = Math.max(1, rect.width);
    const h = Math.max(1, rect.height);
    cvs.width  = w * DPR;
    cvs.height = h * DPR;
    cvs.style.width  = w + 'px';
    cvs.style.height = h + 'px';
    W=cvs.width; H=cvs.height;
    init();
  }
  function init(){
    const n = reduce ? 30 : 70;
    bubbles.length = 0;
    for(let i=0;i<n;i++){
      const z = Math.random();
      const r = (6 + 20*z) * DPR;
      const x = Math.random()*W;
      const y = Math.random()*H;
      const vy = (-.2 - 1.2*z) * DPR;
      const hue = 200 + 20*z;
      bubbles.push({x,y,r,vy,z,hue,tw:Math.random()*Math.PI*2});
    }
  }
  function draw(){
    t += 0.005;
    ctx.clearRect(0,0,W,H);
    for(const b of bubbles){
      b.y += b.vy*(.7 + .3*Math.sin(b.tw + t*2));
      if (b.y + b.r < 0) { b.y = H + b.r; b.x = Math.random()*W; }
      ctx.save(); ctx.globalCompositeOperation = 'lighter';
      const g = ctx.createRadialGradient(b.x, b.y, b.r*0.1, b.x, b.y, b.r);
      g.addColorStop(0, `hsla(${b.hue},85%,70%,.35)`);
      g.addColorStop(.6, `hsla(${b.hue+10},85%,65%,.10)`);
      g.addColorStop(1, 'rgba(0,0,0,0)');
      ctx.fillStyle = g; ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, Math.PI*2); ctx.fill();
      ctx.restore();
    }
    rafId = requestAnimationFrame(draw);
  }

  const onResize = ()=>resize();
  window.addEventListener('resize', onResize);
  resize();
  if(!reduce){ draw(); }

  bgFX = {
    destroy(){
      if (rafId) cancelAnimationFrame(rafId);
      window.removeEventListener('resize', onResize);
      const k = cvs.getContext('2d'); if (k) k.clearRect(0,0,cvs.width,cvs.height);
      bgFX = null;
    }
  };
}

function unmountFX(){ if (bgFX) bgFX.destroy(); }

function maybeToggleFXFor(screenKey){
  if (FX_PAGES.has(screenKey)) mountFX(screenKey);
  else unmountFX();
}


/* ===== å·¥å…·å‡½æ•° ===== */
function enterFullscreen(){ const el=document.documentElement; if (el.requestFullscreen) el.requestFullscreen().catch(()=>{}); }
function showScreen(key){
  Object.values(screens).forEach(s=>s && s.classList.remove('active'));
  screens[key] && screens[key].classList.add('active');
  maybeToggleFXFor(key);
}
/* æ”¾åœ¨ä½ ç°æœ‰çš„å·¥å…·å‡½æ•°é™„è¿‘ï¼ˆæœ‰ enterFullscreen çš„ä½ç½®ï¼‰ */

function isFullscreen() {
  return !!(document.fullscreenElement ||
            document.webkitFullscreenElement ||
            document.msFullscreenElement);
}

function toggleFullscreen(el = document.documentElement) {
  if (isFullscreen()) {
    (document.exitFullscreen ||
     document.webkitExitFullscreen ||
     document.msExitFullscreen)?.call(document);
  } else {
    (el.requestFullscreen ||
     el.webkitRequestFullscreen ||
     el.msRequestFullscreen)?.call(el).catch?.(()=>{});
  }
}

/* å…¨å±€çƒ­é”®ï¼šF10 åˆ‡æ¢å…¨å±ï¼ˆä¸ä¸ F/J/Enter/Space å†²çªï¼‰ */
window.addEventListener('keydown', (e) => {
  if (e.code === 'F10') {
    e.preventDefault();
    e.stopPropagation();   // é˜²æ­¢å†’æ³¡å½±å“å…¶ä»–é€»è¾‘
    toggleFullscreen();
  }
});

const activeKey = Object.entries(screens).find(([k,el])=>el && el.classList.contains('active'))?.[0] || 'notice';
maybeToggleFXFor(activeKey);

/* ===== é¢„åŠ è½½ ===== */
function genNames(prefix, n, ext){ const a=[]; for (let i=1;i<=n;i++) a.push(`${prefix}${i}.${ext}`); return a; }
function clamp(v,lo,hi){ return Math.min(hi, Math.max(lo,v)); }
function getSeriesURLs(which){
  if (which === 'M'){ const names = M_LIST.length ? M_LIST : genNames('M', MAX_M, M_EXT); return names.map(n => BASE_URL_M + n); }
  else { const names = F_LIST.length ? F_LIST : genNames('F', MAX_F, F_EXT); return names.map(n => BASE_URL_F + n); }
}
async function preloadAll(urls){
  if (!urls.length) return;
  let done = 0, total = urls.length;
  const upd = ()=>{ if(preloadPg) preloadPg.style.width = ((done/total)*100).toFixed(1) + '%'; };
  for (const u of urls) {
    const im = new Image(); im.loading='eager'; im.decoding='async'; im.src=u;
    try { await im.decode(); } catch(e) {}
    done++; upd();
  }
}

/* ===== BMI æ˜ å°„ ===== */
function bmiFromIndex(series, index){
  if (series === 'F'){ return +(10.8 + index * 0.432).toFixed(2); }
  else { return +(11.8 + index * 0.472).toFixed(2); }
}

/* ===== å³ä¾§è”åŠ¨ï¼šè‡ªæˆ‘é¢„è§ˆ & å…¬ç¤ºçª—â€œè¿›è¡Œä¸­â€ ===== */
function updateSelfPanel(){
  const stageEl = $('taskStage');
  const pillStageEl = $('selfStage');
  const countEl = $('taskCount');
  const barEl = $('taskBar');
  let total=0, done=0, stageText = taskType;

  if (taskType==='å½“å‰ä½“å‹'){ total = 10; done = currentTrial; }
  else if (taskType==='ç†æƒ³ä½“å‹'){ total = 10; done = idealTrial; }
  else { total = PRACTICE_TRIALS; done = practiceTrial; }

  stageEl && (stageEl.textContent = stageText);
  pillStageEl && (pillStageEl.textContent = stageText);
  countEl && (countEl.textContent = done + '/' + total);
  barEl && (barEl.style.width = (total ? (done/total)*100 : 0) + '%');

  if (taskType!=='ç»ƒä¹ '){
    const imgEl = $('selfImg');
    const src = elStim().src;
    if (imgEl && src) imgEl.src = src;
  }

  const peers = $('peers'); if(peers && peers.children.length){
    const card = peers.children[0];
    const ring = card.querySelector('.ring');
    if (ring){
      const p = total ? (done/total) : 0;
      ring.style.setProperty('--p', p);
    }
  }
}
function lockSelfPeerCard(){
  const peers = $('peers'); if(!peers || !peers.children.length) return;
  const card = peers.children[0]; card.dataset.locked = '1';
  const img = card.querySelector('img');
  const n = card.querySelector('.n');
  const t = card.querySelector('.t');
  if (img && elStim().src) img.src = elStim().src;
  const myId = $('subjectId')?.textContent || 'æˆ‘';
  if (n) n.textContent = myId;
  if (t) t.textContent = 'æ­£åœ¨è°ƒæ•´â€¦';
}
function unlockSelfPeerCard(){
  const peers = $('peers'); if(!peers || !peers.children.length) return;
  const card = peers.children[0]; if(card.dataset) delete card.dataset.locked;
  const t = card.querySelector('.t'); if (t) t.textContent = 'å·²ç¡®è®¤';
}

/* ===== å‘ˆç°/ç´¢å¼•ï¼ˆåŒºåˆ†ç»ƒä¹ /æ­£å¼ï¼‰ ===== */
function updateStimulus(){
  idx = clamp(idx, 0, imgList.length-1);
  const S = elStim();
  S.src = imgList[idx];
  S.style.display = 'block';

  if (taskType === 'ç»ƒä¹ '){
    elHintLeft().style.display = 'block';
    elHintRight().style.display = 'block';
    elPracticePrompt().style.display = (practiceTrial < PRACTICE_TRIALS) ? 'block' : 'none';
    labelCurrent.style.opacity = 0;
    labelIdeal.style.opacity = 0;
  } else {
    elHintLeft().style.display = 'none';
    elHintRight().style.display = 'none';
    elPracticePrompt().style.display = 'none';
    labelCurrent.style.opacity = (taskType==='å½“å‰ä½“å‹') ? 1 : 0;
    labelIdeal.style.opacity   = (taskType==='ç†æƒ³ä½“å‹') ? 1 : 0;
  }

  if (taskType!=='ç»ƒä¹ '){ updateSelfPanel(); lockSelfPeerCard(); }
}
function showFix(){
  elStim().style.display = 'none';
  labelCurrent.style.opacity = 0;
  labelIdeal.style.opacity = 0;
  elHintLeft().style.display = 'none';
  elHintRight().style.display = 'none';
  elPracticePrompt().style.display = 'none';
  elFix().style.display = 'block';
}
function hideFix(){ elFix().style.display = 'none'; }

/* ===== è®°å½• ===== */
function saveRow(){
  results.push({
    task_type: taskType,
    series,
    selected_image: imgList[idx] || '',
    index: idx,
    bmi: bmiFromIndex(series, idx),
    start_index: startIdx,
    response_time: new Date().toISOString(),
    response_duration_ms: Date.now() - t0,
    student_id: (studentIdEl?.value||'').trim(),
    subject_number: (subjectNumberEl?.value||'').trim(),
    gender
  });
}

/* ===== é•¿æŒ‰å¿«é€Ÿæ­¥è¿› ===== */
function startHold(which){ stopHold(); const delta=(which==='f')?-1:+1; step(delta); holdKey=which; holdTimer=setInterval(()=>step(delta),HOLD_INTERVAL); }
function stopHold(){ if (holdTimer){ clearInterval(holdTimer); holdTimer=null; } holdKey=null; }
function step(delta){ if (!adjusting) return; idx = clamp(idx + delta, 0, imgList.length-1); pendingIndex = idx; }

/* ===== æ¸²æŸ“å¾ªç¯ ===== */
function renderLoop(){
  if (pendingIndex !== null){
    elStim().src = imgList[pendingIndex];
    if (taskType!=='ç»ƒä¹ '){ updateSelfPanel(); lockSelfPeerCard(); }
    pendingIndex = null;
  }
  requestAnimationFrame(renderLoop);
}
renderLoop();

/* ===== è¦†ç›–å±‚æ§åˆ¶ ===== */
function showUploadingOverlay(){ const el=document.getElementById('overlayUploading'); el && (el.style.display='flex'); }
function hideUploadingOverlay(){ const el=document.getElementById('overlayUploading'); el && (el.style.display='none'); }
function showUploadFailedOverlay(msg){
  const el = document.getElementById('overlayFailed'); if(!el) return;
  el.style.display='flex';
  const btn = document.getElementById('btnRetryUpload');
  if(btn){ btn.onclick = async ()=>{ el.style.display='none'; showUploadingOverlay();
    try{ await uploadAllResults(); hideUploadingOverlay(); showScreen('thank'); unlockSelfPeerCard(); }
    catch(e){ hideUploadingOverlay(); showUploadFailedOverlay(String(e)); }
  }; }
}

/* ===== ä¸Šä¼  ===== */
function buildPayload(){
  return { sessionId, pid: (studentIdEl?.value||'').trim(), subjectNumber: (subjectNumberEl?.value||'').trim(), gender, rows: results };
}
async function uploadAllResults(){
  const payload = buildPayload();
  const sts = await fetch(STS_URL).then(r=>r.json());
  if (!sts.ok) throw new Error(sts.error || 'Get STS failed');
  const cos = new COS({ getAuthorization: (options, cb) => cb({
      TmpSecretId:  sts.credentials.TmpSecretId,
      TmpSecretKey: sts.credentials.TmpSecretKey,
      SecurityToken: sts.credentials.Token,
      StartTime: Math.floor(Date.now()/1000) - 1,
      ExpiredTime: Math.floor(Date.now()/1000) + 600
    }) });
  const dateDir = new Date().toISOString().slice(0,10);
  const key = `sessions/${dateDir}/${payload.sessionId}.json`;
  await new Promise((resolve,reject)=>{
    cos.putObject({ Bucket: COS_BUCKET, Region: COS_REGION, Key: key,
      Body: new Blob([JSON.stringify(payload)], { type:'application/json' })
    }, (err,data)=>err?reject(err):resolve(data));
  });
  console.log('Uploaded to COS:', key);
  return key;
}

/* ===== æµç¨‹æ§åˆ¶ ===== */
function startPracticeBlock(){ taskType='ç»ƒä¹ '; practiceTrial=0; usePracticeHost(false); showScreen('pracG'); updateSelfPanel(); }
function startCurrentBlock(){
  usePracticeHost(false);

  const pre = document.getElementById('preStage');
  const app = document.getElementById('communityApp');
  if (pre) pre.style.display = 'none';
  if (app) app.style.display = 'grid';

  taskType='å½“å‰ä½“å‹'; currentTrial=0;
  currentStarts = Array(5).fill(0).concat(Array(5).fill(imgList.length-1)).sort(()=>Math.random()-0.5);
  showScreen('currG');
  updateSelfPanel();
}
function startIdealBlock(){
  taskType='ç†æƒ³ä½“å‹'; idealTrial=0;
  idealStarts = Array(5).fill(0).concat(Array(5).fill(imgList.length-1)).sort(()=>Math.random()-0.5);
  showScreen('idealG');
  updateSelfPanel();
}
function startTrial(){
  adjusting = true;
  document.body.classList.add('hide-cursor');

  if (taskType === 'ç»ƒä¹ '){
    usePracticeHost(true);
    idx = Math.floor(Math.random()*imgList.length);
  } else if (taskType === 'å½“å‰ä½“å‹'){
    idx = currentStarts[currentTrial];
  } else if (taskType === 'ç†æƒ³ä½“å‹'){
    idx = idealStarts[idealTrial];
  }
  elStim().style.display='block';
  startIdx = idx;
  updateStimulus();
  t0 = Date.now();
}

/* ===== æ€§åˆ«é€‰æ‹© ===== */
async function chooseGender(g){
  gender = (g==='M') ? 'Male' : 'Female';
  series = (g==='M') ? 'M' : 'F';
  enterFullscreen();
  preloadTip && (preloadTip.textContent = `å·²é€‰æ‹©ï¼š${gender==='Male'?'ç”·æ€§':'å¥³æ€§'}ï¼Œå¼€å§‹é¢„åŠ è½½â€¦`);
  imgList = getSeriesURLs(series);
  btnStartPractice && (btnStartPractice.disabled = true);
  await preloadAll(imgList);
  preloaded = true;
  preloadTip && (preloadTip.textContent = 'é¢„åŠ è½½å®Œæˆã€‚ç°åœ¨å¯ä»¥è¿›å…¥ç»ƒä¹ ã€‚');
  btnStartPractice && (btnStartPractice.disabled = false);
}

/* ===== æ–°å¢ï¼šç»ƒä¹ ç»“æŸè¿‡æ¸¡é¡µé€»è¾‘ ===== */
const postPg   = $('postPg');
const postTip  = $('postTip');
const btnPostGo = $('btnPostGo');

function showPostPracticeGuide(){
  usePracticeHost(false);
  showScreen('postG');

  if (postPg)  postPg.style.width = '0%';
  if (postTip) postTip.textContent = 'èµ„æºå‡†å¤‡ä¸­â€¦';
  if (btnPostGo) btnPostGo.disabled = true;

  let w = 0;
  const timer = setInterval(()=>{
    w += 3 + Math.random()*4;
    if (w >= 100){
      w = 100;
      clearInterval(timer);
      if (postPg)  postPg.style.width = '100%';
      if (postTip) postTip.textContent = 'å‡†å¤‡å°±ç»ªï¼ŒæŒ‰ç©ºæ ¼æˆ–ç‚¹å‡»ç»§ç»­';
      if (btnPostGo) btnPostGo.disabled = false;
    }else{
      if (postPg) postPg.style.width = w.toFixed(0) + '%';
    }
  }, 200);
}
btnPostGo && btnPostGo.addEventListener('click', ()=>{
  if (!btnPostGo.disabled) startCurrentBlock();
});

/* ===== äº‹ä»¶ç»‘å®š ===== */
maleBtn && maleBtn.addEventListener('click', ()=>chooseGender('M'));
femaleBtn && femaleBtn.addEventListener('click', ()=>chooseGender('F'));

btnStartPractice && btnStartPractice.addEventListener('click', ()=>{
  if (!preloaded){ alert('è¯·å…ˆç­‰å¾…é¢„åŠ è½½å®Œæˆ'); return; }
  if (!(studentIdEl?.value && subjectNumberEl?.value)){ alert('è¯·å…ˆå¡«å†™å­¦å·ä¸è¢«è¯•åºå·'); return; }
  const d=new Date(), p=n=>(n<10?'0':'')+n;
  const ts = d.getFullYear()+''+p(d.getMonth()+1)+p(d.getDate())+p(d.getHours())+p(d.getMinutes())+p(d.getSeconds());
  sessionId = `${ts}_${(studentIdEl.value||'').trim()}_${(subjectNumberEl.value||'').trim()}`;
  experimentStartTime = Date.now();
  startPracticeBlock();
});

window.addEventListener('keydown',(e)=>{
  const k = e.key.toLowerCase();
  if (!adjusting){
    if (screens.pracG.classList.contains('active') && k===' '){ Object.values(screens).forEach(s=>s && s.classList.remove('active')); startTrial(); return; }
    if (screens.postG.classList.contains('active') && k===' '){ startCurrentBlock(); return; } // â˜… è¿‡æ¸¡é¡µç©ºæ ¼è¿›å…¥æ­£å¼
    if (screens.currG.classList.contains('active') && k===' '){ Object.values(screens).forEach(s=>s && s.classList.remove('active')); labelCurrent.style.opacity=1; startTrial(); return; }
    if (screens.idealG.classList.contains('active') && k===' '){ Object.values(screens).forEach(s=>s && s.classList.remove('active')); labelIdeal.style.opacity=1; startTrial(); return; }
  }
  if (adjusting){
    if (k==='f' || k==='j'){ if (holdKey!==k) startHold(k); }
    else if (k==='r'){ idx = startIdx; pendingIndex = idx; }
    else if (k==='enter'){
      if (enterLocked) return; enterLocked = true;
      saveRow(); showFix(); adjusting = false; stopHold();
      setTimeout(async ()=>{
        hideFix(); enterLocked = false;
        if (taskType==='ç»ƒä¹ '){
          practiceTrial++;
          if (practiceTrial < PRACTICE_TRIALS) startTrial();
          else showPostPracticeGuide();         // â˜… ç»ƒä¹ ç»“æŸâ†’è¿‡æ¸¡é¡µ
        } else if (taskType==='å½“å‰ä½“å‹'){
          currentTrial++; updateSelfPanel();
          if (currentTrial < CURRENT_TRIALS) startTrial();
          else startIdealBlock();
        } else if (taskType==='ç†æƒ³ä½“å‹'){
          idealTrial++; updateSelfPanel();
          if (idealTrial < IDEAL_TRIALS) startTrial();
          else {
            elStim().style.display='none';
            document.body.classList.remove('hide-cursor');
            showUploadingOverlay();
            try{ await uploadAllResults(); hideUploadingOverlay(); showScreen('thank'); unlockSelfPeerCard(); }
            catch(err){ hideUploadingOverlay(); console.error('Upload failed:', err); showUploadFailedOverlay((err && err.message) ? err.message : String(err)); }
          }
        }
      }, FIX_MS);
    }
  }
});
window.addEventListener('keyup',(e)=>{ const k = e.key.toLowerCase(); if (k==='f' || k==='j') stopHold(); if (k==='enter') enterLocked = false; });

/* åˆå§‹æç¤º */
preloadTip && (preloadTip.textContent = 'ç­‰å¾…é€‰æ‹©æ€§åˆ«å¼€å§‹é¢„åŠ è½½â€¦');
}
</script>
</body>
</html>
